(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var fonts=require("asapp/ui/tags-fonts");var Font=module.exports=extend(regularFont,{Load:Load,Pubsub:fonts});function regularFont(){return regularFont.apply(this,arguments)}var regularFont;function Load(params,callback){fonts.Load(params,function(err,fonts){if(err){console.log("Could not load fonts",err)}each(fonts,function(font,name){if(!Font.regular){regularFont=Font.regular=font;for(var name in font){Font[name]=font[name]}}Font[name]=font});callback()})}},{"asapp/ui/tags-fonts":31}],2:[function(require,module,exports){var chroma=require("chroma");var eventLogs=require("asapp/data/eventLogs");module.exports=GetScheme;GetScheme.ByPos=GetSchemeByPos;GetScheme.MakeFactory=function(_factoryFn){factoryFn=_factoryFn};var conversationSchemesCache={};function GetScheme(convIndexOrEventLogOrEvent){if(convIndexOrEventLogOrEvent===null){return null}var pos=eventLogs.GetEventLogPos(convIndexOrEventLogOrEvent);return GetSchemeByPos(pos)}function GetSchemeByPos(pos){if(pos==null){pos=0}if(!conversationSchemesCache[pos]){var icon=gConfig.buildPath+"/web/pages/desk/img/"+nextItem(icons);var color=nextItem(allColors[pos%bases.length]);var colors={solid:chroma(color).css(),alpha:function(num){return chroma(color).alpha(num).css()}};conversationSchemesCache[pos]=factoryFn(colors,icon)}return conversationSchemesCache[pos]}eventLogs.On("EventLogDeactivated",function(eventLog){delete conversationSchemesCache[eventLog.Position]});function nextItem(list){list._index=((list._index==null?-1:list._index)+1)%list.length;return list[list._index]}var allColors=[];var bases=["#8D48AB","#6EBAEC","#E54D42","#30AD63","#EB972A"];each(bases,function(base,i){allColors.push(map(range(5),function(i){return chroma(base).darken(i*10).css()}))});var icons=["recognize-animal-Eagle.png","recognize-animal-Owl.png","recognize-animal-Penguin.png","recognize-animal-Zebra.png","recognize-flower-Dahlia.png","recognize-flower-Dandelion.png","recognize-flower-Lotus.png","recognize-flower-Red_Rose.png","recognize-flower-Yellow_Daisy.png","recognize-instrument-Drum.png","recognize-instrument-Piano.png","recognize-instrument-Violin.png"];function nextScheme(colors,icon){return{colors:colors,slot:{background:alpha,border:"1px dashed "+solid},bubble:{background:solid,border:"1px solid transparent",color:"white"},bubblePreview:{background:"white",border:"1px dashed "+solid,color:solid},recognizeImage:{src:icon,style:{width:40,height:40,float:"left"}},desk:{slot:{background:"rgba(255,255,255,1)",borderRadius:4},recognizeImage:{src:icon,style:{width:40,height:40,float:"left"}}}}}},{"asapp/data/eventLogs":11,chroma:41}],3:[function(require,module,exports){var schemes=require("asapp/apps/schemes");var eventLogs=require("asapp/data/eventLogs");var clientState=require("asapp/data/clientState");module.exports=schemes;schemes.MakeFactory(function(colors,icon){return{colors:colors,slot:{background:"#FBFCFC",borderRadius:4},bubble:{fromRep:{color:"#616161"},fromCustomer:{color:"#616161"}},scriptSuggestion:{background:"#fff",boxShadow:"0 0 0.5px -0.5px "+colors.solid,color:"black"},bubblePreview:{background:"white",boxShadow:"0 0 0.5px -0.5px "+colors.solid,color:colors.alpha(.75)},icon:{src:icon,card:{src:icon,style:{width:32,height:32,borderRadius:32}},head:{src:icon,style:{width:44,height:44,borderRadius:44}}}}});module.exports.CurrentScheme=function(){return schemes(clientState.CurrentEventLog())}},{"asapp/apps/schemes":2,"asapp/data/clientState":9,"asapp/data/eventLogs":11}],4:[function(require,module,exports){var translations=require("asapp/apps/web-sdk-iframe/translations.json");module.exports.translate=function(string,region){if(!region){return string}var cleanString=string.toLowerCase();cleanString=cleanString.trim();if(translations[region.toLowerCase()]){return translations[region.toLowerCase()][cleanString]||string}return string}},{"asapp/apps/web-sdk-iframe/translations.json":5}],5:[function(require,module,exports){module.exports=module.exports={de:{end:"ENDE",connecting:"Wir sind gleich bei dir...","in queue":"Personen sind vor dir","additional feedback (optional)":"Zusätzliches Feedback (Optional)","press 'enter' to submit your feedback":"Drück ENTER, um dein Feedback abzuschicken.","conversation started":"Der Chat hat begonnen.","type here and hit enter to chat":"Hier Text eingeben und ENTER drücken, um den Chat zu starten.","more questions? keep typing":"Du hast eine Frage? Na dann los."},ch:{end:"ENDE",connecting:"Wir sind gleich bei dir...","in queue":"Personen sind vor dir","additional feedback (optional)":"Zusätzliches Feedback (Optional)","press 'enter' to submit your feedback":"Drück ENTER, um dein Feedback abzuschicken.","conversation started":"Der Chat hat begonnen.","type here and hit enter to chat":"Hier Text eingeben und ENTER drücken, um den Chat zu starten.","more questions? keep typing":"Du hast eine Frage? Na dann los."},at:{end:"ENDE",connecting:"Wir sind gleich bei dir...","in queue":"Personen sind vor dir","additional feedback (optional)":"Zusätzliches Feedback (Optional)","press 'enter' to submit your feedback":"Drück ENTER, um dein Feedback abzuschicken.","conversation started":"Der Chat hat begonnen.","type here and hit enter to chat":"Hier Text eingeben und ENTER drücken, um den Chat zu starten.","more questions? keep typing":"Du hast eine Frage? Na dann los."}}},{}],6:[function(require,module,exports){require("asapp/util/store/store-persist-web-sdk-dialogue");require("asapp/util/util-globals");require("asapp/data/constants");var translate=require("asapp/apps/web-sdk-iframe/translate").translate;appName=AppWebSDK;var conn=require("asapp/net/conn");var ViewportLayout=require("asapp/ui/layout/ViewportLayout");var eventLogs=require("asapp/data/eventLogs");var clientState=require("asapp/data/clientState");var conversations=require("asapp/ui/conversations2");var schemes=require("asapp/apps/schemes/webSdkSchemes");var state=require("../web-sdk/state");var parseUrl=require("asapp/util/parseUrl");var events=require("asapp/data/events");var ratings=require("asapp/ui/ratings");var Segment=require("asapp/misc/segment");var font=require("asapp/ui/tags-fonts");require("asapp/ui/conversationBubbleTail").SetType("web-sdk");Font.Load(font.RequestFontParams(),function(){var viewport=ViewportLayout({ViewportContent:function(layout){return div(Fill,{className:"disableSelect"},Pos(0,0),WebSDKDialogue())}});var $viewportEl=$(document.getElementById("Viewport")).css({position:"absolute",top:0,left:0});var $win=$(window).on("resize",resize);function resize(){$viewportEl.css({width:$win.width(),height:$win.height()})}resize();ReactDOM.render(viewport,$viewportEl[0])});conn.On("DidAuthenticate",function(authRes){gCompany=authRes.SessionInfo.Company;Conn.SetCtx({CompanyId:gCompany.CompanyId})});function getCustomerAuthToken(){var url=parseUrl(window.location);return url.getSearchParam("token")}function getOriginPath(){var url=parseUrl(window.location);return url.getSearchParam("OriginPath")}function getOriginPathFull(){var url=parseUrl(window.location);return url.getSearchParam("OriginPathFull")}function getOriginTitle(){var url=parseUrl(window.location);return url.getSearchParam("OriginTitle")}function getReferrer(){var url=parseUrl(window.location);return url.getSearchParam("Referrer")}eventLogs.SetupCustomerIssueObservation();var breathTimeout;var WebSDKDialogue=ui.View2("WebSDKDialogue",{mixins:[conn.mixins.ObserveState(function(state){if(state==="Authenticated"){this.setSDKCollectedInfo();clientState.ObserveCurrentEventLog(function(){});clientState.SetCurrentEventLog(eventLogs.GetCustomerEventLog(clientState.GetSessionInfo().Customer.CustomerId))}}),eventLogs.mixins.On("EventLogLoaded",function(eventLog){this.setState({eventLog:eventLog});if(!this.state.isChatOpen&&eventLog.IsIssueActive()){this.toggleChatDisplay()}}),eventLogs.mixins.AfterEventProcessed(function(event,eventLog,isLive){this.setState({eventLog:eventLog});if(this.state.eventLog&&this.state.eventLog.IsIssueActive()!=this.state.isIssueActive||event.EventType==EventTypeNewRep||event.EventType==EventTypeConversationRated){this.forceUpdate()}if(event.EventType==EventTypeConversationEnd||event.EventType==EventTypeNewIssue){this.setIsIssueActive(eventLog)}if(event.EventType==EventTypeIPBlock){this.removeChatDisplay()}if(event.EventType==EventTypeTextMessage&&!this.state.isChatOpen&&!clientState.GetChatMinimized(this.state.eventLog)){this.openChatDisplay()}if(event.EventType==EventTypeConversationRated&&isLive){this.setState({shouldAskForFeedback:true})}else if(event.EventType==EventTypeCustomerFeedback){this.setState({shouldAskForFeedback:false})}this.animateIfNeeded(event,isLive);this.animateBadgeIfNeeded(this.state.isChatOpen)}),ui.mixins.ObserveWindowSize(function(winSize){this.height=winSize.height;this.height=400;this.width=winSize.width;this.forceUpdate()})],componentWillMount:function(){var url=parseUrl(window.location);var regionCode=url.getSearchParam("regionCode");this.setState({regionCode:regionCode});conn.On("DidOpen",bind(this,function(){this.getCompanyWebSDKSettings(regionCode)}));conn.Connect()},componentDidMount:function(){var sessionInfo=clientState.GetSessionInfo();if(sessionInfo&&!sessionInfo.IsIssueActive){clientState.SetSessionInfo(null)}this.listenToExternalCommands()},componentWillUnmount:function(){if(this.state.eventLog&&!this.state.eventLog.IsIssueActive()){clientState.LogoutAndClearState()}},getInitialState:function(){return{isChatOpen:false}},render:function(){if(!this.state.settings){return}var titleBarHeight=40;var repRibbonHeight=50+(this.shouldDisplayFeedbackForm()?80:0);var isIssueActive=this.state.eventLog&&this.state.eventLog.IssueId;var conversationHeight=this.height-titleBarHeight;return div(FillW,H(this.height),style({textAlign:"center"}),CustomerConversation({height:conversationHeight,titleBarHeight:titleBarHeight,repRibbonHeight:repRibbonHeight,highlightColor:this.getSettingValue("secondaryColor"),welcomePrompt:this.getSettingValue("welcomePrompt"),regionCode:this.state.regionCode,regionHasLongText:this.regionHasLongText}),this.renderTitleBar(),isIssueActive?this.renderRepRibbon():null)},shouldShowCustomerEndConversation:function(){if(!this.state.eventLog)return false;if(!this.state.isChatOpen)return false;var events=this.state.eventLog.Events();for(var i=events.length-1;i>=0;i--){var ev=events[i];if(ev.EventType==EventTypePictureMessage||ev.EventType==EventTypeTextMessage){return true}else if(ev.EventType==EventTypeConversationEnd||ev.EventType==EventTypeCustomerConversationEnd){return false}}return false},renderTitleBar:function(){var directionClass=this.state.isChatOpen?"icon-minimize":"icon-expand";var showEndConversation=this.shouldShowCustomerEndConversation();return div(id("ASAPPTitleBar"),FillW,H(40),Bg(this.getSettingValue("titleBarColor")),Pos(0,0),Pad(0),style({borderTopLeftRadius:5,cursor:"pointer",borderTopRightRadius:5,position:"absolute",textAlign:"left",zIndex:2}),{onClick:this.toggleChatDisplay},div(W(320),style({position:"relative",display:"inline-block",verticalAlign:"top"}),div(style({fontSize:12,fontWeight:900,paddingLeft:15,lineHeight:"40px",letterSpacing:"2px",overflow:"visible"}),Color(this.getSettingValue("titleBarTextColor")),this.renderUnreadMessageCountBadge(),span(id("ASAPPTitleBarText"),this.getSettingValue("titleBarText"))),div(Pos.tr(7,10),span(translate("End",this.state.regionCode),Color("#FFF"),Pad(5,15),Margin(0,5),style({textTransform:"uppercase",letterSpacing:"1.5px",fontSize:"10px",fontWeight:600,border:"1px solid "+this.getSettingValue("titleBarTextColor"),borderRadius:"4px",opacity:showEndConversation?1:0,background:this.state.hoverEndButton?this.getSettingValue("titleBarTextColor"):this.getSettingValue("titleBarColor"),color:this.state.hoverEndButton?this.getSettingValue("titleBarColor"):this.getSettingValue("titleBarTextColor")}),{id:"ASAPPChatTitleBarControlsClose",onClick:bind(this,function(e){if(!showEndConversation)return;e.stopPropagation();this.endConversation();if(this.state.isChatOpen){this.toggleChatDisplay()}}),onMouseEnter:bind(this,function(){this.setState({hoverEndButton:true})}),onMouseLeave:bind(this,function(){this.setState({hoverEndButton:false})})}),span(Position("relative",1),Pad(5),Font.regular(8),style({display:"inline-block",verticalAlign:"middle",color:this.getSettingValue("titleBarTextColor")}),{id:"ASAPPChatTitleBarControlsMinimize",className:directionClass,onClick:this.toggleChatDisplay}))))},renderUnreadMessageCountBadge:function(){if(!this.state.eventLog){return}var unseenCount=this.getUnseenMessageCount();if(!unseenCount){return}var badgeHeight=20;var badgeWidth=unseenCount<10?20:25;return span(id("ASAPPTitleBarBadge"),style({opacity:0,display:"inline-block",verticalAlign:"middle",height:"40px",bottom:"1",position:"relative"}),div(Center.v(),style({position:"relative",display:"inline-block",verticalAlign:"top",overflow:"visible"}),div(id("ASAPPTitleBarBadgeBg"),Bg(this.getSettingValue("titleBarTextColor")),Color(this.getSettingValue("titleBarColor")),Font.black(12),Size(badgeWidth,badgeHeight),Radius(20)),span(Center.v(),Color("#FFF"),style({textAlign:"center",height:"15px",position:"absolute",left:"2px",right:0,lineHeight:"normal",margin:"auto"}),unseenCount<10?unseenCount:"9+")))},getUnseenMessageCount:function(){if(!this.state.eventLog){return}var unseenCount=0;var lastSeenSeq=clientState.GetLastSeenSeq();var eventList=this.state.eventLog.Events();if(!eventList.length){return}for(var i=eventList.length-1;i>=0;i--){if(eventList[i].CustomerEventLogSeq<=lastSeenSeq){break}if(events.IsFromCustomer(eventList[i])){continue}if(eventList[i].EventType!=EventTypeTextMessage&&eventList[i].EventType!=EventTypePictureMessage){continue}unseenCount++}return unseenCount},animateIfNeeded:function(event,isLive){if(this.state.isChatOpen){return}if(!isLive){return}if(events.IsFromCustomer(event)){return}if(event.EventType!=EventTypeTextMessage&&event.EventType!=EventTypePictureMessage){return}this.pulseAnimation(0)},pulseAnimation:function(step){$("#ASAPPTitleBar").animate({backgroundColor:step%2?this.getSettingValue("titleBarColor"):"#FFFFFF"},400,bind(this,function(){if(step<3){this.pulseAnimation(++step)}else{this.breathAnimation()}}))},breathAnimation:function(){if(breathTimeout){window.clearTimeout(breathTimeout)}var animationTime=750;var animationRepeats=3;var buffer=100;$("#ASAPPTitleBarBadgeBg").addClass("breath");breathTimeout=window.setTimeout(function(){$("#ASAPPTitleBarBadgeBg").removeClass("breath");breathTimeout=0},animationTime*animationRepeats+buffer)},animateBadgeIfNeeded:function(isChatOpen){$("#ASAPPTitleBarText").finish();$("#ASAPPTitleBarBadge").finish();var unseenCount=this.getUnseenMessageCount();if(!isChatOpen){if(!unseenCount||breathTimeout){return}$("#ASAPPTitleBarText").animate({paddingLeft:10},200);var badgeWidth=unseenCount<10?20:25;$("#ASAPPTitleBarBadge").animate({width:badgeWidth},300,function(){$("#ASAPPTitleBarBadge").animate({opacity:1},200)})}else{$("#ASAPPTitleBarBadge").animate({opacity:0},200,function(){$("#ASAPPTitleBarBadge").animate({width:0},300);$("#ASAPPTitleBarText").animate({paddingLeft:0},200)})}},regionHasLongText:function(region){if(region==="DE"||region==="AT"||region==="CH"){return true}return false},renderRepRibbon:function(){var thumbRating=this.state.eventLog.GetLatestRatingForCurrentIssue().ThumbRating;var assignedRep=this.state.eventLog.GetAssignedRep();var connectingTranslated=translate("Connecting",this.state.regionCode);return div(FillW,H(50),Pos(40,0),Bg("#F5F5F5"),Color("#616161"),Font.regular(16),div(style({textAlign:"left",marginLeft:15,lineHeight:"48px"}),assignedRep?assignedRep.Name:[connectingTranslated,this.renderPositionInQueue()],this.state.eventLog.RepIsTyping?span(Font.regular(11)," (typing ...)"):null),div(Pos.tr(16,15),ratings({type:"thumbs",scale:1,color:"#616161",colorHover:this.getSettingValue("secondaryColor")})),this.shouldDisplayFeedbackForm()?this.renderOptionalFeedback():null)},renderPositionInQueue:function(){if(this.state.positionInQueue){if(this.regionHasLongText(this.state.regionCode)){return div(Font.bold(12),Color("#A6A6A6"),Margin(0,0,5,0),style({lineHeight:"12px"})," ("+this.state.positionInQueue+" "+translate(" in queue",this.state.regionCode)+")")}else{return span(Font.bold(12),Color("#A6A6A6")," ("+this.state.positionInQueue+" in queue)")}}return null},renderOptionalFeedback:function(){return div(Bg("#F5F5F5"),H(80),style({position:"relative"}),form(style({textAlign:"center"}),OnSubmit(bind(this,function(e){e.preventDefault();this.sendFeedback()})),textarea(id("FeedbackInput"),H(30),Pad(5,20,5,5),W(267),{placeholder:translate("Additional Feedback (Optional)",this.state.regionCode)},Border("none"),Radius(3),Margin(0,14,0,14),Font.regular(12),style({resize:"none",border:"1px solid #E7E8E8"}),Bg("white"),style({outline:"none"}),OnKey(bind(this,this.onKeyInput))),div(Margin(10,50,0,50),Font.bold(9),Color("#B4B4B4"),translate("PRESS 'ENTER' TO SUBMIT YOUR FEEDBACK",this.state.regionCode)),div(Pos.tr(0,20),img({src:"/current-web/web/deps/res/images/close_btn.png"},tappable(bind(this,function(){this.setState({shouldAskForFeedback:false})}))))))},setIsIssueActive:function(eventLog){var sessionInfo=clientState.GetSessionInfo();if(!sessionInfo||!eventLog){return}sessionInfo.IsIssueActive=eventLog.IsIssueActive();clientState.SetSessionInfo(sessionInfo)},shouldDisplayFeedbackForm:function(){return this.state.eventLog&&(this.isNegativeRating()||this.isPositiveRating())&&!this.state.eventLog.DidProvideFeedbackAfterRating()&&this.state.shouldAskForFeedback},isNegativeRating:function(){var thumbRating=this.state.eventLog.GetLatestRatingForCurrentIssue().ThumbRating;return thumbRating==ThumbRatingDown},isPositiveRating:function(){var thumbRating=this.state.eventLog.GetLatestRatingForCurrentIssue().ThumbRating;return thumbRating==ThumbRatingUp},initChatDisplay:function(){window.parent.postMessage("ASAPPChatInit",getOriginPath());Segment.track("Chat Box Appears")},openChatDisplay:function(){window.parent.postMessage("ASAPPChatDisplay"+true,getOriginPath());this.setState({isChatOpen:true})},toggleChatDisplay:function(){window.parent.postMessage("ASAPPChatDisplay"+!this.state.isChatOpen,getOriginPath());var openChat=!this.state.isChatOpen;this.setState({isChatOpen:!this.state.isChatOpen});if(openChat){document.getElementById("TextMessageInput").focus();clientState.SetChatMinimized(this.state.eventLog,false)}else{clientState.SetChatMinimized(this.state.eventLog,true)}Segment.track(this.state.isChatOpen?"User Initiated Minimize Chat Window":"User Initiated Maximize Chat Window");this.updateLastSeenIfNeeded();this.animateBadgeIfNeeded(openChat)},updateLastSeenIfNeeded:function(){if(!this.state.isChatOpen){return}if(!this.state.eventLog){return}var eventList=this.state.eventLog.Events();clientState.SetLastSeenSeq(eventList[eventList.length-1].CustomerEventLogSeq)},removeChatDisplay:function(){window.parent.postMessage("ASAPPChatRemove",getOriginPath());Segment.track("User Initiated Close Chat Window")},getCompanyWebSDKSettings:function(regionCode){var params={CompanyMarker:gGetCompanyMarker(),RegionCode:regionCode};Conn.Request("webSDK/GetWebSDKSettings",params,bind(this,function(res){this.setState({settings:res.WebSDKSettings.CompanyWebSDKSettings});if(res.WebSDKSettings.DisplayCustomerSupport){this.initChatDisplay()}else{$("#Viewport").remove()}}))},onKeyInput:function($e){if(KeyCodes.IsEnterKeyEvent($e)){this.sendFeedback();$e.preventDefault();return}},sendFeedback:function(){var feedbackText=this.getFeedbackText().replace(/ /g," ");if(!feedbackText){return}var params={Comment:feedbackText};Conn.Request("customer/SendFeedback",params,bind(this,function(){Segment.track("Submit Feedback - Written Feedback",{conversation_id:this.state.eventLog.IssueId,feedback_type:this.isNegativeRating()?"Thumbs Down":"Thumbs Up"})}))},getFeedbackText:function(){var input=$("#FeedbackInput")[0];return input?input.value:""},setSDKCollectedInfo:function(){var params={SDKLocation:getOriginPathFull(),SDKLocationTitle:getOriginTitle()};var referrer=getReferrer();params.Referrer=decodeURIComponent(referrer);Conn.Request("customer/SetSDKCollectedInfo",params,function(){})},getPositionInQueue:function(){if(!this.state.eventLog){return}if(!this.state.eventLog.IssueId){return}if(this.state.eventLog.GetAssignedRep()){return}Conn.Request("customer/GetPositionInQueue",{},bind(this,function(res){this.setState({positionInQueue:res.Position})}))},getSettingValue:function(name){var value;var settings=this.state.settings;each(settings,bind(this,function(setting){if(setting.Name==name){value=JSON.parse(setting.ValueJSON).value;return}}));return value},listenToExternalCommands:function(){window.addEventListener("message",bind(this,function(e){if(e.origin.indexOf(getOriginPath())<0){return}if(e.data=="ASAPPChatDisplaytrue"){this.setState({isChatOpen:true})}}))},endConversation:function($e){Conn.Request("customer/EndConversation",{},function(){})}});var CustomerConversation=ui.ViewComponent("ConversationView",{mixins:[eventLogs.mixins.BeforeProcessEvent(function(event){if(eventLogs.GetEventLogForEvent(event)!=clientState.CurrentEventLog()){return}if(this.isNearBottom()){this.scrollToBottom();var signal=events.IsEphemeral(event)?"EphemeralEventProcessed":"EventProcessed";eventLogs.Once(signal,bind(this,this.scrollToBottom))}if(event.EventType==EventTypeTextMessage||event.EventType==EventTypePictureMessage){if(events.IsFromCustomer(event)){this.sendChatStartedTrackEventIfNeeded(event)}else{this.sendNonCustomerTrackEventIfNeeded(event)}}else if(event.EventType==EventTypeNewRep){this.sendNonCustomerTrackEventIfNeeded(event)}}),eventLogs.mixins.AfterEventProcessed(function(event,eventLog){this.setState({eventLog:eventLog});async(bind(this,this.scrollToBottom))})],getInitialState:function(){var companyId;if(clientState.GetSessionInfo()&&clientState.GetCompanyInfo()){companyId=clientState.GetCompanyInfo().CompanyId}return{inputHeight:this.baseInputHeight(),pendingAuthTimestamp:null,companyId:companyId}},componentDidMount:function(){this.addDropListener()},render:function(){var inputHeight=this.state.inputHeight;var isIssueActive=this.state.eventLog&&this.state.eventLog.IssueId;var conversationHeight=this.props.height-inputHeight-(isIssueActive?this.props.repRibbonHeight:0);var shouldAskForFeedback=this.state.eventLog&&this.state.eventLog.ShouldAskForFeedback();var showWelcomePrompt=!this.state.eventLog||!this.state.eventLog.HasMessageEvent();return div(id("ConversationHolder"),H(conversationHeight+inputHeight),W(318),Pad(isIssueActive?this.props.repRibbonHeight:0,0,0,0),Bg("white"),style({marginTop:this.props.titleBarHeight,display:"inline-block",borderLeft:"1px solid #F2F2F2",borderRight:"1px solid #F2F2F2"}),div(H(conversationHeight),id("ConversationView"),{onScroll:bind(this,function(){this.forceUpdate()})},Scrollable.Y,Bg("#FFFFFF"),style({textAlign:"left"}),showWelcomePrompt?this.renderWelcomePrompt():this.renderConversation()),this.renderInput(shouldAskForFeedback),this.renderEmailTranscriptForm())},baseInputHeight:function(){return this.props.regionHasLongText(this.props.regionCode)?80:60},shouldShowConnecting:function(){var threshold=100;var pendingAuthTimestamp=this.state.pendingAuthTimestamp;var now=(new Date).getTime();if(!pendingAuthTimestamp||now-pendingAuthTimestamp<threshold){return false}return pendingAuthTimestamp},renderWelcomePrompt:function(){var text=this.shouldShowConnecting()?translate("Connecting",this.props.regionCode):this.props.welcomePrompt;if(!text)return;return div(FillW,style({textAlign:"center"}),div(Pad(40),div(conversations.Font,Color(rgb(97,97,97)),Radius(5),Pad(20),Bg("#F9F9F9"),text)))},renderEmailTranscriptForm:function(){if(!this.state.showEmailTranscriptForm){return}return div(Pos(10,1),W(318),FillH,Bg("rgba(0,0,0,0.6)"),div(W(240),Pos(150,30),style({borderRadius:5}),Bg("white"),Pad(10),input(Pad(5),W(220),Font.regular(12),style({borderRadius:5,border:this.isValidEmail(this.state.transcriptEmail)?"1px solid green":"1px solid red"}),{type:"text",placeholder:"Email Address",value:this.state.transcriptEmail,onChange:bind(this,function($e){this.setState({transcriptEmail:$e.target.value})})}),div(Font.regular(12),Pad(5),Color(this.props.highlightColor),style({textAlign:"right"}),span("CANCEL",Margin(0,10,0,0),Color("#616161"),tappable(bind(this,function(){this.setState({showEmailTranscriptForm:false})}))),span("SEND",Color(this.props.highlightColor),tappable(bind(this,function(){this.sendEmailTranscript()}))))))},isValidEmail:function(emailAddress){if(!emailAddress){return false}var atPos=emailAddress.indexOf("@");var dotPos=emailAddress.lastIndexOf(".");if(atPos<1||dotPos<atPos+2||dotPos+2>=emailAddress.length){return false}return true},sendEmailTranscript:function(){if(!this.state.eventLog){return}var params={Transcript:eventLogs.FormatIssueTranscript(this.state.eventLog.GetIssueTranscript()),EmailAddress:this.state.transcriptEmail};Conn.Request("customer/EmailTranscript",params,bind(this,function(res){this.setState({transcripEmail:null,showEmailTranscriptForm:false})}))},renderConversation:function(){return div(conversations.RenderEventLog(this.state.eventLog,{highlightColor:this.props.highlightColor,regionCode:this.props.regionCode}))},renderInput:function(shouldAskForFeedback){var pad=10;var inputW=290-pad*2;var inputHeight=this.state.inputHeight;var placeholder=this.shouldShowConnecting()?translate("Connecting",this.props.regionCode):translate("Type here and hit enter to chat",this.props.regionCode);return div(H(inputHeight),Bg("#F5F5F5"),style({position:"relative"}),form(style({textAlign:"center"}),OnSubmit(bind(this,function(e){e.preventDefault();this.sendTextMessage()})),textarea(id("TextMessageInput"),H(inputHeight-20-pad*2),Pad(pad),W(inputW),{placeholder:placeholder,disabled:this.state.pendingAuthTimestamp?true:false},Border("none"),Radius(6),Margin(9,14,9,14),Font.regular(16),style({resize:"none",border:"1px solid #E7E8E8"}),Bg("white"),style({outline:"none"}),OnKey(bind(this,this.onKeyInput)),OnFocus(bind(this,this.gotFocus)),OnBlur(bind(this,this.lostFocus)))))},gotFocus:function(){window.parent.postMessage("ASAPPGotInputFocus",getOriginPath())},lostFocus:function(){window.parent.postMessage("ASAPPGotInputBlur",getOriginPath())},addDropListener:function(){document.getElementById("ConversationHolder").addEventListener("dragover",bind(this,function(e){e.stopPropagation();e.preventDefault();e.dataTransfer.dropEffect="copy"}),false);document.getElementById("ConversationHolder").addEventListener("drop",bind(this,function(e){e.stopPropagation();e.preventDefault();this.uploadImage(e.dataTransfer.files[0])}),false)},uploadImage:function(image){if(!image){return}if(!image.name.match(/\.(jpg|jpeg|png|gif)$/)){alert("Only images allowed");return}var params={FileSize:image.size,MimeType:image.type};var imageReader=new FileReader;var img=new Image;img.src=window.URL.createObjectURL(image);img.onload=function(){params.PicWidth=img.naturalWidth;params.PicHeight=img.naturalHeight;window.URL.revokeObjectURL(img.src);imageReader.readAsArrayBuffer(image)};imageReader.onload=bind(this,function(){var imageData=imageReader.result;if(!clientState.GetSessionInfo()){this.createCustomer(bind(this,function(){Conn.Request("customer/SendPictureMessage",params);Conn.SendData(imageData)}))}else{Conn.Request("customer/SendPictureMessage",params);Conn.SendData(imageData)}})},onKeyInput:function($e){if(KeyCodes.IsEnterKeyEvent($e)){this.sendTextMessage();$e.preventDefault();return}async(bind(this,this.handleInputChange))},handleInputChange:function(){if(this.state.inputHeight>this.baseInputHeight()){return}var sHeight=$("#TextMessageInput")[0].scrollHeight;var baseSHeight=this.props.regionHasLongText(this.props.regionCode)?60:40;if(sHeight>baseSHeight){this.setState({inputHeight:100})}this.notifyTypingPreview()},isNearBottom:function(){var body=$("#ConversationView")[0];return body&&body.scrollHeight-(body.offsetHeight+body.scrollTop)<54},scrollToBottom:function(){$("#ConversationView").scrollTop(9999999)},notifyTypingPreview:_.throttle(function(){if(!clientState.GetSessionInfo())return;var messageText=this.getInputText().replace(/ /g," ");var params={Text:messageText};Conn.Request("customer/NotifyTypingPreview",params,null)},200),sendTextMessage:function(){var messageText=this.getInputText().replace(/ /g," ").trim();if(!messageText){return}var params={Text:messageText,TextMessageMetaData:null};this.setInputText("");this.notifyTypingPreview();if(!clientState.GetSessionInfo()){this.createCustomer(bind(this,function(){this.doSendTextMessage(params,true)}))}else{var shouldSendChatStartEvent=false;if(this.state.eventLog&&!this.state.eventLog.IsIssueActive()){shouldSendChatStartEvent=true}this.doSendTextMessage(params,shouldSendChatStartEvent)}},createCustomer:function(callback){this.setState({pendingAuthTimestamp:(new Date).getTime()});var pollConnecting=window.setInterval(bind(this,function(){if(this.shouldShowConnecting()){this.forceUpdate();window.clearInterval(pollConnecting)}}),50);this.createAnonymousCustomerAccount(bind(this,function(){window.clearInterval(pollConnecting);this.setState({pendingAuthTimestamp:null});callback()}))},createAnonymousCustomerAccount:function(callback){var params={CompanyMarker:gGetCompanyMarker(),RegionCode:this.props.regionCode};Conn.Authenticate("auth/CreateAnonCustomerAccount",params,function(){return true},callback)},doSendTextMessage:function(params,shouldSendChatStartEvent){if(shouldSendChatStartEvent){this.setState({shouldSendChatStartEvent:shouldSendChatStartEvent})}Conn.Request("customer/SendTextMessage",params,bind(this,function(){if(!this.state.eventLog){return}Segment.track("Live Chat Message Sent",{conversation_id:this.state.eventLog.IssueId})}))},sendChatStartedTrackEventIfNeeded:function(event){if(this.state.shouldSendChatStartEvent){Segment.track("Live Chat Conversation Started",{conversation_id:event.IssueId,chat_initiator:"Customer",timestamp:Math.floor(event.EventTime/1e3)});this.setState({shouldSendChatStartEvent:false})}},sendNonCustomerTrackEventIfNeeded:function(event){var lastTrackEventSeq=clientState.GetLastEventSeqSentToSegmentTrack();if(!lastTrackEventSeq||lastTrackEventSeq<event.CustomerEventLogSeq){clientState.SetLastEventSeqSentToSegmentTrack(event);var assignedRep=this.state.eventLog?this.state.eventLog.GetAssignedRep():null;var crmId="NA";if(assignedRep){}var analyticsEventType="Live Chat Message Received";if(event.EventType==EventTypeNewRep){analyticsEventType="Agent Joined Live Chat"}Segment.track(analyticsEventType,{conversation_id:event.IssueId,agent_id:event.RepId,timestamp:Math.floor(event.EventTime/1e3)})}},getInputText:function(){var input=$("#TextMessageInput")[0];return input?input.value:""},setInputText:function(text){if(!$("#TextMessageInput")[0]){return}$("#TextMessageInput")[0].value=text;this.setState({inputHeight:this.baseInputHeight()})}})},{"../web-sdk/state":8,"asapp/apps/schemes/webSdkSchemes":3,"asapp/apps/web-sdk-iframe/translate":4,"asapp/data/clientState":9,"asapp/data/constants":10,"asapp/data/eventLogs":11,"asapp/data/events":12,"asapp/misc/segment":14,"asapp/net/conn":15,"asapp/ui/conversationBubbleTail":20,"asapp/ui/conversations2":21,"asapp/ui/layout/ViewportLayout":26,"asapp/ui/ratings":29,"asapp/ui/tags-fonts":31,"asapp/util/parseUrl":35,"asapp/util/store/store-persist-web-sdk-dialogue":38,"asapp/util/util-globals":39}],7:[function(require,module,exports){var slice=require("std/slice");
var extend=require("std/extend");var hostname=window.location.hostname;var enabled=hostname=="localhost"||hostname=="127.0.0.1";module.exports=extend(function log(){_doLog(console.log,arguments)},{Enable:function(){enabled=true},Error:function(){_doLog(console.error,arguments,true)}});function _doLog(consoleFn,fnArguments,force){if(!enabled&&!force){return}var args=["ASAPP:"].concat(slice(fnArguments));consoleFn.apply(console,args)}},{"std/extend":46,"std/slice":56}],8:[function(require,module,exports){var log=require("./log");module.exports={SetCompanyMarker:SetCompanyMarker,GetCompanyMarker:GetCompanyMarker,SetCustomerAuthToken:SetCustomerAuthToken,GetCustomerAuthToken:GetCustomerAuthToken,SetRegionCode:SetRegionCode,GetRegionCode:GetRegionCode};var _companyMarker;function SetCompanyMarker(companyMarker){log("SetCompanyMarker",companyMarker);_companyMarker=companyMarker}function GetCompanyMarker(){return _companyMarker}var _customerAuthToken;function SetCustomerAuthToken(customerAuthToken){log("SetCustomerAuthToken",customerAuthToken);_customerAuthToken=customerAuthToken}function GetCustomerAuthToken(){if(!_customerAuthToken){return""}return _customerAuthToken}var _regionCode;function SetRegionCode(regionCode){log("SetRegionCode",regionCode);_regionCode=regionCode}function GetRegionCode(){if(!_regionCode){return""}return _regionCode}},{"./log":7}],9:[function(require,module,exports){require("asapp/data/time");var buildPath=gConfig.buildPath;var stores=require("asapp/util/store");var store=require("asapp/util/store").New({PersistWithName:"clientState-"+buildPath});var sessionInfoStore=require("asapp/util/store").New({PersistWithName:"sessionInfoStore"});var companyInfoStore=require("asapp/util/store").New({PersistWithName:"companyInfoStore"});clientState=module.exports={GetSessionInfo:GetSessionInfo,SetSessionInfo:SetSessionInfo,NextReqId:NextReqId,GetCompanyInfo:GetCompanyInfo,SetConversationCount:SetConversationCount,ChangeConversationCount:ChangeConversationCount,ObserveConversationCount:ObserveConversationCount,GetConversationCount:GetConversationCount,GetMaxConversationCount:GetMaxConversationCount,SetTransferRequest:SetTransferRequest,AddTransferRequest:AddTransferRequest,AcceptTransferRequest:AcceptTransferRequest,IgnoreTransferRequest:IgnoreTransferRequest,RemoveTransferRequest:RemoveTransferRequest,ObserveTransferRequests:ObserveTransferRequests,GetTransferRequests:GetTransferRequests,GetTransferRequestForIssue:GetTransferRequestForIssue,HasOutgoingTransferRequest:HasOutgoingTransferRequest,SetCurrentEventLog:SetCurrentEventLog,CurrentIssueId:CurrentIssueId,CurrentCustomerId:CurrentCustomerId,CurrentPosition:CurrentPosition,CurrentEventLog:CurrentEventLog,ObserveCurrentEventLog:ObserveCurrentEventLog,ObserveCurrentIssueId:ObserveCurrentIssueId,SetFlags:SetFlags,SetFlag:SetFlag,GetFlag:GetFlag,ToggleFlag:ToggleFlag,mixins:{ObserveCurrentEventLog:ObserveCurrentEventLogMixin,ObserveConversationCount:ObserveConversationCountMixin,ObserveSessionInfo:ObserveSessionInfoMixin,ObserveTransferRequests:ObserveTransferRequestsMixin,ObserveFlags:ObserveFlagsMixin},GetMessageDraft:GetMessageDraft,SetMessageDraft:SetMessageDraft,GetLastEventSeqSentToSegmentTrack:GetLastEventSeqSentToSegmentTrack,SetLastEventSeqSentToSegmentTrack:SetLastEventSeqSentToSegmentTrack,AddActivityLog:AddActivityLog,GetActivityLog:GetActivityLog,LogoutAndClearState:LogoutAndClearState,GetChatMinimized:GetChatMinimized,SetChatMinimized:SetChatMinimized,GetLastSeenSeq:GetLastSeenSeq,SetLastSeenSeq:SetLastSeenSeq,IsIssueActive:IsIssueActive};(function checkBuildVersion(){var lastBuildPath=sessionInfoStore.Get("lastBuildPath");sessionInfoStore.Set("lastBuildPath",buildPath);if(lastBuildPath&&lastBuildPath!=buildPath){var sessionInfo=sessionInfoStore.Get("sessionInfo");stores.ClearAll();sessionInfoStore.Set("sessionInfo",sessionInfo);window.location.reload();return}clientState.SetCurrentEventLog(null)})();store.SetDefaultValue("flags",{});function SetFlags(flags){var newFlags=extend(store.Get("flags")||{},flags);store.Set("flags",newFlags)}function SetFlag(flagName,flagValue){var flags=store.Get("flags");flags[flagName]=flagValue;store.Set("flags",flags)}function GetFlag(flagName){return store.Get("flags")[flagName]}function ToggleFlag(flagName){var flags=store.Get("flags");flags[flagName]=!flags[flagName];store.Set("flags",flags)}function ObserveFlagsMixin(callback){var obsId=null;return{componentWillMount:function(){obsId=store.Observe("flags",bind(this,callback))},componentWillUnmount:function(){store.Off(obsId)}}}function GetCompanyInfo(){return GetSessionInfo().Company}function GetSessionInfo(){return sessionInfoStore.Get("sessionInfo")}function SetSessionInfo(sessionInfo){sessionInfoStore.Set("sessionInfo",sessionInfo)}function ObserveSessionInfoMixin(callback){return{componentWillMount:function(){this._sessionInfoObsId=sessionInfoStore.Observe("sessionInfo",bind(this,callback))},componentWillUnmount:function(){sessionInfoStore.Off(this._sessionInfoObsId)}}}function LogoutAndClearState(){Conn.Request("rep/Logout",null,function(res){stores.ClearAll();window.location.hash="#";window.location.reload()})}function GetMessageDraft(eventLog){if(!eventLog){return}return store.Get("messageDraft-"+eventLog.CustomerId)||{text:"",start:0,end:0}}function SetMessageDraft(eventLog,draft){if(!eventLog){return}return store.Set("messageDraft-"+eventLog.CustomerId,draft)}function GetLastEventSeqSentToSegmentTrack(){return store.Get("lastSegmentTrackEventSeq")}function SetLastEventSeqSentToSegmentTrack(event){return store.Set("lastSegmentTrackEventSeq",event.CustomerEventLogSeq)}function AddActivityLog(activityText,isError){var activityLog=GetActivityLog();if(!activityLog){activityLog={activities:[],errorCount:0}}var activity={Text:activityText,IsError:isError};activityLog.activities.push(activity);if(isError){activityLog.errorCount++}return store.Set("activityLog",activityLog)}function GetActivityLog(){return store.Get("activityLog")}function NextReqId(){var newReqId=(store.Get("reqId")||0)+1;store.Set("reqId",newReqId);return newReqId}function SetCurrentEventLog(eventLog){var info=eventLog?{IssueId:eventLog.IssueId,CustomerId:eventLog.CustomerId,Position:eventLog.Position}:null;store.Set("currentEventLogInfo",info)}function CurrentIssueId(){return(store.Get("currentEventLogInfo")||{}).IssueId}function CurrentCustomerId(){return(store.Get("currentEventLogInfo")||{}).CustomerId}function CurrentPosition(){return(store.Get("currentEventLogInfo")||{}).Position}function CurrentEventLog(){var info=store.Get("currentEventLogInfo");if(!info){return null}return eventLogs.GetEventLog(info.CustomerId,info.IssueId)}function ObserveCurrentEventLog(callback){return store.Observe("currentEventLogInfo",function(info){callback(CurrentEventLog())})}function ObserveCurrentIssueId(callback){return store.Observe("currentEventLogInfo",function(info){callback((info||{}).IssueId)})}function ObserveCurrentEventLogMixin(callback){return{componentWillMount:function(){this._obsCurrIssIdSubId=ObserveCurrentEventLog(bind(this,callback))},componentWillUnmount:function(){store.Off(this._obsCurrIssIdSubId)}}}function GetChatMinimized(eventLog){if(!eventLog){return false}return store.Get("chatMinimized-"+eventLog.CustomerId)}function SetChatMinimized(eventLog,isMinimized){if(!eventLog){return}return store.Set("chatMinimized-"+eventLog.CustomerId,isMinimized)}function GetLastSeenSeq(){return store.Get("webSDKLastSeenSeq")}function SetLastSeenSeq(lastSeenSeq){return store.Set("webSDKLastSeenSeq",lastSeenSeq)}store.SetDefaultValue("transferRequest",null);function SetTransferRequest(request){store.Set("transferRequest",request)}function AddTransferRequest(request){var currentRequests=GetTransferRequests();if(!currentRequests){currentRequests=[]}request.Expiration=time.Now()+60*time.Minutes;currentRequests.push(request);store.Set("transferRequest",currentRequests)}function RemoveTransferRequest(issueId){var requests=GetTransferRequests();for(var position in requests){var request=requests[position];if(request.IssueId==issueId){requests.splice(position,1)}}SetTransferRequest(requests)}function AcceptTransferRequest(request){var params={IssueId:request.IssueId,CompanyGroupId:request.CompanyGroupId,FromRepId:request.FromRepId};Conn.Request("rep/AcceptTransferRequest",params,bind(this,function(){clientState.RemoveTransferRequest(request.IssueId)}))}function IgnoreTransferRequest(request){var params={IssueId:request.IssueId,RepId:request.FromRepId};Conn.Request("rep/CancelTransferRequest",params,bind(this,function(){clientState.RemoveTransferRequest(request.IssueId)}))}function GetTransferRequests(){return store.Get("transferRequest")}function GetTransferRequestForIssue(issueId){var currentRequests=GetTransferRequests();for(var position in currentRequests){var request=currentRequests[position];if(request.IssueId==issueId){return request}}return null}function HasOutgoingTransferRequest(issueId){var request=GetTransferRequestForIssue(issueId);if(request&&request.IsOutgoing){return true}return false}function ObserveTransferRequests(callback){return store.Observe("transferRequest",function(request){callback(request)})}function ObserveTransferRequestsMixin(callback){return{componentWillMount:function(){this._obsTransReqSubId=ObserveTransferRequests(bind(this,callback))},componentWillUnmount:function(){store.Off(this._obsTransReqSubId)}}}var maxConversationCount=7;store.SetDefaultValue("conversationCount",5);function GetMaxConversationCount(){return maxConversationCount}function SetConversationCount(amount){var newAmount=clip(amount,0,maxConversationCount);store.Set("conversationCount",newAmount)}function ChangeConversationCount(delta){var newAmount=clip(store.Get("conversationCount")+delta,0,maxConversationCount);store.Set("conversationCount",newAmount);Conn.Request("rep/UpdateMaxSlot",{maxSlot:newAmount})}function ObserveConversationCount(callback){return store.Observe("conversationCount",function(count){callback(count)})}function GetConversationCount(){return store.Get("conversationCount")}function ObserveConversationCountMixin(callback){return{componentWillMount:function(){this._obsConvCountSubId=ObserveConversationCount(bind(this,callback))},componentWillUnmount:function(){store.Off(this._obsConvCountSubId)}}}function IsIssueActive(){var sessionInfo=GetSessionInfo();return sessionInfo&&sessionInfo.IsIssueActive}},{"asapp/data/time":13,"asapp/util/store":37}],10:[function(require,module,exports){{AgentTypeRep=1;AgentTypeCustomer=2;AgentTypeSuperUser=3}{CustomerStateActive=1;CustomerStateTimedOut=2}{IssueQueueTypeInbox=1;IssueQueueTypeRepTimedOut=2;IssueQueueTypeCustomerActivated=3}{EventTypeTextMessage=1;EventTypeNewIssue=2;EventTypeNewRep=3;EventTypeConversationEnd=4;EventTypePictureMessage=5;EventTypePrivateNote=6;EventTypeTopicChange=7;EventTypeIssueEnqueued=8;EventTypeConversationRated=9;EventTypeCustomerTimedOut=10;EventTypeCRMCustomerLinked=11;EventTypeIssueSummarized=12;EventTypeTextAnnotation=13;EventTypeCustomerPrompt=14;EventTypeCustomerConversationEnd=15;EventTypeIssueAnnotation=16;EventTypeWhisperMessage=17;EventTypeCustomerFeedback=18;EventTypeIPBlock=20;EventTypePhoneNumberBlock=21}{CompanyStatusEventTypeCountsChanged=1;CompanyStatusEventTypeRating=2;CompanyStatusEventTypeFeedback=3}{EphemeralTypeTypingStatus=1;EphemeralTypeTypingPreview=2;EphemeralTypeCustomerCRMInfo=3;EphemeralTypeUpdateCustomerIdentifiers=4;EphemeralTypeConnectionUpdate=5}{EventFlagNone=0;EventFlagFromCustomer=1<<0;EventFlagFromRep=1<<1;EventFlagAutoGenerated=1<<2;EventFlagPrivate=1<<3;EventFlagTraining=1<<4}{EventFlagsNone=EventFlagNone;EventFlagsPrivate=EventFlagPrivate;EventFlagsFromCustomer=EventFlagFromCustomer;EventFlagsFromRepresentative=EventFlagFromRep;EventFlagsAutoGenerated=EventFlagAutoGenerated;EventFlagsRepTraining=EventFlagTraining|EventFlagsFromRepresentative|EventFlagsPrivate}{ThumbRatingNone=0;ThumbRatingUp=1;ThumbRatingDown=2}{SessionActivityTypeCollectedInfo=1}{PlatformTypeSMS=1;PlatformTypeSDK=2}{AppDesk="desk2";AppAdmin="admin2";AppWebSDK="web-sdk-iframe";AppInternal="internal"}{SortDirAsc=1;SortDirDesc=2}{CharacterColumn=1;NumericColumn=2;DateColumn=3}{FilterEquality=1;FilterPattern=2;FilterGreaterThan=3;FilterLessThan=4}{FeatureRegions=1;FeatureAutocomplete=2}{SUNDAY=0;MONDAY=1;TUESDAY=2;WEDNESDAY=3;THURSDAY=4;FRIDAY=5;SATURDAY=6;DaysOfWeek={0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"}}{RegionCodes={1:"US",2:"DE",3:"GB",4:"AT",5:"CH"}}{IssueStatusQueued=1;IssueStatusAssigned=2;IssueStatusEnded=3;IssueStatusCustomerTimedOut=4;IssueStatusStrings={1:"Queued",2:"Active",3:"Issue Closed",4:"Customer Timed Out",5:"New Issue"}}},{}],11:[function(require,module,exports){var conn=require("asapp/net/conn");var events=require("asapp/data/events");var pubsub=require("asapp/util/pubsub").New();var stores=require("asapp/util/store");var store=stores.New();var clientState=require("asapp/data/clientState");eventLogs=module.exports=extend(pubsub,{FilterAll:FilterAll,IssueCustomer:IssueCustomer,Rep:Rep,GetEventLogPos:GetEventLogPos,GetEventLogForEvent:GetEventLogForEvent,ByIssueId:ByIssueId,GetEventLog:GetEventLog,GetCustomerEventLog:GetCustomerEventLog,SetupActiveIssueObservation:SetupActiveIssueObservation,SetupCustomerIssueObservation:SetupCustomerIssueObservation,GetTotalMessagesWaitingCount:GetTotalMessagesWaitingCount,Count:Count,New:NewEventLog,Clear:Clear,IsEventUid:IsEventUid,GetEventByEventUid:GetEventByEventUid,FormatIssueTranscript:FormatIssueTranscript,mixins:{ObserveIssuesLoaded:ObserveIssuesLoadedMixin,BeforeProcessEvent:BeforeProcessEventMixin,AfterEventProcessed:AfterEventProcessedMixin,AfterCurrentEventLogEventProcessed:AfterCurrentEventLogEventProcessedMixins,IssueEventLog:IssueEventLogMixin,ObserveActiveEventLogs:ObserveActiveEventLogsMixin,UpdateWithCurrentCustomerEvents:UpdateWithCurrentCustomerEventsMixin,On:OnMixin},getEventLogBase:function(){return eventLogBase}});var eventElRegepx=/^event-\d+-\d+-\d+$/;function IsEventUid(str){return eventElRegepx.test(str)}function getEventUid(event){return["event",event.CustomerId,event.RepId,event.CompanyEventLogSeq||event.CustomerEventLogSeq].join("-")}function GetEventByEventUid(eventUid){if(!IsEventUid(eventUid)){return null}var evPart=eventUid.split("-");if(evPart[0]!="event"){return}var customerId=Number(evPart[1]);var repId=Number(evPart[2]);var eventLogSeq=Number(evPart[3]);return eventLogs.GetEventLog(customerId).GetEventBySeq(eventLogSeq)}var eventProcessingCallbacks=[];function SetupEventProcessing(callback){eventProcessingCallbacks.push(callback)}function ObserveIssuesLoadedMixin(callback){return{componentWillMount:function(){this._issuesLoadedObsId=store.Observe("issuesLoaded",bind(this,callback))},componentWillUnmount:function(){store.Off(this._issuesLoadedObsId)}}}function Count(){var res=0;each(eventLogsByIssueId,function(eventLog){if(eventLog&&eventLog.Active){res+=1}});return res}function GetTotalMessagesWaitingCount(){var count=0;each(eventLogsByIssueId,function(eventLog){if(eventLog&&eventLog.Active){count+=eventLog.MessagesWaitingCount()}});return count}function ByIssueId(issueId){var customerId=customerIdByIssueId[issueId];return eventLogsByCustomerId[customerId]}function IssueEventLogMixin(){return{componentWillMount:function(){var issueId=this.props.IssueId||this.props.issueId;if(issueId){var customerId=customerIdByIssueId[issueId];this.eventLog=eventLogsByCustomerId[customerId]}},componentWillUpdate:function(_,state){var issueId=state.IssueId||state.issueId;if(issueId){var customerId=customerIdByIssueId[issueId];this.eventLog=eventLogsByCustomerId[customerId]}}}}function BeforeProcessEventMixin(eventHandler){return handleEventMixin(["BeforeEvent","BeforeEphemeralEvent"],eventHandler)}function AfterEventProcessedMixin(eventHandler){return handleEventMixin(["EventProcessed","EphemeralEventProcessed"],eventHandler)}function AfterCurrentEventLogEventProcessedMixins(fn){return handleEventMixin(["EventProcessed","EphemeralEventProcessed"],function(event,eventLog,isLive,isLastEvent){if(eventLog!=clientState.CurrentEventLog()){return}fn.apply(this,arguments)})}function handleEventMixin(eventNames,eventHandler){assert(eventNames.length&&eventHandler);var propPrefix="__onEventLogs";return{componentWillMount:function(){each(eventNames,bind(this,function(eventName){this[propPrefix+eventName]=eventLogs.On(eventName,bind(this,eventHandler))}))},componentWillUnmount:function(){each(eventNames,bind(this,function(eventName){eventLogs.Off(this[propPrefix+eventName])}))}}}function ObserveActiveEventLogsMixin(callback){return{componentWillMount:function(){this._onCurrIssesObsId=store.Observe("activeEventLogs",bind(this,callback))},componentWillUnmount:function(){store.Off(this._onCurrIssesObsId)}}}function UpdateWithCurrentCustomerEventsMixin(){return AfterEventProcessedMixin(function(event){if(clientState.CurrentIssueId()!=event.IssueId){return}this.forceUpdate()})}function OnMixin(signal,callback){var obsId;return{componentWillMount:function(){obsId=pubsub.On(signal,bind(this,callback))},componentWillUnmount:function(){pubsub.Off(obsId)}}}function getActiveEventLogs(){var activeEventLogs=filter(eventLogsByCustomerId,function(eventLog){return!!eventLog.Active});activeEventLogs.sort(function(a,b){return a.Active<b.Active?-1:a.Active>b.Active?1:0});return activeEventLogs}function GetEventLogForEvent(event){return GetEventLog(event.CustomerId,event.IssueId)}var customerIdByIssueId={};var eventLogsByCustomerId={};var repsById={};var eventLogsByIssueId={};function SetupActiveIssueObservation(){conn.On("DidAuthenticate",function(){Conn.Request("rep/GetAndAssignRepIssues",null,bind(this,function(res){each(res.Issues,function(issue){if(eventLogsByCustomerId[issue.CustomerId]){return}initiateEventLog(issue.CustomerId,issue.IssueId)});store.Set("issuesLoaded",true)}))});conn.On("DidDisconnect",function(){store.Set("issuesLoaded",false)});conn.On("EventData",function(event){if(!eventLogsByCustomerId[event.CustomerId]){initiateEventLog(event.CustomerId,event.IssueId)}eventLogsByCustomerId[event.CustomerId].handleEvent(event,true,true)});conn.On("SignalTransferComplete",function(signal){var myId=window.gRep?window.gRep.RepId:null;if(signal.ToRepId==myId){return}var transferedIssue=eventLogsByIssueId[signal.IssueId];if(transferedIssue){if(clientState.CurrentEventLog()&&clientState.CurrentEventLog().IssueId==signal.IssueId){clientState.SetCurrentEventLog(null)}transferedIssue.Deactivate();transferedIssue.ClearCurrentIssue()}})}function SetupCustomerIssueObservation(){conn.On("EventData",function(event){if(!eventLogsByCustomerId[event.CustomerId]){observeCustomerEventLog(event.CustomerId)}eventLogsByCustomerId[event.CustomerId].handleEvent(event,true)})}function GetEventLog(customerId,issueId){if(eventLogsByCustomerId[customerId]){return eventLogsByCustomerId[customerId]}else{return initiateEventLog(customerId,issueId)}}function GetCustomerEventLog(customerId){if(eventLogsByCustomerId[customerId]){return eventLogsByCustomerId[customerId]}else{return observeCustomerEventLog(customerId)}}function observeCustomerEventLog(customerId){var eventLog=NewEventLog(0,customerId,[],{isCustomerEventLog:true});eventLog.fetch();if(!clientState.CurrentEventLog()){after(100,curry(clientState.SetCurrentEventLog,eventLog))}return eventLog}function initiateEventLog(customerId,issueId){var eventLog=NewEventLog(issueId,customerId,[],{isCustomerEventLog:false});eventLog.fetch();eventLog.Once("fetched",function(){pubsub.Fire("EventLogInitiated",eventLog);eventLogs.Fire("NewIssue")});if(!clientState.CurrentEventLog()){after(100,curry(clientState.SetCurrentEventLog,eventLog))}return eventLog}function FilterAll(filterFn){var result=[];each(eventLogsByCustomerId,function(eventLog){result.push.apply(result,eventLog.Filter(filterFn))});return result}function IssueCustomer(issueId){var customerId=customerIdByIssueId[issueId];return eventLogsByCustomerId[customerId].Customer}function Rep(repId){return repsById[repId]}function GetEventLogPos(posOrEventLogOrEvent){if(isNumber(posOrEventLogOrEvent)){return posOrEventLogOrEvent}else if(posOrEventLogOrEvent.__isEventLog){return posOrEventLogOrEvent.Position}else{var eventLog=eventLogsByCustomerId[posOrEventLogOrEvent.CustomerId];return eventLog?eventLog.Position:0}}function NewEventLog(issueId,customerId,events,opts){assert(!customerIdByIssueId[issueId]);assert(!eventLogsByCustomerId[customerId]);opts=defaults(opts||{},{ensureCompleteEventLogHistory:true});var lastEventSeq=0;if(events&&events.length){lastEventSeq=events[0].CompanyEventLogSeq-1}var eventLog=stores.New();_.assign(eventLog,eventLogBase);eventLog.extend({Active:true,IssueId:issueId,CustomerId:customerId,events:[],lastEventSeq:lastEventSeq,eventsByIssueId:{},Rep:null,Customer:null,IssueTopic:null,CompanyGroupId:null,CustomerIsTyping:false,RepIsTyping:false,summaries:{},isCustomerEventLog:opts.isCustomerEventLog,ensureCompleteEventLogHistory:opts.ensureCompleteEventLogHistory,messagesWaitingCount:0});eventLogsByCustomerId[customerId]=eventLog;if(!eventLog.isCustomerEventLog){customerIdByIssueId[issueId]=customerId}for(var i=0;i<events.length;i++){eventLog.handleEvent(events[i],false,events.length-i==1?true:false)}pubsub.Fire("NewEventLog",eventLog);eventLog.OnFire(function(){var args=Array.prototype.slice.call(arguments);args.splice(1,0,eventLog);pubsub.Fire.apply(pubsub,args)});return eventLog}var eventLogBase={__isEventLog:true,extend:function(props){for(var key in props){assert(!this[key]);this[key]=props[key]}},HasCustomerName:function(){return!!this.CRMCustomerName},HasCustomerId:function(){return!!this.CRMCustomerId},HasMessageEvent:function(){var messageEvent=find(this.events,function(event){return event.EventType===EventTypeTextMessage||event.EventType===EventTypePictureMessage});return messageEvent?true:false},HasNonPromptEvent:function(){var nonPromptEvents=filter(this.events,function(event){return event.EventType!==EventTypeCustomerPrompt});return nonPromptEvents.length},DisplayCustomerIdentifier:function(){return this.CRMCustomerName||this.CRMCustomerId||"A Customer"},DisplayCustomerName:function(){return this.CRMCustomerName||"(No name)"},DisplayCRMCustomerId:function(){return this.CRMCustomerId||"(Unknown customer)"},GetLatestRatingForCurrentIssue:function(){var events=this.Events();for(var i=events.length-1;i>=0;i--){if(events[i].EventType==EventTypeConversationRated){return events[i].payload}else if(events[i].EventType==EventTypeNewIssue){break}}return{}},DidProvideFeedbackAfterRating:function(){var events=this.Events();for(var i=events.length-1;i>=0;i--){if(events[i].EventType==EventTypeCustomerFeedback){return true}else if(events[i].EventType==EventTypeConversationRated){break}}return false},IsLinkedWithCRM:function(){return!!this.CRMCustomerLinkedTime},IsIssueActive:function(){for(var i=this.events.length-1;i>=0;i--){if(this.events[i].EventType==EventTypeNewIssue){return true}else if(this.events[i].EventType==EventTypeConversationEnd||this.events[i].EventType==EventTypeCustomerConversationEnd){return false}}return false},ShouldAskForFeedback:function(){for(var i=this.events.length-1;i>=0;i--){if(this.events[i].EventType==EventTypeNewIssue||this.events[i].EventType==EventTypeConversationRated){return false}else if(this.events[i].EventType==EventTypeConversationEnd||this.events[i].EventType==EventTypeCustomerConversationEnd){return true}}return false},IssueSummary:function(){return this.summaries[this.IssueId]},Status:function(){var waitingInfo=this.CustomerTimeWaitingInfo();if(!waitingInfo){return"passive"}else if(waitingInfo.duration<30*time.Second){return"active"}else if(waitingInfo.duration<90*time.Second){return"attention"}else{return"urgent"}},GetAssignedRep:function(){var events=this.Events();for(var i=events.length-1;i>=0;i--){if(events[i].EventType==EventTypeNewRep){return events[i].payload.NewRep}else if(events[i].EventType==EventTypeIssueEnqueued||events[i].EventType==EventTypeNewIssue){break}}return null},Filter:function(filterFn){return _.filter(this.events,filterFn)},MessagesWaitingCount:function(){return this.messagesWaitingCount},loop:function(loopFn,reverse){var start=reverse?this.events.length-1:0;var stop=reverse?-1:this.events.length;var dir=reverse?-1:1;for(var i=start;i!=stop;i+=dir){if(loopFn(this.events[i])){return this.events[i]}}},Iterate:function(loopFn){return this.loop(loopFn,false)},Reverse:function(loopFn){return this.loop(loopFn,true)},MostRecentTextMessage:function(){var textEvent=this.Reverse(function(event){return event.EventType==EventTypeTextMessage});return textEvent?textEvent.payload.Text:""},MostRecentCustomerMessage:function(){var textEvent=this.Reverse(function(event){return event.EventType==EventTypeTextMessage&&events.IsFromCustomer(event)});return textEvent?JSON.parse(textEvent.EventJSON).Text:""},Events:function(){return this.events},IsLoading:function(){return this.events.length==0},IssueIds:function(){var res=[];for(var issueId in this.eventsByIssueId){res.push(issueId)}return res},ForEachIssueEvent:function(issueId,fn){var issueEvents=this.eventsByIssueId[issueId];for(var i=0;i<issueEvents.length;i++){fn(issueEvents[i])}},GetEventBySeq:function(seq){var offset=seq-this.events[0].CompanyEventLogSeq;var event=this.events[offset];while(event&&event.CompanyEventLogSeq!=seq){if(event.CompanyEventLogSeq<seq){offset+=1}else{offset-=1}event=this.events[offset]}return event},GetIssueTranscript:function(){var tEvents=[];var events=this.Events();each(events,bind(this,function(event){if(event.IssueId==this.IssueId){tEvents.push(event)}}));return tEvents},AddAnnotation:function(payload){var annotatedEvent=this.GetEventBySeq(payload.Seq);if(!annotatedEvent.annotations){annotatedEvent.annotations=[]}annotatedEvent.annotations.push(payload)},MostRecentNewIssue:function(){var mostRecentNewIssue=null;this.Reverse(function(event){if(!events.IsNewIssueEvent(event)){return}mostRecentNewIssue=event;return true});return mostRecentNewIssue},MostRecentStatusEvent:function(){var mostRecentStatusEvent=null;this.Reverse(function(event){if(!events.IsMessageEvent(event)){return}mostRecentStatusEvent=event;return true});return mostRecentStatusEvent},MostRecentStatusEvents:function(){var last={};this.Reverse(function(event){if(!events.IsMessageEvent(event)){return}if(events.IsFromCustomer(event)){if(!last.CustomerEvent){last.CustomerEvent=event}}else{if(!last.RepEvent){last.RepEvent=event}}var stop=!!(last.CustomerEvent&&last.RepEvent);return stop});return last},CustomerTimeWaitingInfo:function(){var last=this.MostRecentStatusEvents();var lastCustomerEventSeq=last.CustomerEvent?last.CustomerEvent.CompanyEventLogSeq:0;var lastRepEventSeq=last.RepEvent?last.RepEvent.CompanyEventLogSeq:0;var customerIsWaiting=lastCustomerEventSeq>lastRepEventSeq;if(!customerIsWaiting){return null}var waitingSinceEvent=this.mostRecentIssueMessageEventForAgentType("customer");if(!waitingSinceEvent){return null}var duration=time.Now()-waitingSinceEvent.CreatedTime;var hours=Math.floor(duration/time.hours);var minutes=Math.floor(duration%time.hours/time.minutes);var seconds=Math.floor(duration%time.minutes/time.seconds);return{duration:duration,hours:hours,minutes:minutes,seconds:seconds}},RepTimeWaitingInfo:function(){var last=this.MostRecentStatusEvents();var lastCustomerEventSeq=last.CustomerEvent?last.CustomerEvent.CompanyEventLogSeq:0;var lastRepEventSeq=last.RepEvent?last.RepEvent.CompanyEventLogSeq:0;var repIsWaiting=lastCustomerEventSeq<lastRepEventSeq;if(!repIsWaiting){return null}var waitingSinceEvent=this.mostRecentIssueMessageEventForAgentType("rep");if(!waitingSinceEvent){return null}var duration=time.Now()-waitingSinceEvent.CreatedTime;var hours=Math.floor(duration/time.hours);var minutes=Math.floor(duration%time.hours/time.minutes);var seconds=Math.floor(duration%time.minutes/time.seconds);return{duration:duration,hours:hours,minutes:minutes,seconds:seconds}},Deactivate:function(){for(var issueId in eventLogsByIssueId){if(eventLogsByIssueId[issueId]==this){this.Active=null;this.Position=null;delete eventLogsByIssueId[issueId];pubsub.Fire("EventLogDeactivated",this);store.Set("activeEventLogs",getActiveEventLogs())}}},ClearCurrentIssue:function(){delete eventLogsByIssueId[this.IssueId];delete customerIdByIssueId[this.IssueId];delete eventLogsByCustomerId[this.CustomerId]},mostRecentIssueMessageEventForAgentType:function(agentType){var mostRecentIssueMessageEventForAgent;this.Reverse(function(event){if(event.EventType==EventTypeNewIssue){return true}if(events.IsMessageEvent(event)){if(events.IsFromCustomer(event)&&agentType=="customer"){mostRecentIssueMessageEventForAgent=event}else if(!events.IsFromCustomer(event)&&agentType=="rep"){mostRecentIssueMessageEventForAgent=event}else{return true}}});return mostRecentIssueMessageEventForAgent},isOldEvent:function(event){return this.getEventLogSeq(event)<=this.lastEventSeq},isNextEvent:function(event){return this.getEventLogSeq(event)==this.lastEventSeq+1},isFutureEvent:function(event){return this.getEventLogSeq(event)>this.lastEventSeq},getEventLogSeq:function(event){var eventSeq=event.CompanyEventLogSeq;if(this.isCustomerEventLog){eventSeq=event.CustomerEventLogSeq}return eventSeq},fetch:function(isPollFetch){if(this.isFetching){this.shouldRefetch=true;return}this.isFetching=true;this.shouldRefetch=false;var api="rep/GetEvents";var ctx={CustomerId:this.CustomerId,IssueId:this.IssueId};var params={AfterSeq:this.lastEventSeq};if(this.isCustomerEventLog){api="customer/GetEvents";ctx={CompanyId:clientState.GetCompanyInfo().CompanyId}}Conn.RequestWithCtx(api,ctx,params,bind(this,function(res){this.isFetching=false;var events=res.Events;if(this.isCustomerEventLog){events=res.EventList}for(var i=0;i<events.length;i++){var isLastEvent=i==events.length-1;if(this.handleEvent(events[i],isPollFetch,isLastEvent)){after(0,bind(this,this.fetch));return}}if(this.shouldRefetch){after(0,bind(this,this.fetch))}this.pubsub.Fire("fetched")}))},handleEvent:function(event,isLive,isLastEvent){event.date=new Date(event.CreatedTime/1e3);if(events.IsEphemeral(event)){this.processEphemeralEvent(event)}else if(this.isOldEvent(event)){}else if(this.isNextEvent(event)){this.processNextEvent(event,isLive,isLastEvent)}else if(this.isFutureEvent(event)){if(this.ensureCompleteEventLogHistory){this.fetch();return true}else{this.processNextEvent(event,isLive,isLastEvent)}}else{throw new Exception("Should not get here")}},processNextEvent:function(event,isLive,isLastEvent){event.eventUid=getEventUid(event);pubsub.Fire("BeforeEvent",event,isLive);var issueId=event.IssueId;if(!this.eventsByIssueId[issueId]){this.eventsByIssueId[issueId]=[]}this.eventsByIssueId[issueId].push(event);this.events.push(event);this.lastEventSeq=this.getEventLogSeq(event);var payload=event.payload=event.EventJSON&&JSON.parse(event.EventJSON);if(event.EventType==EventTypeNewRep&&!this.isCustomerEventLog){repsById[event.RepId]=payload.NewRep;if(events.IsFromMe(event)&&!eventLogsByIssueId[event.IssueId]){this.Deactivate();eventLogsByIssueId[event.IssueId]=this;this.Active=new Date;store.Set("activeEventLogs",getActiveEventLogs());async(bind(this,function(){pubsub.Fire("EventLogLoaded",this)}))}}else if(event.EventType==EventTypeNewIssue){this.IssueId=event.IssueId;this.PlatformType=payload.Issue?payload.Issue.PlatformType:""}else if(event.EventType==EventTypeTopicChange){this.IssueTopic=payload}else if(event.EventType==EventTypeConversationEnd){this.Deactivate();pubsub.Fire("ConversationEnded",this)}else if(event.EventType==EventTypeIssueEnqueued){this.CompanyGroupId=payload.CompanyGroupId}else if(event.EventType==EventTypeCustomerTimedOut){this.CustomerState=CustomerStateTimedOut;this.Deactivate()}else if(event.EventType==EventTypeCRMCustomerLinked){this.CRMCustomerLinkedTime=payload.CRMCustomerLinkedTime}else if(event.EventType==EventTypeIssueSummarized){this.summaries[this.IssueId]=payload.Text}else if(event.EventType==EventTypeTextAnnotation){
this.AddAnnotation(payload)}else if(event.EventType==EventTypeCustomerPrompt){async(bind(this,function(){pubsub.Fire("EventLogLoaded",this)}))}if(this.eventShouldAddToMessagesWaitingCount(event)){this.messagesWaitingCount+=1}else if(this.eventShouldResetMessagesWaitingCount(event)){this.messagesWaitingCount=0}pubsub.Fire("EventProcessed",event,this,isLive,isLastEvent)},eventShouldAddToMessagesWaitingCount:function(event){return events.IsMessageEvent(event)&&(!events.IsFromCustomer(event)&&this.isCustomerEventLog||events.IsFromCustomer(event)&&!this.isCustomerEventLog)},eventShouldResetMessagesWaitingCount:function(event){return events.IsMessageEvent(event)&&(events.IsFromCustomer(event)&&this.isCustomerEventLog||!events.IsFromCustomer(event)&&!this.isCustomerEventLog)},processEphemeralEvent:function(event){pubsub.Fire("BeforeEphemeralEvent",event);var payload=event.payload=JSON.parse(event.EventJSON);if(event.EphemeralType==EphemeralTypeTypingStatus){if(events.IsFromCustomer(event)){this.CustomerIsTyping=payload.IsTyping}else{this.RepIsTyping=payload.IsTyping}}else if(event.EphemeralType==EphemeralTypeTypingPreview){this.CustomerTypingPreview=payload.Text}else if(event.EphemeralType==EphemeralTypeCustomerCRMInfo){this.CRMCustomerName=payload.Name;this.CRMCustomerId=payload.CRMCustomerId;this.CRMCustomerAccountCreatedTime=payload.AccountCreatedTime}pubsub.Fire("EphemeralEventProcessed",event,this,true,true)}};function FormatIssueTranscript(tEvents){var transcript="";var issueRep=null;each(tEvents,function(event){var shouldAddEvent=true;var eventText="\n\n"+moment(event.date).format("MMM D YYYY, hh:mm A");if(event.EventType==EventTypeNewRep){issueRep=event.payload;eventText+="\n----- ACCEPTED BY REP "+issueRep.NewRep.Name}else if(event.EventType==EventTypeTextMessage){if(events.IsFromCustomer(event)){eventText+="\nCustomer: "+event.payload.Text}else{if(!issueRep){return}eventText+="\n"+issueRep.NewRep.Name+": "+event.payload.Text}}else if(event.EventType==EventTypeNewIssue){eventText+="\n----- ISSUE CREATED"}else if(event.EventType==EventTypeConversationEnd){eventText+="\n----- ISSUE ENDED"}else{shouldAddEvent=false}if(shouldAddEvent){transcript+=eventText}});return transcript}function Clear(){customerIdByIssueId={};eventLogsByCustomerId={};repsById={};eventLogsByIssueId={}}},{"asapp/data/clientState":9,"asapp/data/events":12,"asapp/net/conn":15,"asapp/util/pubsub":36,"asapp/util/store":37}],12:[function(require,module,exports){require("asapp/data/constants");var events=module.exports={IsFromCustomer:IsFromCustomer,IsFromMe:IsFromMe,IsEphemeral:IsEphemeral,IsAutoGenerated:IsAutoGenerated,IsMessageEvent:IsMessageEvent,IsNewIssueEvent:IsNewIssueEvent};function IsFromCustomer(event){return event.EventFlags&EventFlagFromCustomer}function IsFromMe(event){return window.gRep&&event.RepId==window.gRep.RepId}function IsEphemeral(event){return event.EphemeralType!=0}function IsAutoGenerated(event){return!!(event.EventFlags&EventFlagAutoGenerated)}function IsMessageEvent(event){return event.EventType==EventTypeTextMessage||event.EventType==EventTypePictureMessage}function IsNewIssueEvent(event){return event.EventType==EventTypeNewIssue}},{"asapp/data/constants":10}],13:[function(require,module,exports){module.exports=time=extend(require("std/time").inMicroseconds(),{mixins:{Ticker:TickerMixin}});time.Base=time.base;var invoke=require("std/invoke");function TickerMixin(duration,callback){return{componentDidMount:function(){this["__ticker_"+duration]=time.OnTick(duration,bind(this,function(){callback.call(this)}))},componentWillUnmount:function(){time.OffTick(this["__ticker_"+duration])}}}time.Now=function(){return time.now()};time.Ago=function(ago){return time.Now()-ago};time.ToDateStr=function(ts){if(!ts){return null}return new Date(ts/time.Millisecond).toISOString().substr(0,10)};time.ToTimeStr=function(ts){if(!ts){return null}var duration=moment.duration(ts/time.Millisecond);var durationHours=Math.floor(duration.asHours());return padDoubleDigits(durationHours)+":"+padDoubleDigits(duration.minutes())+":"+padDoubleDigits(duration.seconds())};function padDoubleDigits(val){return(val<10?"0":"")+val}time.FromDateStr=function(dateStr){return new Date(dateStr).getTime()*time.Millisecond};var tickers={byTickerId:{},byInterval:{},tickerId:1};tickers.byInterval[time.seconds]={};setInterval(function(){each(tickers.byInterval[time.seconds],function(ticker){ticker.callback()})},1e3);time.OnTick=function(interval,callback){var tickerId=tickers.tickerId++;var ticker={interval:interval,callback:callback,tickerId:tickerId};tickers.byInterval[interval][tickerId]=ticker;tickers.byTickerId[tickerId]=ticker;callback();return tickerId};time.OffTick=function(tickerId){var ticker=tickers.byTickerId[tickerId];delete tickers.byInterval[ticker.interval][tickerId];delete tickers.byTickerId[tickerId]};time.Nanosecond=time.Nanoseconds=time.nanosecond;time.Microsecond=time.Microseconds=time.microsecond;time.Millisecond=time.Milliseconds=time.millisecond;time.Second=time.Seconds=time.second;time.Minute=time.Minutes=time.minute;time.Hour=time.Hours=time.hour;time.Day=time.Days=time.day},{"std/invoke":49,"std/time":57}],14:[function(require,module,exports){var parseUrl=require("asapp/util/parseUrl");module.exports={track:function(event,props){var data={type:"ASAPPSendAnalyticsEvent",event:event,props:props||{}};if(!data.props.timestamp){data.props.timestamp=(new Date).getTime()}window.parent.postMessage(data,getOriginPath())}};function getOriginPath(){var url=parseUrl(window.location);return url.getSearchParam("OriginPath")}},{"asapp/util/parseUrl":35}],15:[function(require,module,exports){var clientState=require("asapp/data/clientState");var pubsub=require("asapp/util/pubsub").New();var stores=require("asapp/util/store");var store=stores.New();var log=require("asapp/apps/web-sdk/log");Conn=null;var conn=module.exports=create(pubsub,{Timeout:1e3,Connect:Connect,CountConnectionForIssueTimeout:CountConnectionForIssueTimeout,IsConnecting:IsConnecting,IsConnected:IsConnected,IsReconnecting:IsReconnecting,IsAuthenticating:IsAuthenticating,IsAuthenticated:IsAuthenticated,mixins:{ObserveState:ObserveStateMixin,ObserveIsRequesting:ObserveIsRequestingMixin,ObserveAuth:ObserveAuthMixin}});var countConnectionForIssueTimeout;function CountConnectionForIssueTimeout(shouldCount){countConnectionForIssueTimeout=shouldCount}function ObserveIsRequestingMixin(callback){return observeStoreMixin(store,"isRequesting",callback)}function ObserveAuthMixin(callback){return observeStoreMixin(store,"AuthResponse",callback)}{var requestCount=0;conn.On("DidRequest",function(){updateIsRequesting(1)});conn.On("RequestDidFinish",function(){updateIsRequesting(-1)});conn.On("DidOpen",function(){requestCount=0;updateIsRequesting(0)});function updateIsRequesting(delta){requestCount+=delta;var isRequesting=requestCount>0;if(isRequesting!=store.Get("isRequesting")){store.Set("isRequesting",isRequesting);if(!isRequesting){conn.Fire("AllRequestsDone")}}}}function observeStoreMixin(store,name,callback){var obsKey="_"+name+"ObsId";return{componentWillMount:function(){this[obsKey]=store.Observe(name,bind(this,callback))},componentWillUnmount:function(){store.Off(this[obsKey])}}}function ObserveStateMixin(callback){return observeStoreMixin(store,"state",callback)}function IsConnecting(){return store.Get("state")=="Connecting"}function IsConnected(){return store.Get("state")=="Connected"}function IsReconnecting(){return store.Get("state")=="Reconnecting"}function IsAuthenticating(){return store.Get("state")=="Authenticating"}function IsAuthenticated(){return store.Get("state")=="Authenticated"}var reconnectImmediately=false;function Connect(){store.Set("state","Connecting");var didAuth=false;var protocol=location.protocol=="https:"?"wss:":"ws:";var url=protocol+"//"+location.host+"/api/websocket?ASAPP-ClientType=web-desk&ASAPP-ClientVersion=0.1.0";if(!window.WebSocket){Conn=require("./longpoll")}else if(window.WebSocket&&(WebSocket.CLOSED==2||WebSocket.prototype.CLOSED==2)){return}else{Conn=new WebSocket(url)}Conn.onclose=onclose;Conn.onmessage=onmessage;Conn.onopen=onopen;Conn.onerror=onerror;Conn.Request=Request;Conn.RequestWithErr=RequestWithErr;Conn.RequestWithCtx=RequestWithCtx;Conn.SendData=SendData;Conn.Authenticate=AuthenticateWithUserProvidedCredentials;Conn.SetCtx=SetCtx;var CurrentCtxParams={};function SetCtx(newCtxParams){extend(CurrentCtxParams,newCtxParams)}var Sep="|";var requests={};function Request(code,params,callback){if(arguments.length==2&&isFunction(params)){callback=params;params={}}doRequest(code,CurrentCtxParams,params,false,callback)}function RequestWithErr(code,params,callback){if(arguments.length==2&&isFunction(params)){callback=params;params={}}doRequest(code,CurrentCtxParams,params,true,callback)}function RequestWithCtx(code,ctxParams,params,callback){if(arguments.length==3){callback=params;params={}}doRequest(code,ctxParams,params,false,callback)}function doRequest(code,ctxParams,params,passOnErr,callback){if(!ctxParams){ctxParams={}}defaults(ctxParams,CurrentCtxParams);var reqId=clientState.NextReqId();requests[reqId]={callback:callback,code:code,passOnErr:passOnErr};var data=[code,reqId,JSON.stringify(ctxParams),JSON.stringify(params)].join(Sep);if(code!="rep/AcceptIssue"){log("Request",reqId,code,ctxParams,params)}if(Conn.readyState!=1){log("CAN'T SEND, NOT OPEN",code,params);after(3e3,bind(this,Request,code,params,callback));return}conn.Fire(code);Conn.send(data);conn.Fire("DidRequest")}function SendData(data){Conn.send(data)}var authing;function AuthenticateWithUserProvidedCredentials(code,params,checkResCallback,resCallback){if(authing){return}stores.ClearAll();return authenticate(code,params,checkResCallback,resCallback)}function authenticate(code,params,checkResCallback,resCallback){if(authing){return}store.Set("state","Authenticating");authing=true;params.CountConnectionForIssueTimeout=countConnectionForIssueTimeout;params.App=appName;Conn.RequestWithErr(code,params,function(err,res){authing=false;var success=true;if(err){success=false}else if(!checkResCallback(res)){success=false}if(success){if(res.SessionInfo&&res.SessionInfo.SessionAuth.SessionSecret){clientState.SetSessionInfo(res.SessionInfo);if(Conn.isLongPoll){Conn.poll()}}didAuth=true;if(typeof hideBanner!=="undefined"){hideBanner()}conn.Fire("DidAuthenticate",res);store.Set("AuthResponse",res);store.Set("state","Authenticated");if(resCallback){resCallback()}}else{if(typeof bannerShowing!=="undefined"&&!bannerShowing()){showError("Bad login")}clientState.SetSessionInfo(null);store.Set("state","Connected")}})}function onclose(event){if(didAuth){window.location=window.location.toString();return}conn.Fire("DidDisconnect");if(reconnectImmediately){reconnectImmediately=false;Connect()}else{store.Set("state","Reconnecting");after(conn.Timeout,function(){conn.Timeout=clip(conn.Timeout*2,1e3,1e3*30);Connect()})}}function onmessage(event){var packet=event.data;var idx=packet.indexOf(Sep);var code=packet.substring(0,idx);if(code=="Response"){conn.Fire("RequestDidFinish");idx=packet.indexOf(Sep,idx+1);var reqId=packet.substring(code.length+1,idx);var json=packet.substring(idx+1);var req=requests[reqId];delete requests[reqId];var reqCode=req.code;var callback=req.callback;var passOnErr=req.passOnErr;var response=JSON.parse(json);if(reqCode!="rep/AcceptIssue"){log("Response:",reqId,reqCode,response)}if(callback){if(passOnErr){callback(null,response)}else{callback(response)}}}else if(code=="ResponseError"){conn.Fire("RequestDidFinish");idx=packet.indexOf(Sep,idx+1);var reqId=packet.substring(code.length+1,idx);var error=packet.substring(idx+1);var req=requests[reqId];delete requests[reqId];var reqCode=req.code;var callback=req.callback;var passOnErr=req.passOnErr;log("ResponseError: ",reqId,reqCode,error);if(typeof showError==="function"){showError(error)}if(callback&&passOnErr){callback(error,null)}}else if(code=="Event"){var json=packet.substring(idx+1);var event=JSON.parse(json);log("Event:",event);conn.Fire("EventData",event)}else if(code=="CompanyStatusEvent"){var json=packet.substring(idx+1);var event=JSON.parse(json);log("CompanyStatusEvent:",event);conn.Fire("CompanyStatusEventData",event)}else if(code=="Signal"){var jsonIdx=packet.indexOf(Sep,idx+1);var signalName=packet.substring(idx+1,jsonIdx);var signalJSON=packet.substring(jsonIdx+1);handleSignal(signalName,JSON.parse(signalJSON))}else{log("Unknow packet data",event.data)}}function handleSignal(signalName,signal){log("Signal:",signalName,signal);switch(signalName){case"DidAuthenticate":var sessionInfo=clientState.GetSessionInfo();if(sessionInfo&&signal.SessionInfo.AuthenticatedTime!=sessionInfo.AuthenticatedTime){}return;case"TransferRequest":clientState.AddTransferRequest(signal.TransferInfo);conn.Fire("SignalTransferRequest");return;case"TransferComplete":clientState.RemoveTransferRequest(signal.TransferInfo.IssueId);conn.Fire("SignalTransferComplete",signal.TransferInfo);return;case"CancelTransferRequest":clientState.RemoveTransferRequest(signal.TransferInfo.IssueId);conn.Fire("SignalCancelTransferRequest");return;default:log("Unknown signal type",signalName,signal)}}function onopen(event){log("didopen");conn.Fire("DidOpen");conn.Timeout=1e3;store.Set("state","Connected");var sessionInfo=clientState.GetSessionInfo();if(sessionInfo){var params={SessionInfo:sessionInfo};authenticate("auth/AuthenticateWithSession",params,function(res){return res.SessionInfo})}}function onerror(event){log("Network error")}if(Conn.isLongPoll){Conn.init("https://"+location.host+"/api/longpoll?ASAPP-ClientType=web-desk&ASAPP-ClientVersion=0.1.0","https://"+location.host+"/api/longpoll-request?ASAPP-ClientType=web-desk&ASAPP-ClientVersion=0.1.0")}}},{"./longpoll":16,"asapp/apps/web-sdk/log":7,"asapp/data/clientState":9,"asapp/util/pubsub":36,"asapp/util/store":37}],16:[function(require,module,exports){module.exports={__isOpen:false,__url:null,__send_url:null,__fail_threshhold:0,readyState:1,isLongPoll:true,init:function(pollURL,sendURL){__url=pollURL;__send_url=sendURL;__isOpen=true;if(this.onopen){this.onopen({})}},poll:function(){setInterval(bind(this,function(){this.getMissedEvents()}),1e3)},getMissedEvents:function(){var eventLog=clientState.CurrentEventLog();if(!eventLog){return}eventLog.fetch(true)},handleMessage:function(res){if(!this.onmessage){return}var data={data:res};this.onmessage(data)},send:function(data){var sessionInfo={SessionInfo:clientState.GetSessionInfo()};var reqData=JSON.stringify(sessionInfo)+"|"+data;var req=$.ajax({url:__send_url,type:"POST",data:reqData,contentType:"application/json",beforeSend:function(xhr){}}).done(bind(this,function(msg,textStatus){this.handleMessage(msg)})).fail(bind(this,function(xhr,textStatus){}))}}},{}],17:[function(require,module,exports){module.exports=MakeCanvas;var canvasBase={MoveToPoint:MoveToPoint,AddLineToPoint:AddLineToPoint,AddQuadCurveToPoint:AddQuadCurveToPoint,Translate:Translate,Scale:Scale,Fill:Fill,Stroke:Stroke,DataURL:DataURL,Img:Img};function MakeCanvas(w,h){var el=document.createElement("canvas");var ctx=el.getContext("2d");var ratio=2;el.width=w*ratio;el.height=h*ratio;el.style.width=w+"px";el.style.height=h+"px";return extend(ctx,canvasBase,{el:el,ctx:ctx})}function Fill(color){this.fillStyle=color;this.fill();return this}function Translate(x,y){this.translate(x,y);return this}function Scale(x,y){this.scale(x,y);return this}function Stroke(lineWidth,color){this.lineWidth=lineWidth;this.strokeStyle=color;this.stroke();return this}function MoveToPoint(x,y){this.moveTo(x,y);return this}function AddLineToPoint(x,y){this.lineTo(x,y);return this}function AddQuadCurveToPoint(ctrlX,ctrlY,endX,endY){this.quadraticCurveTo(ctrlX,ctrlY,endX,endY);return this}function DataURL(){return this.el.toDataURL()}function Img(){var dataURL=this.el.toDataURL();var img=document.createElement("img");img.src=dataURL;return img}},{}],18:[function(require,module,exports){require("asapp/util/util-globals");var shades=["#161616","#616161","#727275","#E0E0E0","#F1F1F1","#FBFBFB"];var whites=slice(shades).reverse();var Colors=module.exports={shades:shades,whites:whites,active:"#4285F4"};each(Colors.shades,function(color,index){Colors["shade"+index]=color});each(Colors.whites,function(color,index){Colors["white"+index]=color})},{"asapp/util/util-globals":39}],19:[function(require,module,exports){module.exports=ui.ViewComponent("SVGButton",{render:function(){if(!window.WebSocket){return div()}GetSVG(this.props.id,this.props.path,this.props.strokeColor,this.props.scale);var scale=this.props.scale?this.props.scale:1;return span(style({position:"relative",display:"inline-block"}),id(this.props.id),div(Pos(0,0),FillW,FillH,tappable(bind(this,this.props.actionCallback)),{onMouseOver:bind(this,function(){ChangeSVGColor(this.props.id,this.props.strokeColorHover)}),onMouseOut:bind(this,function(){ChangeSVGColor(this.props.id,this.props.strokeColor)})}))}});function GetSVG(appendToId,path,color,scale){var close_svg=d3.xml("/current-web/web/deps/"+path+".svg","image/svg+xml",function(xml){d3.select("#"+appendToId).select("svg").remove();$("#"+appendToId).append(xml.documentElement);d3.select("#"+appendToId).select("svg").selectAll("path").attr("fill",color);d3.select("#"+appendToId).select("svg").selectAll("path").attr("stroke",color);d3.select("#"+appendToId).select("svg").selectAll("circle").attr("stroke",color);d3.select("#"+appendToId).select("svg").selectAll("line").attr("fill",color);d3.select("#"+appendToId).select("svg").selectAll("polygon").attr("fill",color);d3.select("#"+appendToId).select("svg").selectAll("polyline").attr("fill",color);if(scale){var w=parseInt(d3.select("#"+appendToId).select("svg").attr("width"));var h=parseInt(d3.select("#"+appendToId).select("svg").attr("height"));d3.select("#"+appendToId).select("svg").attr("width",w*scale+"px");d3.select("#"+appendToId).select("svg").attr("height",h*scale+"px")}})}function ChangeSVGColor(parentId,color){if(!color){return}d3.select("#"+parentId).select("svg").selectAll("path").attr("fill",color);d3.select("#"+parentId).select("svg").selectAll("path").attr("stroke",color);d3.select("#"+parentId).select("svg").selectAll("circle").attr("stroke",color);d3.select("#"+parentId).select("svg").selectAll("line").attr("fill",color);d3.select("#"+parentId).select("svg").selectAll("polygon").attr("fill",color);d3.select("#"+parentId).select("svg").selectAll("polyline").attr("fill",color)}},{}],20:[function(require,module,exports){var Canvas=require("asapp/ui/Canvas");module.exports={Img:Img,SetType:SetType};SetType("desk");function SetType(type){if(type=="desk"){var w=12;var h=16;setOpts({w:w,h:h,side:-w/2,top:-h,drawFn:curry(drawCurvedTail,w,h,{start1:{x:w/2,y:h/2},ctrl1:{x:w/2,y:h/1.3},point:{x:w,y:h},start2:{x:0,y:h/1.45},ctrl2:{x:w/4,y:h},wRatio:2})})}else if(type=="web-sdk"){var w=28;var h=28;setOpts({w:w,h:h,side:-w/2,top:-h,drawFn:curry(drawCurvedTail,w,h,{start1:{x:w/3,y:h/3},ctrl1:{x:w/3,y:h/1.3},point:{x:w/1.5,y:h},start2:{x:0,y:h/1.3},ctrl2:{x:w/4,y:h},wRatio:3})})}else if(type=="desk2"){var w=8;var h=10;var base=5;setOpts({w:w,h:h,side:0,top:-11,drawFn:curry(drawBlockTail,w,h,{base:base})})}}var opts;var scaleX;var translateX;var drawFn;function setOpts(_opts){opts=_opts;drawFn=opts.drawFn;translateX={right:0,left:-opts.w};scaleX={right:1,left:-1}}var imgURLCache={};function Img(color,align,styles){var cacheKey=color+"-"+align;if(!imgURLCache[cacheKey]){imgURLCache[cacheKey]=drawFn(color,align)}var styles={position:"relative",top:opts.top};styles[align]=opts.side/2;return div(H(0),style({float:align}),img(W(opts.w),H(opts.h),{src:imgURLCache[cacheKey]},style(styles)))}function drawCurvedTail(w,h,coords,color,align){return Canvas(w,h).Scale(scaleX[align]*2,1*2).Translate(translateX[align],0).MoveToPoint(0,0).AddLineToPoint(w/coords.wRatio,0).AddLineToPoint(coords.start1.x,coords.start1.y).AddQuadCurveToPoint(coords.ctrl1.x,coords.ctrl1.y,coords.point.x,coords.point.y).AddQuadCurveToPoint(coords.ctrl2.x,coords.ctrl2.y,coords.start2.x,coords.start2.y).Fill(color).DataURL()}function drawBlockTail(w,h,coords,color,align){return Canvas(w,h).Scale(scaleX[align]*2,1*2).Translate(translateX[align],0).MoveToPoint(0,0).AddLineToPoint(w,0).AddLineToPoint(w,h).AddLineToPoint(0,coords.base).AddLineToPoint(0,0).Fill(color).DataURL()}},{"asapp/ui/Canvas":17}],21:[function(require,module,exports){var events=require("asapp/data/events");var eventLogs=require("asapp/data/eventLogs");var schemes=require("asapp/apps/schemes");var textMetrics=require("asapp/ui/textMetrics");var conversationBubbleTail=require("asapp/ui/conversationBubbleTail");var Font=require("asapp/apps/Font");var selections=require("asapp/ui/selections");var translate=require("asapp/apps/web-sdk-iframe/translate").translate;schemes.MakeFactory(function(colors,icon){return{colors:colors,slot:{background:"#FBFCFC",borderRadius:4},bubble:{fromCustomer:{background:"#8F98AF",color:"white"},fromRep:{background:"#EDE8E8",color:"#393D47"}},scriptSuggestion:{background:"#fff",boxShadow:"0 0 0.5px -0.5px "+colors.solid,color:"black"},bubblePreview:{fromCustomer:{boxShadow:"0 0 5px -0.5px #8F98AF",color:"#393D47"}},icon:{src:icon,card:{src:icon,style:{width:32,height:32,borderRadius:32}},head:{src:icon,style:{width:44,height:44,borderRadius:44}}}}});var BubbleMaxWidth=260;var textBubbleMetrics;var infoBandMaxWidth=240;var infoBandMetrics;var fontDidLoad=false;var fontSize=13;Font.Pubsub.On("Done",function(){fontDidLoad=true;conversations.Font=Font.regular(fontSize);textBubbleMetrics=textMetrics.New(BubbleMaxWidth,conversations.Font.css);infoBandMetrics=textMetrics.New(infoBandMaxWidth,Font.bold(11).css)});var conversations=module.exports={RenderEventLog:RenderEventLog,RenderMessagePreview:RenderMessagePreview,RenderEvents:RenderEvents,ScrollToEvent:ScrollToEvent,GetEventForElement:GetEventForElement,Font:null};var lastEventTime=0;function ScrollToEvent(event){var el=document.getElementById(event.eventUid).parentNode;ScrollIntoView(el,{pad:10,scrollView:el.parentNode.parentNode});if(ScrollToEvent.currentEl){$(ScrollToEvent.currentEl).css({background:"transparent"})}ScrollToEvent.currentEl=el;$(ScrollToEvent.currentEl).css({background:"repeating-linear-gradient(45deg, #f2f2f2, #f2f2f2 10px, #e9e9e9 10px, #e9e9e9 20px)"})}var eventLogCmd=false;function RenderEventLog(eventLog,opts){eventLogCmd=true;lastEventTime=0;opts=defaults(opts||{},{isCustomerEventLog:eventLog.isCustomerEventLog});if(fontDidLoad){conversations.Font=Font.regular(fontSize);textBubbleMetrics=textMetrics.New(BubbleMaxWidth,conversations.Font.css);infoBandMetrics=textMetrics.New(infoBandMaxWidth,Font.bold(11).css)}return EventLogView({eventLog:eventLog,opts:opts})}var EventLogView=ui.ViewComponent("EventLogView",{mixins:[eventLogs.mixins.AfterEventProcessed(function(event,eventLog,isLive,isLastEvent){if(eventLog==this.props.eventLog&&isLastEvent){this.forceUpdate()}})],render:function(){return div(Bg("#FFF"),OnMouseDown(bind(this,this.onMouseDown)),OnMouseUp(bind(this,this.expandSelection)),OnKeyUp(bind(this,this.expandSelection)),OnKeyDown(bind(this,this.expandSelection)),RenderEvents(this.props.eventLog.Events(),this.props.opts),div(Clear),RenderMessagePreview(this.props.eventLog),div(H(30),Clear))},onMouseDown:function($e){if($e.ctrlKey||$e.metaKey||$e.altKey||$e.shiftKey){return}selections.Clear()},expandSelection:function(){var el=selections.CurrentElement();if(isTextMessageContent(el)){selections.ExpandToWordBoundaries()}}});function RenderEvents(events,opts){opts=defaults(opts||{},{highlightIssueId:null,linkify:true});if(opts.SelectedIssue){events=filter(events,function(event){return opts.SelectedIssue===event.IssueId})}return map(events,function(event,i){return EventView({events:events,event:event,prevEvent:events[i-1]||{},nextEvent:events[i+1]||{},opts:opts})})}var EventView=ui.ViewComponent("EventView",{shouldComponentUpdate:function(nextProps){return this.props.event.eventUid!=nextProps.event.eventUid||this.props.nextEvent.eventUid!=nextProps.event.eventUid},render:function(){var event=this.props.event;var info=this.computeRenderInfo();var highlightIssueId=this.props.opts.highlightIssueId;var shouldLowlight=highlightIssueId&&event.IssueId!=highlightIssueId;var prevTime=this.props.prevEvent.CreatedTime||0;var shouldShowTimestamp=event.CreatedTime-prevTime>30*time.Seconds&&!this.props.opts.isCustomerEventLog;return div(shouldLowlight&&[Opacity(.6),Bg("#E9E9EF")],shouldShowTimestamp&&this.renderTimestamp(),div({id:event.eventUid,key:event.eventUid},this.renderWrapper(info,this.renderContent(info)),Clear))},renderTimestamp:function(){return div(Font.bold(11),Clear,Color.Light(),TextAlign("center"),Pad(10),moment(this.props.event.date).format("MMM D, hh:mm A"))},computeRenderInfo:function(){var event=this.props.event;var eventType=event.EventType;var payload=event.payload;if(eventType==EventTypeTextMessage){var fromName=this.GetFromNameForEvent(event);return{contentSize:textBubbleMetrics.Measure(fromName+payload.Text),fromName:fromName}}else if(eventType==EventTypePictureMessage){return{contentSize:pictureBubbleSize(payload)}}else{return{}}},GetFromNameForEvent:function(event){if(!this.props.opts.isCustomerEventLog||this.props.opts.isCustomerEventLog==events.IsFromCustomer(event)){return""}for(var i=event.CustomerEventLogSeq-1;i>=0;i--){if(this.props.events[i].EventType==EventTypeNewRep){return this.props.events[i].payload.NewRep.Name+": "}else if(this.props.events[i].EventType==EventTypeIssueEnqueued||this.props.events[i].EventType==EventTypeNewIssue){break}}return"Rep: "},renderWrapper:function(info,content){if(this.isBubbleEvent(this.props.event)){var isFromCustomer=events.IsFromCustomer(this.props.event);var bubbleStyles=schemes(this.props.event).bubble;return div(renderBubbleWithStyles(bubbleStyles,isFromCustomer,info.contentSize,content,false,this.props.opts))}else{return div(content)}},renderContent:function(info){var event=this.props.event;var opts=this.props.opts;var payload=JSON.parse(event.EventJSON);if((event.EventFlags&EventFlagsRepTraining)==EventFlagsRepTraining){return}if(event.EventType&&(payload.Text=="[TouchID Authenticate]"||payload.Text=="[TouchID Authenticated]")){return null}switch(event.EventType){case EventTypeTextMessage:return renderTextMessageEvent(event,payload,opts,info);case EventTypeNewIssue:return renderNewIssueEvent(event,payload,opts,info);case EventTypeNewRep:return renderNewRepEvent(event,payload,opts,info);case EventTypePictureMessage:return renderPictureMessage(event,payload,opts,info);case EventTypePrivateNote:return renderPrivateNote(event,payload,opts,info);case EventTypeTopicChange:return renderTopicChange(event,payload,opts,info);case EventTypeConversationEnd:case EventTypeIssueEnqueued:return renderIssueEnqueued(event,payload,opts,info);case EventTypeCustomerTimedOut:return renderCustomerTimedOut(event,payload,opts,info);case EventTypeCustomerConversationEnd:return renderCustomerConversationEnd(event,payload,opts,info);case EventTypeWhisperMessage:return renderWhisperMessageEvent(event,payload,opts,info);case EventTypeCustomerFeedback:return renderCustomerFeedback(event,payload,opts,info);case EventTypeIPBlock:return renderIPBannedEvent(event,payload,opts,info);case EventTypePhoneNumberBlock:return renderPhoneNumberBannedEvent(event,payload,opts,info);default:return renderUnknownEvent(event,payload,opts,info)}},isVisibleEvent:function(event,opts){switch(event.EventType){case EventTypeTextMessage:return true;case EventTypeNewIssue:case EventTypePictureMessage:case EventTypePrivateNote:case EventTypeTopicChange:case EventTypeConversationEnd:case EventTypeIssueEnqueued:case EventTypeCustomerTimedOut:case EventTypeCustomerConversationEnd:return true;case EventTypeNewRep:if(opts.isCustomerEventLog){return false}else{return true}default:return false}},isBubbleEvent:function(event){return event.EventType==EventTypeTextMessage||event.EventType==EventTypePictureMessage},prevIsSameSide:function(){return this.isSameSide(this.props.event,this.props.prevEvent)},nextIsSameSide:function(){return this.isSameSide(this.props.event,this.props.nextEvent)},isSameSide:function(eventA,eventB){return events.IsFromCustomer(eventA)==events.IsFromCustomer(eventB)}});function pictureBubbleSize(payload){var width=Math.min(payload.PicWidth,BubbleMaxWidth);var ratio=width/payload.PicWidth;return{width:width,height:Math.floor(ratio*payload.PicHeight)}}function renderUnknownEvent(){return null}function RenderMessagePreview(eventLog,opts){opts=defaults(opts||{},{isCustomerEventLog:eventLog.isCustomerEventLog});var previewText=eventLog.CustomerTypingPreview;if(!previewText){return}var size=textBubbleMetrics.Measure(previewText);var content=el(style(size),conversations.Font,previewText);return[renderBubbleWithStyles(schemes(eventLog).bubblePreview,true,size,content,false,opts),div(H(6),Clear)]}function isTextMessageContent(el){var elEvent=GetEventForElement(el);return elEvent&&elEvent.EventType==EventTypeTextMessage}function renderBubbleWithStyles(bubbleStyles,isFromCustomer,contentSize,content,renderTail,opts){var styles=isFromCustomer?bubbleStyles.fromCustomer:bubbleStyles.fromRep;var align=isFromCustomer!=opts.isCustomerEventLog?"left":"right";return div(style({position:"relative"}),el({className:"enableSelect"},Float(align),!opts.isCustomerEventLog?align=="left"?Margin(0,0,1,12):Margin(0,12,1,0):null,style({wordWrap:"break-word",wordBreak:"break-word"}),div(content,W(contentSize.width),style(styles),align=="left"?Radius(14,14,14,0):Radius(14,14,0,14),contentSize.height>20?Pad(12,16):Pad(9,16,12)),renderTail?conversationBubbleTail.Img(styles.background,align):null))}function GetEventForElement(el){while(el&&!eventLogs.IsEventUid(el.id)){el=el.parentNode}return el?eventLogs.GetEventByEventUid(el.id):null}function renderIssueResolvedEvent(event,payload){return renderInfoBand(translate("More questions? Keep typing",opts.regionCode))}function renderCustomerConversationEnd(event,payload,opts){var message=opts.isCustomerEventLog?translate("More questions? Keep typing",opts.regionCode):"Customer ended conversation";return renderInfoBand(message)}function renderCustomerFeedback(event,payload,opts){if(opts.isCustomerEventLog){return renderInfoBand("Thank You for your feedback")}}linkify.regex=/\b(https?:\/\/\S+)\b/gi;function linkify(text){return map(text.split(linkify.regex),function(part){if(linkify.regex.test(part)){return a({href:part,target:"_blank"},part)}else{return part}})}function renderAnnotations(event){var text=event.payload.Text;div(Clear,Font.regular(11),Color("#888"),margin,Float(align),isFromCustomer?Margin(0,0,0,14):Margin(0,14,0,0),map(event.annotations,function(annotation){var str=text.substring(annotation.Start,annotation.End);return div(b(annotation.Type+": "),str)}))}function isAutoMessage(event){if(event.EventFlags&EventFlagsAutoGenerated){return true}return false}function renderTextMessageEvent(event,payload,opts,info){var size=textBubbleMetrics.Measure(info.fromName+payload.Text);var content=opts.linkify?linkify(payload.Text):payload.Text;if(opts.renderAnnotations&&event.annotations){content=[content,renderAnnotations(event)]}return el(conversations.Font,!isAutoMessage(event)?span(info.fromName,Color(opts.highlightColor?opts.highlightColor:"#333333")):null,content)}function renderPromptMessageEvent(event,payload,opts){var size=300;var content=opts.linkify?linkify(payload.Text):payload.Text;return div(FillW,style({textAlign:"center"}),div(W(size),Pad(10),style({textAlign:"center",color:"white",borderRadius:6,display:"inline-block",marginTop:30}),payload.Text))}function renderPictureMessage(event,payload,opts){var url=["https://"+payload.FileBucket+".s3.amazonaws.com/customer/",event.CustomerId,"/company/",event.CompanyId,"/",payload.FileSecret,"-",payload.PicWidth,"x",payload.PicHeight,".",payload.MimeType.split("/")[1]].join("");var width=Math.min(payload.PicWidth,BubbleMaxWidth);var ratio=width/payload.PicWidth;var contentSize={
width:width,height:Math.floor(ratio*payload.PicHeight)};var content=img({src:url},style(contentSize),style({marginTop:4}),Radius(8));if(payload.MimeType=="image/gif"){content=gifToggle({img:content,size:contentSize})}return content}var gifToggle=ui.ViewComponent("gifToggle",{getInitialState:function(){return{playing:false}},render:function(){return div(tappable(bind(this,this.toggle)),this.state.playing?this.props.img:div(H(this.props.size.height+7),FillW,style({position:"relative"}),el(Center(),Font.light(18),"GIF ▶")))},toggle:function(){this.setState({playing:!this.state.playing})}});function renderNewIssueEvent(event,payload,opts){var isFromCustomer=events.IsFromCustomer(event);return renderInfoBand(translate("Conversation started",opts.regionCode))}function renderIssueEnqueued(event,payload,info){var enqueueReason="Issue transfered";if(payload.PreviousRepName){enqueueReason+=" From "+payload.PreviousRepName}switch(payload.IssueQueueType){case IssueQueueTypeInbox:if(payload.PreviousRepName){return renderInfoBand(payload.PreviousRepName+" transferred issue to "+payload.CompanyGroupName)}else{return renderInfoBand("Issue transferred to "+payload.CompanyGroupName)}case IssueQueueTypeRepTimedOut:return renderInfoBand(payload.PreviousRepName+" timed out - issue transferred");case IssueQueueTypeCustomerActivated:return renderInfoBand("Customer resumed the conversation");default:return null}}function renderNewRepEvent(event,payload,opts){if(opts.isCustomerEventLog){return}var rep=payload.NewRep;if(!rep.Name){return null}var isMe=rep.RepId==gRep.RepId;return renderInfoBand("Issue accepted by "+(isMe?"you":rep.Name))}function renderTopicChange(event,payload){return renderInfoBand("Topic changed");return renderInfoBand("Topic set ",subjectName)}function renderPrivateNote(event,payload){var text=payload.Text;return div(Pad(10,0),div(Font.regular(14),Pad(10),Clear,style({color:"#666666",textAlign:"center"},bg("#e6e6e6")),span(Clear,style({color:"#999999"}),"Private note: "),text))}function renderWhisperMessageEvent(event,payload){var text=payload.Text;return div(Pad(10,0),div(Font.regular(14),Pad(10),Clear,style({color:"#666666",textAlign:"center"},bg("#e6e6e6")),span(Clear,style({color:"#999999"}),(payload.FromRep?payload.FromRep.Name:"Admin")+": "),text))}function renderInfoBand(content){var infoBandWidth=320;var infoBandContentWidth=infoBandMetrics.Measure(content).width;return div(FillW,style({textAlign:"center"}),div(W(infoBandWidth),Font.bold(11),Clear,style({color:"#8E8E93",position:"relative",display:"inline-block",paddingTop:10,paddingBottom:10}),div(H(7),span(Pos(15,20),H(1),W((infoBandWidth-infoBandContentWidth)/2-30),style({display:"inline-block",borderBottom:"1px dashed #CCC"})),span(W(infoBandContentWidth),style({paddingLeft:10,paddingRight:10}),content),span(Pos.tr(15,20),H(1),W((infoBandWidth-infoBandContentWidth)/2-30),style({display:"inline-block",borderBottom:"1px dashed #CCC"})))))}function renderCustomerTimedOut(){return renderInfoBand("Customer was timed out")}function renderRepTimedOut(payload){return renderInfoBand("Rep "+payload.RepName+" timed out")}function renderIPBannedEvent(event,payload){return renderInfoBand("Customer IP-Address was banned")}function renderPhoneNumberBannedEvent(event,payload){return renderInfoBand("Customer Phone Number was banned")}},{"asapp/apps/Font":1,"asapp/apps/schemes":2,"asapp/apps/web-sdk-iframe/translate":4,"asapp/data/eventLogs":11,"asapp/data/events":12,"asapp/ui/conversationBubbleTail":20,"asapp/ui/selections":30,"asapp/ui/textMetrics":33}],22:[function(require,module,exports){ui=require("./ui");require("asapp/ui/tags-globals");Font=require("asapp/apps/Font");Nav=require("asapp/ui/nav/urlNav");time=require("asapp/data/time");Layout=require("./layout/Layout");Colors=require("./colors/Colors");rgb=function(r,g,b){return"rgb("+[r,g,b].join(",")+")"};rgba=function(r,g,b,a){return"rgba("+[r,g,b,a].join(",")+")"};require("asapp/data/constants");loadingMessage=function(msg){return div(msg||"Loading...",style({padding:px(4,8),color:"grey",textAlign:"center",display:"inline-block"}))};FootHeight=82;HeadHeight=82;LeftPaneWidth=284;RightPaneWidth=340;showError=function(){_showTopBanner("rgba(229, 77, 66, 0.75)",arguments)};showBanner=function(){_showTopBanner("rgba(229, 196, 66, 0.75)",arguments)};hideBanner=function(){$("#appMsgBanner").remove()};bannerShowing=function(){return $("#appMsgBanner").length!=0};_showTopBanner=function(bg,args){var msg=map(args,function(arg){return _.isString(arg)?arg:JSON.stringify(arg)}).join("\n");hideBanner();var el=document.createElement("div");el.id="appMsgBanner";var styles={cursor:"pointer",width:"100%",background:bg,color:"white",position:"absolute",top:0,left:0,zIndex:9999999,padding:40,textShadow:"0 1px 0px rgba(0,0,0,.25)"};$(el).css(styles).text(msg).on("click",function(){hideBanner()});$(document.body).append(el)};radius=function(){return{borderRadius:px.apply(this,arguments)}};className=function(){return{className:Array.prototype.join.call(arguments," ")}};padding=function(){return{padding:px.apply(this,arguments)}};key=function(name,id){return{key:name+"-"+id}};margin=function(){return{margin:px.apply(this,arguments)}};TextAlign=function(textAlign){return style({textAlign:textAlign})};LetterSpacing=function(letterSpacing){return style({letterSpacing:letterSpacing})};CharacterSpacing=LetterSpacing;Overflow=function(overflow){return style({overflow:overflow})};bold={fontWeight:400};light={fontWeight:200};ultraLight={fontWeight:100};italic={fontStyle:"italic"};absolute={position:"absolute"};isReactObj=function(){return function(arg){return arg&&!!(arg["$$typeof"]||arg._isReactElement)}}();function _addClass(attrs,className){if(!attrs.className){attrs.className=className}else{attrs.className+=" "+className}}function hasClass(el,className){return el.classList.contains(className)}buttonClass={className:"button"};buttonAltClass={className:"button alternative"};buttonThirdClass={className:"button thirdary"};tappable=function(callback){return function(attrs){attrs.onClick=function(e){if(hasClass(e.currentTarget,"disabled")){return}callback.apply(this,arguments)};_addClass(attrs,"tappable")}};link=function(handler){return[tappable(handler),style({textDecoration:"underline",color:"blue"})]};onChange=function(callback){return{onChange:callback}};onSubmit=function(callback){return{onSubmit:callback}};id=function(id){return{id:id}};px=function(){return Array.prototype.slice.call(arguments).join("px ")+"px"};bg=function(color){return{backgroundColor:color}};camelCaseConvert=function(text){return text.replace(/([A-Z])/g," $1")};SelectedBg="#0B73C1";HighlightBg="#BEBEBE";IssueListBg="#364149";TextDark="#3d464d";TextHighlight="#0A5DC3";White="#FEFCFE";Black="#000003";TextLight=White;_pad=function(num){return num<10?"0"+num:num};statsStyle={overflow:"hidden",display:"inline-block"};formatTime=function(timestamp){if(!timestamp){return"N/A"}return moment(timestamp/time.millisecond).format("MMM D YYYY, h:mma")};padNumber=function(num){if(num<0){num=0}return num<10?"0"+num:num};List=function(list,renderFn,noneFn){if(!list){return div(loadingMessage())}if(!list.length){return noneFn?noneFn():div("None")}return div(map(list,renderFn))};Table=function(list,properties){return table(thead(map(properties,function(_,label){return th(label)})),tbody(map(list,function(listItem){return tr(map(properties,function(renderFn,label){return td(renderFn(listItem))}))})))};ButtonStyles=[Shadow(1),Radius(4),Color("#FFF"),style({textAlign:"center"})];Font.Pubsub.On("DidLoad",function(){ButtonStyles.push(Font.Condensed.bold(12))});ScrollIntoView=function(el,opts){opts=defaults(opts,{pad:0,scrollView:el.parentNode});var scrollView=opts.scrollView;var viewBottom=scrollView.scrollTop+scrollView.offsetHeight;var elBottom=el.offsetTop+el.offsetHeight;if(el.offsetTop<scrollView.scrollTop){var delta=scrollView.scrollTop-el.offsetTop;scrollView.scrollTop-=delta+opts.pad}else if(elBottom>viewBottom){var delta=elBottom-viewBottom;scrollView.scrollTop+=delta+opts.pad}};inputPrompts=require("asapp/ui/inputPrompts")},{"./colors/Colors":18,"./layout/Layout":25,"./ui":34,"asapp/apps/Font":1,"asapp/data/constants":10,"asapp/data/time":13,"asapp/ui/inputPrompts":23,"asapp/ui/nav/urlNav":28,"asapp/ui/tags-globals":32}],23:[function(require,module,exports){require("asapp/ui/globals");var lightbox=require("asapp/ui/lightbox");module.exports={CollectAndTrim:CollectAndTrim,Confirm:Confirm};function CollectAndTrim(inputs,callback){CollectAndTrim.callback=callback;lightbox.Show({closable:true,OnEnter:function(){submitCollectAndTrim(inputs)},content:CollectInputsLightbox({inputs:inputs})})}var buttonStyles=[Margin(8,8),W(120),ButtonStyles];var CollectInputsLightbox=ui.ViewComponent("CollectInputsLightbox",{componentDidMount:function(){$("#CollectInputsLightbox input")[0].select()},render:function(){return div(id("CollectInputsLightbox"),table(tbody(map(this.props.inputs,bind(this,function(value,label){return tr(td(style({textAlign:"right",border:"none"}),label,":"),td(style({textAlign:"left",border:"none"}),input({id:getIdForLabel(label),defaultValue:value||""},Pad(6,4))))})))),div(style({textAlign:"center"}),Button("OK",Bg("#42B452"),buttonStyles,tappable(bind(this,function(){submitCollectAndTrim(this.props.inputs)}))),div(Clear)))}});function getIdForLabel(label){return label.replace(/\W/g,"_")}function getValue(label){return document.getElementById(getIdForLabel(label)).value}function submitCollectAndTrim(inputs){var result={};for(var label in inputs){var val=getValue(label).trim();if(!val){return}result[label]=val}lightbox.Hide();CollectAndTrim.callback(result);CollectAndTrim.callback=null}function Confirm(message,yesNoText,_callback){var callback=function(confirmed){lightbox.Hide();_callback(confirmed)};lightbox.Show({closable:true,OnEnter:function(){callback(true)},content:ConfirmLightbox({message:message,yesNoText:yesNoText,callback:callback})})}var ConfirmLightbox=ui.ViewComponent("ConfirmLightbox",{render:function(){return div(div(this.props.message),div(style({textAlign:"center"}),Button(this.props.yesNoText[0],Bg("gray"),buttonStyles,tappable(bind(this,function(){this.props.callback(false)}))),Button(this.props.yesNoText[1],Bg("#42B452"),buttonStyles,tappable(bind(this,function(){this.props.callback(true)})))))}})},{"asapp/ui/globals":22,"asapp/ui/lightbox":27}],24:[function(require,module,exports){var pubsub=require("asapp/util/pubsub").New();var selections=require("asapp/ui/selections");var keyboard=module.exports=extend(pubsub,{CharCode:{IsNumeric:IsNumeric},mixins:{CmdNumber:CmdNumberMixin,CmdChar:CmdCharMixin,CmdPlus:CmdPlusMixin,CmdMinus:CmdMinusMixin,KeyPress:KeyPressMixin,OnEscape:EscapeMixin,OnEnter:EnterMixin},Cmd:function(key,fn){assert(!shortcuts.cmd[key]);shortcuts.cmd[key]=fn}});var shortcuts={cmd:{}};keyboard.On("CmdChar",function($e,key){var fn=shortcuts.cmd[key.toLowerCase()];if(fn){fn()}});function pubsubHandlerMixin(pubsub,signal,handler){var prop="__pubsubHandler_"+signal;return{componentWillMount:function(){this[prop]=pubsub.On(signal,bind(this,handler))},componentWillUnmount:function(){pubsub.Off(this[prop])}}}function CmdNumberMixin(handler){return pubsubHandlerMixin(pubsub,"CmdNumber",handler)}function CmdPlusMixin(handler){return pubsubHandlerMixin(pubsub,"CmdPlus",handler)}function CmdMinusMixin(handler){return pubsubHandlerMixin(pubsub,"CmdMinus",handler)}function KeyPressMixin(handler){return pubsubHandlerMixin(pubsub,"KeyPress",handler)}function EscapeMixin(handler){return pubsubHandlerMixin(pubsub,"EscapeKeyDown",handler)}function EnterMixin(handler){return pubsubHandlerMixin(pubsub,"EnterKeyDown",handler)}function CmdCharMixin(handler){return pubsubHandlerMixin(pubsub,"CmdChar",handler)}function IsNumeric(charCode){return charCode>=charToCharCode["0"]&&charCode<=charToCharCode["9"]}var charToCharCode={};var charCodeToChar={};each(range(0,999),function(charCode){charToCharCode[String.fromCharCode(charCode)]=charCode;charCodeToChar[charCode]=String.fromCharCode(charCode)});var keyCodes={escape:27,enter:13};$(document).on("keydown",function onKeyDown($e){if($e.ctrlKey||$e.metaKey||$e.altKey){if(IsNumeric($e.keyCode)){var number=$e.keyCode-charToCharCode["0"];pubsub.Fire("CmdNumber",$e,number)}if($e.keyCode==189){pubsub.Fire("CmdMinus",$e)}if($e.keyCode==187){pubsub.Fire("CmdPlus",$e)}pubsub.Fire("CmdChar",$e,charCodeToChar[$e.keyCode])}if($e.keyCode==keyCodes.escape){pubsub.Fire("EscapeKeyDown",$e)}else if($e.keyCode==keyCodes.enter){pubsub.Fire("EnterKeyDown",$e)}});$(document).on("keypress",function onKeyPress($e){pubsub.Fire("KeyPress",$e)})},{"asapp/ui/selections":30,"asapp/util/pubsub":36}],25:[function(require,module,exports){module.exports=Layout;function Layout(parent){if(Layout.isLayout(parent)){}else if(parent.props.layout){parent=parent.props.layout}return create(Layout.base,{_parent:parent,_styles:{position:"absolute",left:0,top:0,width:parent._styles.width,height:parent._styles.height}})}Layout.isLayout=function(obj){return Layout.base.isPrototypeOf(obj)};Layout.base={below:function(other){this._styles.top=Math.max(0,other._styles.top+other._styles.height);return this},rightOf:function(other){this._styles.left=Math.max(0,other._styles.left+other._styles.width);return this},fillRightOf:function(other){var w=Math.max(0,this._parent.w()-(other.w()+other._styles.left));return this.w(w).rightOf(other)},fillAbove:function(other){if(other._styles.top){var h=Math.max(0,other._styles.top)}else{h=Math.max(0,this._parent.h()-(other.h()+other._styles.bottom))}return this.h(h).above(other)},fillBelow:function(other){var h=Math.max(0,this._parent.h()-(other.h()+other._styles.top));return this.h(h).below(other)},above:function(other){this._styles.top=Math.max(0,other.y()-this.h());return this},wh:function(width,height){return this.w(width).h(height)},w:function(w){if(arguments.length==0){return this._styles.width}this._styles.width=w._styles?w._styles.width:w;return this},h:function(h){if(arguments.length==0){return this._styles.height}this._styles.height=h._styles?h._styles.height:h;return this},bottom:function(bottom){this._styles.bottom=bottom;delete this._styles.top;return this},x:function(x){if(arguments.length==0){return this._styles.left}this._styles.left=x._styles?x._styles.x:x;return this},y:function(y){if(arguments.length==0){if(this._styles.top){return this._styles.top}if(typeof this._styles.bottom!=="undefined"){return this._parent.h()-this._styles.height}}this._styles.top=y._styles?y._styles.y:y;return this},centerV:function(){this._styles.top=Math.floor(this._parent.h()/2-this.h()/2);return this},centerH:function(){this._styles.left=Math.floor(this._parent.w()/2-this.w()/2);return this},center:function(){return this.centerV().centerH()},inset:function(top,right,bottom,left){if(arguments.length==1){right=bottom=left=top}if(arguments.length==2){left=right;bottom=top}this._styles.width-=left+right;this._styles.height-=top+bottom;this._styles.left=left;this._styles.top=top;return this},style:function(){return style(this._styles)}}},{}],26:[function(require,module,exports){require("asapp/ui/globals");var ViewportLayout=module.exports=ui.ViewComponent("ViewportLayout",{mixins:[ui.mixins.ObserveWindowSize(function(size){var layout=create(Layout.base,{_parent:null,_styles:{position:"absolute",left:0,top:0,width:size.width,height:size.height}});this.setState({layout:layout})})],render:function(){return this.props.ViewportContent(this.state.layout)}})},{"asapp/ui/globals":22}],27:[function(require,module,exports){var ui=require("asapp/ui/ui");var keyboard=require("asapp/ui/keyboard");var lightbox=module.exports={Show:Show,Hide:Hide};function Hide(){if(instance){instance.hide()}}function Show(props,callback){Hide();var el=document.body.appendChild(document.createElement("div"));props=defaults(props,{showing:true,closable:true,content:"Lightbox content",el:el});instance=ReactDOM.render(Lightbox(props),el,callback)}var instance;var Lightbox=ui.ViewComponent("Lightbox",{mixins:[keyboard.mixins.OnEnter(function($e){if(this.props.OnEnter){$e.preventDefault();this.props.OnEnter()}}),keyboard.mixins.OnEscape(function(){lightbox.Hide()})],render:function(){var size={width:$(window).width(),height:$(window).height()};return div(Pos(0,0),W(size.width),H(size.height),Z(999999),div(Pos(0,0),Fill,Bg("rgba(0,0,0,.45)"),this.props.closable?tappable(bind(this,function(){this.hide()})):null),div(Pos.Center,Bg("white"),style({display:"inline-block",borderRadius:8,padding:px(8,16)}),Shadow(2),this.props.content))},hide:function(){if(!this.props.el){return}React.unmountComponentAtNode(this.props.el);$(this.props.el).remove();this.props.el=null;instance=null}})},{"asapp/ui/keyboard":24,"asapp/ui/ui":34}],28:[function(require,module,exports){var pubsub=require("asapp/util/pubsub").New();var urlNav=module.exports=extend(pubsub,{pushView:pushView,popView:popView,setView:setView,mixins:{SingleLevelStringNav:SingleLevelStringNavMixin,MultiLevelJSONNav:MultiLevelJSONNavMixin,MultiLevelIDNav:MultiLevelIDNavMixin}});function SingleLevelStringNavMixin(){return{componentWillMount:function(){this._navLevel=bumpLevel();this._navObsId=urlNav.On("Changed",bind(this,this.onNavChanged));this.updateSingleLevelNavState()},componentWillUnmount:function(){popLevel(this._navLevel);urlNav.Off(this._navObsId)},onNavChanged:function(){this.updateSingleLevelNavState();this.forceUpdate()},updateSingleLevelNavState:function(){this._navStr=getParts()[this._navLevel]},SetNavString:function(str){setPart(this._navLevel,str)},GetNavString:function(){return this._navStr}}}function MultiLevelJSONNavMixin(){return{componentWillMount:function(){this._navLevel=bumpLevel();this._navObsId=urlNav.On("Changed",bind(this,this.onNavChanged));this.updateMultiLevelNavState()},componentWillUnmount:function(){popLevel(this._navLevel);urlNav.Off(this._navObsId)},onNavChanged:function(){this.updateMultiLevelNavState();this.forceUpdate()},updateMultiLevelNavState:function(){console.log("TODO: MAKE CHANGE LEVEL SENSITIVE");var parts=getParts();if(parts.length<=this._navLevel){this._navView=null}else{var kvp=last(parts).split(":");var viewName=kvp[0];var propsJSON=kvp[1];var props=propsJSON?JSON.parse(decodeURIComponent(propsJSON)):{};this._navView=ui.ViewComponents[viewName](props)}},GetNavView:function(){return this._navView}}}function MultiLevelIDNavMixin(){return{componentWillMount:function(){this._navLevel=bumpLevel();this._navObsId=urlNav.On("Changed",bind(this,this.onNavChanged));this.updateMultiLevelNavState()},componentWillUnmount:function(){popLevel(this._navLevel);urlNav.Off(this._navObsId)},onNavChanged:function(){this.updateMultiLevelNavState();this.forceUpdate()},updateMultiLevelNavState:function(){console.log("TODO: MAKE CHANGE LEVEL SENSITIVE");var parts=getParts();if(parts.length<=this._navLevel){this._navView=null}else{var kvp=last(parts).split(":");var viewName=kvp[0];var propsJSON=kvp[1];var props=propsJSON?JSON.parse(decodeURIComponent(propsJSON)):{};this._navView=ui.ViewComponents[viewName](props)}},GetNavView:function(){return this._navView}}}function setPart(level,part){var parts=getParts().slice(0,level);parts[level]=part;setParts(parts)}function getParts(){return location.hash.substr(2).split("/")}function setParts(parts){location.hash="#/"+parts.join("/")}function pushView(view){location.hash+="/"+viewPathPart(view)}function popView(){var parts=location.hash.substr(1).split("/");parts.pop();setParts(parts)}function setView(level,view){var parts=location.hash.substr(1).split("/");parts=parts.slice(0,level-1);parts.push(viewPathPart(view));setParts(parts)}var currentNavLevel=0;function bumpLevel(){var level=currentNavLevel;currentNavLevel+=1;return level}function popLevel(expectedCurrentLevel){if(currentNavLevel-1!=expectedCurrentLevel){throw new Error("Bad current nav level")}currentNavLevel-=1}function viewPathPart(view){var propsJSON=JSON.stringify(view.props);return view.type.displayName+":"+encodeURIComponent(propsJSON)}window.addEventListener("hashchange",function(){urlNav.Fire("Changed")})},{"asapp/util/pubsub":36}],29:[function(require,module,exports){require("asapp/util/util-globals");require("asapp/ui/globals");var Canvas=require("asapp/ui/Canvas");var conn=require("asapp/net/conn");var SVGButton=require("asapp/ui/controls/SVGButton");var Segment=require("asapp/misc/segment");var starImgURLCache={};module.exports=ui.ViewComponent("ConversationRating",{mixins:[eventLogs.mixins.AfterEventProcessed(function(event){if(event.EventType==EventTypeConversationRated){this.updateRating()}})],updateRating:function(){this.setState({selectIndex:this.getRatingIndex()})},getRatingIndex:function(){var eventLog=clientState.CurrentEventLog();if(!eventLog){return-1}var rating=eventLog.GetLatestRatingForCurrentIssue();if(rating){if(this.props.type=="thumbs"){return rating.ThumbRating}}return-1},getInitialState:function(){return{hoverIndex:-1,selectIndex:this.getRatingIndex()}},render:function(){var drawFn=curry(this.drawStar);if(!starImgURLCache["gray"]){starImgURLCache["gray"]=drawFn("#cccccc")}if(!starImgURLCache["yellow"]){starImgURLCache["yellow"]=drawFn("#ffd700")}var ratings=this.renderStars();if(this.props.type=="thumbs"){ratings=this.renderThumbs()}return div(ratings)},renderStars:function(){return div(this.renderStar(0),this.renderStar(1),this.renderStar(2),this.renderStar(3),this.renderStar(4))},renderThumbs:function(){return div(this.renderThumb("up"),div(H(18*this.props.scale),W(this.props.scale*10),style({display:"inline-block"})),this.renderThumb("down"))},renderThumb:function(direction){var path="webSDK/thumbs"+direction;var className=direction==="up"?"icon-thumbsup":"icon-thumbsdown";var color=this.props.color;var thumbRating=direction=="up"?1:2;var selected=false;if(thumbRating==this.state.selectIndex){selected=true;color=this.props.colorHover}return span(selected?style({color:color}):"",{id:"ASAPPChatRatingThumb"+direction,className:className,onClick:bind(this,function(){var params={ThumbRating:thumbRating};this.rateConversation(params,thumbRating)})})},renderStar:function(index){return img(W(20),H(20),{src:starImgURLCache[index>this.state.hoverIndex&&index>this.state.selectIndex?"gray":"yellow"],onMouseOver:bind(this,function(){this.setState({hoverIndex:index})}),onMouseOut:bind(this,function(){this.setState({hoverIndex:-1})})},tappable(bind(this,function(){var params={FiveStarRating:index+1};this.rateConversation(params,index)})))},rateConversation:function(params,index){Conn.Request("customer/RateConversation",params,bind(this,function(){this.setState({selectIndex:index});var eventLog=clientState.CurrentEventLog();var issueId=eventLog?eventLog.IssueId:0;var thumbRating=params.ThumbRating==ThumbRatingUp?"Thumbs Up":"Thumbs Down";Segment.track("Submit Feedback - Vote",{conversation_id:issueId,agent_id:event.RepId,feedback_type:thumbRating})}))},drawStar:function(color){var side=10;var angleDelta=72;return Canvas(20,20).Scale(2,2).Translate(side,side).MoveToPoint(side*Math.sin(angleDelta*0*(3.14/180)),side*Math.cos(angleDelta*0*(3.14/180))).AddLineToPoint(side*Math.sin(angleDelta*2*(3.14/180)),side*Math.cos(angleDelta*2*(3.14/180))).AddLineToPoint(side*Math.sin(angleDelta*4*(3.14/180)),side*Math.cos(angleDelta*4*(3.14/180))).AddLineToPoint(side*Math.sin(angleDelta*(3.14/180)),side*Math.cos(angleDelta*(3.14/180))).AddLineToPoint(side*Math.sin(angleDelta*3*(3.14/180)),side*Math.cos(angleDelta*3*(3.14/180))).AddLineToPoint(side*Math.sin(angleDelta*0*(3.14/180)),side*Math.cos(angleDelta*0*(3.14/180))).Fill(color).DataURL()}})},{"asapp/misc/segment":14,"asapp/net/conn":15,"asapp/ui/Canvas":17,"asapp/ui/controls/SVGButton":19,"asapp/ui/globals":22,"asapp/util/util-globals":39}],30:[function(require,module,exports){var store=require("asapp/util/store").New();var selections=module.exports={Get:Get,Set:Set,Clear:Clear,CurrentElement:CurrentElement,ExpandToWordBoundaries:ExpandToWordBoundaries,IsFocusControl:IsFocusControl,IsInput:IsInput,mixins:{ObserveSelection:ObserveSelectionMixin}};function ObserveSelectionMixin(callback){var obsId;return{componentWillMount:function(){obsId=store.Observe("selection",bind(this,callback))},componentWillUnmount:function(){store.Remove(obsId)}}}function Clear(){if(document.selection){document.selection.empty()}else{window.getSelection().removeAllRanges()}}function CurrentElement(){if(document.selection){var range=document.selection.createRange();return range&&range.parentElement()}else{var sel=window.getSelection();return sel.type=="None"?null:sel.anchorNode.parentNode}}function IsFocusControl(el){var tag=el.tagName;return tag=="INPUT"||tag=="TEXTAREA"||tag=="SELECT"||$(el).parents(".Select").length}function IsInput(el){return el.tagName=="INPUT"||el.tagName=="TEXTAREA"}function ExpandToWordBoundaries(){var el=CurrentElement();if(!el){return}var sel=Get(el);var textUpToSelectionStart=sel.fullText.substring(0,sel.start);var textFromSelectionEnd=sel.fullText.substring(sel.end);var breakEnd=sel.end;var match=textFromSelectionEnd.match(/^\w+\b/);if(match){breakEnd+=match[0].length}var breakStart=sel.start;var match=textUpToSelectionStart.match(/\w+$/);if(match){breakStart-=match[0].length}Set(el,breakStart,breakEnd)}function Get(el){var result={start:0,end:0,length:0,el:el,fullText:IsInput(el)?el.value:$(el).text(),selectedText:""};if(el.setSelectionRange){result.start=el.selectionStart;result.end=el.selectionEnd}else{var sel=window.getSelection();if(sel.type!="None"){result.start=window.getSelection().getRangeAt(0).startOffset;result.end=window.getSelection().getRangeAt(0).endOffset}}result.selectedText=result.fullText.substr(result.start,result.end);result.length=result.end-result.start;return result}function Set(el,start,end){if(!start){start=0}if(!end){end=start}if(el.setSelectionRange){el.setSelectionRange(start,end||start)}else{var range=document.createRange();var child=el.childNodes[0];if(child){range.setStart(child,start);range.setEnd(child,end);var winSel=window.getSelection();winSel.removeAllRanges();winSel.addRange(range)}else{el.focus()}}store.Set("selection",Get(el))}},{"asapp/util/store":37}],31:[function(require,module,exports){var pubsub=require("asapp/util/pubsub").New();require("asapp/util/util-globals");module.exports=extend(pubsub,{Load:Load,RequestFontParams:RequestFontParams});var weightNames={100:["ultraLight"],200:["extraLight"],300:["light"],400:["normal","regular"],500:["medium"],600:["bold"],700:["extraBold"],800:["ultraBold","black"],900:["megaBold"]};function Load(params,_callback){if(typeof WebFontConfig!="undefined"){throw new Error("WebFontConfig already exists in Font.Load")}var fontInfos=params.fonts;var result={};each(fontInfos,function(info,name){if(result[name]){throw new Error('Font name "'+name+'" already taken')}var familyName=info.familyName||name;var defaultWeight=info.defaultWeight||300;result[name]=makeFontFunction(familyName,defaultWeight);each(info.weights,function(weight){each(weightNames[weight],function(weightName){result[name][weightName]=makeFontFunction(familyName,weight)})});function makeFontFunction(familyName,fontWeight){return function(size,more){var css={fontFamily:familyName,fontWeight:fontWeight,fontSize:size};var res=style(extend(css,more));res.css=css;return res}}});var callback=function(){if(callback._called){return}callback._called=true;_callback.apply(this,arguments);pubsub.Fire("Done")};setTimeout(function(){callback("Loading fonts timed out",result)},params.timeout||3e3);WebFontConfig={google:{families:map(fontInfos,function(info,name){var familyName=info.familyName||name;var weights=info.weights.concat(info.loadItalics==false?[]:map(info.weights,function(weight){return weight+"italic"}));var characterSets=info.characterSets||["latin"];return[familyName.replace(/ /g,"+"),weights.join(","),characterSets.join(",")].join(":")})},active:function(){callback(null,result);pubsub.Fire("DidLoad")}};var wf=document.createElement("script");wf.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js";wf.type="text/javascript";wf.async="true";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(wf,s)}function info(name){return{familyName:name,weights:[100,200,300,400,500,600,700,800,900]}}function RequestFontParams(){return{timeout:500,fonts:{Lato:info("Lato"),Condensed:info("Roboto Condensed")}}}},{"asapp/util/pubsub":36,"asapp/util/util-globals":39}],32:[function(require,module,exports){require("asapp/util/util-globals");MakeDomGenerator=makeDomGenerator;div=makeDomGenerator("div");span=makeDomGenerator("span");form=makeDomGenerator("form");input=makeDomGenerator("input");textarea=makeDomGenerator("textarea");img=makeDomGenerator("img");br=makeDomGenerator("br");p=makeDomGenerator("p");ul=makeDomGenerator("ul");li=makeDomGenerator("li");h2=makeDomGenerator("h2");h3=makeDomGenerator("h3");h4=makeDomGenerator("h4");h5=makeDomGenerator("h5");table=makeDomGenerator("table");thead=makeDomGenerator("thead");tbody=makeDomGenerator("tbody");tr=makeDomGenerator("tr");th=makeDomGenerator("th");td=makeDomGenerator("td");select=makeDomGenerator("select");option=makeDomGenerator("option");a=makeDomGenerator("a");svg=makeDomGenerator("svg");b=makeDomGenerator("b");object=makeDomGenerator("object");hr=makeDomGenerator("hr");style=function(){var args=arguments;return function applyStyles(props,children){for(var i=0;i<args.length;i++){var arg=args[i];for(var key in arg){props.style[key]=arg[key]}}}};Ellipsis=Elipsis=function(){return style({whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"})};MaxWidth=function(maxWidth){return style({maxWidth:maxWidth})};MaxHeight=function(maxHeight){return style({maxHeight:maxHeight})};MinWidth=function(minWidth){return style({minWidth:minWidth})};MinHeight=function(minHeight){return style({minHeight:minHeight})};Pos=extend(function topLeft(top,left){return style({position:"absolute",top:top,left:left||0})},{x:function(x){return style({position:"absolute",left:x})},y:function(y){return style({position:"absolute",top:y})},tr:function topRight(top,right){return style({position:"absolute",top:top,right:right||0})},br:function botRight(bottom,right){return style({position:"absolute",bottom:bottom,right:right||0})},bl:function botLeft(bottom,left){return style({position:"absolute",bottom:bottom,left:left||0})},Center:extend(function(){return style({position:"relative",left:"50%",top:"50%",transform:"translateY(-50%) translateX(-50%)"})},{V:function(){return style({position:"relative",top:"50%",transform:"translateY(-50%)","-ms-transform":"translateY(-50%)"})},H:function(){return style({position:"relative",left:"50%",transform:"translateX(-50%)"})},Y:function(){return Pos.Center.V()},X:function(){return Pos.Center.H()}})});Center=Pos.Center;Center.v=Center.V;Center.h=Center.H;Size=function(width,height){if(arguments.length==1){height=width}return style({width:width,height:height})};W=function(width){return style({width:width})};H=function(height){return style({height:height})};Z=function(zIndex){return style({zIndex:zIndex})};p100="100%";FillH=style({height:p100});FillW=style({width:p100});Fill=[FillW,FillH];Bg=function(col){return style({background:col})};Z=function(zIndex){return style({zIndex:zIndex})};Pad=function(){return style({padding:px.apply(this,arguments)})};Color=function(color){return style({color:color})};TextShadow=function(xOffset,yOffset,spread,color){if(typeof color=="number"){color=rgba(0,0,0,color)}return style({textShadow:[xOffset+"px",yOffset+"px",spread+"px",color].join(" ")})};Underline=function(){return style({textDecoration:"underline"})};Border=function(borderStyles){return style({border:borderStyles})};BoxShadow=function(boxShadowStyles){return style({boxShadow:boxShadowStyles})};Scrollable=style({overflow:"auto",overflowScrolling:"touch"});Scrollable.Y=Scrollable.y=style({overflowY:"auto",overflowScrollingY:"touch",overflowX:"hidden"});Scrollable.X=Scrollable.x=style({
overflowX:"auto",overflowScrollingX:"touch",overflowY:"hidden"});Scrollable.None=style({overflowX:"hidden",overflowY:"hidden"});Shadow=function(level){var levels=[null,[3,0,0],[5,1,3]];var l=levels[level];var shadows=slice(arguments,1);if(!l&&!shadows.length){return null}shadows.unshift("0 0 "+l[0]+"px 0 rgba(0,0,0,.15)");shadows.unshift("0 "+l[1]+"px "+l[2]+"px 0 rgba(0,0,0,.35)");return style({boxShadow:shadows.join(", "),zIndex:level})};OnChange=function(callback){return{onChange:callback}};OnFocus=function(callback){return{onFocus:callback}};OnBlur=function(callback){return{onBlur:callback}};OnSubmit=function(callback){return{onSubmit:callback}};OnKeyPress=function(callback){return{onKeyPress:callback}};OnKeyDown=function(callback){return{onKeyDown:callback}};OnKeyUp=function(callback){return{onKeyUp:callback}};OnKey=function(callback){return{onKeyDown:function($e){if(shouldFireOnKeyOnKeyDownKeyCode[$e.keyCode]){callback($e)}},onKeyPress:function($e){callback($e)}}};OnPaste=function(callback){return{onPaste:function($e){callback($e)}}};OnSelect=function(callback){return{onSelect:function($e){callback($e)}}};OnMouseUp=function(callback){return{onMouseUp:function($e){callback($e)}}};OnMouseDown=function(callback){return{onMouseDown:function($e){callback($e)}}};OnEnter=function(callback){return{onKeyDown:function($e){if(KeyCodes.IsEnterKeyEvent($e)){callback($e)}}}};KeyCodes={Escape:27,Left:37,Up:38,Right:39,Down:40,IsMovementKeyEvent:function($e){return movementKeyCodes[$e.keyCode]},IsEnterKeyEvent:function($e){return $e.which==13}};var movementKeyCodes={};each([KeyCodes.Down,KeyCodes.Up,KeyCodes.Left,KeyCodes.Right],function(keyCode){movementKeyCodes[keyCode]=true});var shouldFireOnKeyOnKeyDownKeyCode={};each([KeyCodes.Down,KeyCodes.Up,KeyCodes.Left,KeyCodes.Right,8,46],function(keyCode){shouldFireOnKeyOnKeyDownKeyCode[keyCode]=true});Button=function(label){if(typeof label!="string"){throw new Error("Button called without a string label")}var rest=slice(arguments,1);return el(el(Pos.Center.V,label),H(24),W(80),Shadow(1),Font.Condensed(12),style({color:"#fff",textAlign:"center",borderRadius:4,WebkitPerspective:1e3}),rest)};FloatLeft=style({float:"left"});FloatRight=style({float:"right"});Clear=style({clear:"both"});Opacity=function(opacity){return style({opacity:opacity})};Margin=function(){return style({margin:px.apply(this,arguments)})};Float=function(where){return style({float:where})};Radius=function(){return style({borderRadius:px.apply(this,arguments)})};Position=function(position,top,left){var styles={position:position};if(top!=undefined){styles["top"]=top}if(left!=undefined){styles["left"]=left}return style(styles)};Translate=function(x,y,z){if(typeof x!="string"){x=(x||0)+"px"}if(typeof y!="string"){y=(y||0)+"px"}if(typeof z!="string"){z=(z||0)+"px"}return style({transform:"translateX("+x+") translateY("+y+") translateZ("+z+")"})};Translate.x=Translate.X=function(x){return Translate(x,0)};Translate.y=Translate.Y=function(y){return Translate(0,y)};MaxHeight=function(maxHeight){return style({maxHeight:maxHeight})};MinHeight=function(minHeight){return style({minHeight:minHeight})};function makeDomGenerator(tagName){return function(){var props={style:{}};var children=[];_.each(arguments,processArg);function processArg(val){if(isReactObj(val)){children.push(val)}else if(_.isFunction(val)){processArg(val(props,children))}else if(_.isArray(val)||_.isArguments(val)){_.each(val,processArg)}else if(_.isObject(val)){if(Layout.isLayout(val)){_.assign(props.style,val._styles)}else{_.assign(props,val)}}else if(val!==undefined){children.push(val)}}var args=[tagName,props].concat(children);return React.createElement.apply(React,args)}}_el=makeDomGenerator("div");el=function(){var args=Array.prototype.slice.call(arguments);args.unshift(style({display:"inline-block"}));return _el.apply(this,args)}},{"asapp/util/util-globals":39}],33:[function(require,module,exports){module.exports={New:New};function New(defaultMaxWidth,fontCSS){var cache={};var yardsticks={};function getYardstick(maxWidth){if(yardsticks[maxWidth]){return yardsticks[maxWidth]}var wrapper=$(document.createElement("div")).css({width:maxWidth}).css(fontCSS).css({position:"absolute",top:-99999,left:-99999,visibiliy:"hidden",wordWrap:"break-word",wordBreak:"break-word"}).appendTo(document.body);yardsticks[maxWidth]=$(document.createElement("span")).appendTo(wrapper);return yardsticks[maxWidth]}return{Measure:function(text,maxWidth){if(!maxWidth){maxWidth=defaultMaxWidth}if(!cache[text+maxWidth]){var yardstick=getYardstick(maxWidth);yardstick.text(text);cache[text+maxWidth]=extend({width:yardstick.width()+1,height:yardstick.height(),padding:px.apply(this,padding)},fontCSS)}return cache[text+maxWidth]}}}},{}],34:[function(require,module,exports){var nav=require("asapp/ui/nav/urlNav");var ViewComponents={};var ui=module.exports={View:View,ViewComponent:ViewComponent,View2:View2,ViewComponents:ViewComponents,mixins:{ObserveWindowSize:ObserveWindowSizeMixin}};function ObserveWindowSizeMixin(callback){return{componentWillMount:function(){this.__onWindowResizeFn=bind(this,function(){var winSize={width:$(window).width(),height:$(window).height()};callback.call(this,winSize)});$(window).on("resize",this.__onWindowResizeFn);this.__onWindowResizeFn()},componentWillUnmount:function(){$(window).off("resize",this.__onWindowResizeFn)}}}function View(name,args){var render=args.render;var viewEl=MakeDomGenerator(name);args.render=function(){var layout=this.state.layout||this.props.layout||{};return viewEl(style(layout._styles),render.apply(this,arguments))};var viewComponent=ViewComponent(name,args);return extend(function(layout,props){if(!props){props={}}props.layout=layout;return viewComponent.call(this,props)},args.statics)}function View2(name,args){var render=args.render;var viewEl=MakeDomGenerator(name);args.render=function(){return viewEl(style({display:"flex",flex:1,flexDirection:"column"}),render.apply(this,arguments))};return ViewComponent(name,args)}function ViewComponent(name,args){if(ViewComponents[name]){throw new Error("ViewComponent already exists: "+name)}if(!args.statics){args.statics={}}if(!args.getInitialState){args.getInitialState=function(){return{}}}if(!args.mixins){args.mixins=[]}args.displayName=name;ViewComponents[name]=extend(React.createFactory(React.createClass(args)),args.statics);return ViewComponents[name]}},{"asapp/ui/nav/urlNav":28}],35:[function(require,module,exports){module.exports=require("std/url").parse},{"std/url":59}],36:[function(require,module,exports){require("./util-globals");module.exports={New:New};var pubsubBase={On:On,Off:Off,Fire:Fire,Once:Once,Count:Count,OnFire:OnFire,MixinOn:MixinOn};function MixinOn(signal,callback){var subId;var pubsub=this;return{componentDidMount:function(){subId=pubsub.On(signal,bind(this,callback))},componentWillUnmount:function(){pubsub.Off(subId)}}}function New(){return create(pubsubBase,{nextSubId:1,subsBySignal:{},signalBySubId:{},subsAll:[]})}function On(signal,callback){var subId=this.nextSubId;this.nextSubId+=1;if(!this.subsBySignal[signal]){this.subsBySignal[signal]={}}this.subsBySignal[signal][subId]=callback;this.signalBySubId[subId]=signal;return subId}function Count(signal){return Object.keys(this.subsBySignal[signal]).length}function Off(subId){var signal=this.signalBySubId[subId];if(this.subsBySignal[signal]){delete this.subsBySignal[signal][subId]}delete this.signalBySubId[subId];return signal}function Fire(signal,arg1,arg2,etc){var args=Array.prototype.slice.call(arguments,1);var subs=this.subsBySignal[signal];for(var subId in subs){subs[subId].apply(this,args)}for(var i=0;i<this.subsAll.length;i++){this.subsAll[i].apply(this,arguments)}}function Once(signal,callback){var subId=this.On(signal,bind(this,function(){this.Off(subId);callback.apply(this,arguments)}))}function OnFire(fn){this.subsAll.push(fn)}},{"./util-globals":39}],37:[function(require,module,exports){var pubsubs=require("asapp/util/pubsub");var storage=require("github.com/marcuswestin/store.js");module.exports={SetPersistPrefix:SetPersistPrefix,ClearAll:ClearAll,New:New};var persistPrefix;function SetPersistPrefix(prefix){if(persistPrefix){throw new Error("persistPrefix already set")}persistPrefix=prefix}function ClearAll(){each(allStores,function(store){store.Clear()})}var allStores=[];var registeredNames={};function New(opts){opts=defaults(opts||{},{PersistWithName:null,DeleteUnobservedKeys:false});var persistWithName=null;if(opts.PersistWithName){if(!persistPrefix){throw new Error("persistPrefix not set")}var persistWithName=persistPrefix+"_"+opts.PersistWithName;if(registeredNames[persistWithName]){throw new Error("Duplicate store name:"+persistWithName)}registeredNames[persistWithName]=true}var newStore=create(storeBase,{pubsub:pubsubs.New(),values:persistWithName&&storage.get(persistWithName)||{},persistWithName:persistWithName,DeleteUnobservedKeys:opts.DeleteUnobservedKeys,defaultValues:{},getValue:getValue});newStore.mixins={Observe:curry(ObserveMixin,newStore)};allStores.push(newStore);return newStore}var storeBase={On:On,OnFire:OnFire,Once:Once,Off:Off,Fire:Fire,MixinOn:MixinOn,Observe:Observe,Set:Set,Get:Get,SetDefaultValue:SetDefaultValue,Clear:Clear};function ObserveMixin(store,key,callback){var obsId;return{componentWillMount:function(){obsId=store.Observe(key,bind(this,callback))},componentWillUnmount:function(){store.Off(obsId)}}}function Observe(key,callback){var subId=this.On(key,callback);callback(this.getValue(key));return subId}function On(signal,callback){return this.pubsub.On(signal,callback)}function OnFire(callback){return this.pubsub.OnFire(callback)}function Once(signal,callback){return this.pubsub.Once(signal,callback)}function Off(subId){var signal=this.pubsub.Off(subId);if(this.DeleteUnobservedKeys&&this.pubsub.Count(signal)==0){delete this.values[key]}}function Fire(){return this.pubsub.Fire.apply(this.pubsub,arguments)}function MixinOn(signal,callback){return this.pubsub.MixinOn(signal,callback)}function Set(key,value){this.values[key]=value;if(this.persistWithName){storage.set(this.persistWithName,this.values)}this.pubsub.Fire(key,value)}function Get(key){return this.getValue(key)}function SetDefaultValue(key,defaultValue){this.defaultValues[key]=defaultValue}function Clear(){var keys=_.keys(this.values);for(var i=0;i<keys.length;i++){this.Set(keys[i],null)}}function getValue(key){return this.values[key]!=undefined?this.values[key]:this.defaultValues[key]}},{"asapp/util/pubsub":36,"github.com/marcuswestin/store.js":40}],38:[function(require,module,exports){var companyMarker=location.pathname.split("/")[1];require("asapp/util/store").SetPersistPrefix("web-sdk-dialogue-"+companyMarker)},{"asapp/util/store":37}],39:[function(require,module,exports){assert=function(val,msg){if(!val){throw new Error(msg||"assert failed")}};bind=function(ctx,fn){if(!fn){debugger;throw new Error("bind() called without function")}var curryArgs=_slice.call(arguments,2);return function bound(){var invocationArgs=_slice.call(arguments);return fn.apply(ctx,curryArgs.concat(invocationArgs))}};curry=require("std/curry");var _slice=Array.prototype.slice;slice=function args(args,offset,length){if(typeof length=="undefined"){length=args.length}return _slice.call(args,offset||0,length)};swap=function(obj,a,b){var tmp=obj[a];obj[a]=obj[b];obj[b]=tmp};map=_.map;each=_.each;last=_.last;filter=_.filter;uniq=_.uniq;create=_.create;assign=_.assign;defaults=function(){if(!arguments[0]){arguments[0]={}}return _.defaults.apply(this,arguments)};range=_.range;isObject=_.isObject;isArray=_.isArray;extend=_.extend;isNumber=_.isNumber;isFunction=_.isFunction;clip=require("std/clip");find=require("std/find");remove=require("std/remove");deepEach=function(obj,fn){recurse(obj,[]);function recurse(obj,path){if(isArray(obj)||isObject(obj)){for(var key in obj){recurse(obj[key],path.concat(key))}}else{fn(obj,path)}}};after=function(time,fn){return setTimeout(fn.bind(this),time)};async=function(fn){return setTimeout(fn.bind(this),0)};parseQuery=function(queryStr){var res={};each(queryStr.split("&"),function(part){var kvp=part.split("=");res[decodeURIComponent(kvp[0])]=decodeURIComponent(kvp[1])});return res};parseLocationQuery=function(){return parseQuery(location.search.substr(1))};gGetCompanyMarker=function(){var query=parseLocationQuery();if(query["CompanyMarker"]){return query["CompanyMarker"]}if(location.pathname.split("/")[1]!="auth"){return location.pathname.split("/")[1]}var state=gGetValueForKeyFromHash("state");return state.split("/")[0]};gGetValueForKeyFromHash=function(key){var token=window.location.hash;var value="";if(token.length>0){token=token.substring(1);var values=token.split("&");for(var i=0;i<values.length;i++){var _key=values[i].split("=")[0];if(_key==key){value=decodeURIComponent(values[i].split("=")[1])}}}return value}},{"std/clip":43,"std/curry":44,"std/find":47,"std/remove":55}],40:[function(require,module,exports){"use strict";(function(root,factory){if(typeof define==="function"&&define.amd){define([],factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.store=factory()}})(this,function(){var store={},win=window,doc=win.document,localStorageName="localStorage",scriptTag="script",storage;store.disabled=false;store.version="1.3.17";store.set=function(key,value){};store.get=function(key,defaultVal){};store.has=function(key){return store.get(key)!==undefined};store.remove=function(key){};store.clear=function(){};store.transact=function(key,defaultVal,transactionFn){if(transactionFn==null){transactionFn=defaultVal;defaultVal=null}if(defaultVal==null){defaultVal={}}var val=store.get(key,defaultVal);transactionFn(val);store.set(key,val)};store.getAll=function(){};store.forEach=function(){};store.serialize=function(value){return JSON.stringify(value)};store.deserialize=function(value){if(typeof value!="string"){return undefined}try{return JSON.parse(value)}catch(e){return value||undefined}};function isLocalStorageNameSupported(){try{return localStorageName in win&&win[localStorageName]}catch(err){return false}}if(isLocalStorageNameSupported()){storage=win[localStorageName];store.set=function(key,val){if(val===undefined){return store.remove(key)}storage.setItem(key,store.serialize(val));return val};store.get=function(key,defaultVal){var val=store.deserialize(storage.getItem(key));return val===undefined?defaultVal:val};store.remove=function(key){storage.removeItem(key)};store.clear=function(){storage.clear()};store.getAll=function(){var ret={};store.forEach(function(key,val){ret[key]=val});return ret};store.forEach=function(callback){for(var i=0;i<storage.length;i++){var key=storage.key(i);callback(key,store.get(key))}}}else if(doc.documentElement.addBehavior){var storageOwner,storageContainer;try{storageContainer=new ActiveXObject("htmlfile");storageContainer.open();storageContainer.write("<"+scriptTag+">document.w=window</"+scriptTag+'><iframe src="/favicon.ico"></iframe>');storageContainer.close();storageOwner=storageContainer.w.frames[0].document;storage=storageOwner.createElement("div")}catch(e){storage=doc.createElement("div");storageOwner=doc.body}var withIEStorage=function(storeFunction){return function(){var args=Array.prototype.slice.call(arguments,0);args.unshift(storage);storageOwner.appendChild(storage);storage.addBehavior("#default#userData");storage.load(localStorageName);var result=storeFunction.apply(store,args);storageOwner.removeChild(storage);return result}};var forbiddenCharsRegex=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");var ieKeyFix=function(key){return key.replace(/^d/,"___$&").replace(forbiddenCharsRegex,"___")};store.set=withIEStorage(function(storage,key,val){key=ieKeyFix(key);if(val===undefined){return store.remove(key)}storage.setAttribute(key,store.serialize(val));storage.save(localStorageName);return val});store.get=withIEStorage(function(storage,key,defaultVal){key=ieKeyFix(key);var val=store.deserialize(storage.getAttribute(key));return val===undefined?defaultVal:val});store.remove=withIEStorage(function(storage,key){key=ieKeyFix(key);storage.removeAttribute(key);storage.save(localStorageName)});store.clear=withIEStorage(function(storage){var attributes=storage.XMLDocument.documentElement.attributes;storage.load(localStorageName);while(attributes.length){storage.removeAttribute(attributes[0].name)}storage.save(localStorageName)});store.getAll=function(storage){var ret={};store.forEach(function(key,val){ret[key]=val});return ret};store.forEach=withIEStorage(function(storage,callback){var attributes=storage.XMLDocument.documentElement.attributes;for(var i=0,attr;attr=attributes[i];++i){callback(attr.name,store.deserialize(storage.getAttribute(attr.name)))}})}try{var testKey="__storejs__";store.set(testKey,testKey);if(store.get(testKey)!=testKey){store.disabled=true}store.remove(testKey)}catch(e){store.disabled=true}store.enabled=!store.disabled;return store})},{}],41:[function(require,module,exports){(function(){var Color,K,PITHIRD,TWOPI,X,Y,Z,bezier,brewer,chroma,clip_rgb,colors,cos,css2rgb,hex2rgb,hsi2rgb,hsl2rgb,hsv2rgb,lab2lch,lab2rgb,lab_xyz,lch2lab,lch2rgb,limit,luminance,luminance_x,rgb2hex,rgb2hsi,rgb2hsl,rgb2hsv,rgb2lab,rgb2lch,rgb_xyz,root,type,unpack,xyz_lab,xyz_rgb,_ref;chroma=function(x,y,z,m){return new Color(x,y,z,m)};if(typeof module!=="undefined"&&module!==null&&module.exports!=null){module.exports=chroma}if(typeof define==="function"&&define.amd){define([],function(){return chroma})}else{root=typeof exports!=="undefined"&&exports!==null?exports:this;root.chroma=chroma}chroma.color=function(x,y,z,m){return new Color(x,y,z,m)};chroma.hsl=function(h,s,l,a){return new Color(h,s,l,a,"hsl")};chroma.hsv=function(h,s,v,a){return new Color(h,s,v,a,"hsv")};chroma.rgb=function(r,g,b,a){return new Color(r,g,b,a,"rgb")};chroma.hex=function(x){return new Color(x)};chroma.css=function(x){return new Color(x)};chroma.lab=function(l,a,b){return new Color(l,a,b,"lab")};chroma.lch=function(l,c,h){return new Color(l,c,h,"lch")};chroma.hsi=function(h,s,i){return new Color(h,s,i,"hsi")};chroma.gl=function(r,g,b,a){return new Color(r*255,g*255,b*255,a,"gl")};chroma.interpolate=function(a,b,f,m){if(a==null||b==null){return"#000"}if(type(a)==="string"){a=new Color(a)}if(type(b)==="string"){b=new Color(b)}return a.interpolate(f,b,m)};chroma.mix=chroma.interpolate;chroma.contrast=function(a,b){var l1,l2;if(type(a)==="string"){a=new Color(a)}if(type(b)==="string"){b=new Color(b)}l1=a.luminance();l2=b.luminance();if(l1>l2){return(l1+.05)/(l2+.05)}else{return(l2+.05)/(l1+.05)}};chroma.luminance=function(color){return chroma(color).luminance()};chroma._Color=Color;Color=function(){function Color(){var a,arg,args,m,me,me_rgb,x,y,z,_i,_len,_ref,_ref1,_ref2,_ref3,_ref4;me=this;args=[];for(_i=0,_len=arguments.length;_i<_len;_i++){arg=arguments[_i];if(arg!=null){args.push(arg)}}if(args.length===0){_ref=[255,0,255,1,"rgb"],x=_ref[0],y=_ref[1],z=_ref[2],a=_ref[3],m=_ref[4]}else if(type(args[0])==="array"){if(args[0].length===3){_ref1=args[0],x=_ref1[0],y=_ref1[1],z=_ref1[2];a=1}else if(args[0].length===4){_ref2=args[0],x=_ref2[0],y=_ref2[1],z=_ref2[2],a=_ref2[3]}else{throw"unknown input argument"}m=(_ref3=args[1])!=null?_ref3:"rgb"}else if(type(args[0])==="string"){x=args[0];m="hex"}else if(type(args[0])==="object"){_ref4=args[0]._rgb,x=_ref4[0],y=_ref4[1],z=_ref4[2],a=_ref4[3];m="rgb"}else if(args.length>=3){x=args[0];y=args[1];z=args[2]}if(args.length===3){m="rgb";a=1}else if(args.length===4){if(type(args[3])==="string"){m=args[3];a=1}else if(type(args[3])==="number"){m="rgb";a=args[3]}}else if(args.length===5){a=args[3];m=args[4]}if(a==null){a=1}if(m==="rgb"){me._rgb=[x,y,z,a]}else if(m==="gl"){me._rgb=[x*255,y*255,z*255,a]}else if(m==="hsl"){me._rgb=hsl2rgb(x,y,z);me._rgb[3]=a}else if(m==="hsv"){me._rgb=hsv2rgb(x,y,z);me._rgb[3]=a}else if(m==="hex"){me._rgb=hex2rgb(x)}else if(m==="lab"){me._rgb=lab2rgb(x,y,z);me._rgb[3]=a}else if(m==="lch"){me._rgb=lch2rgb(x,y,z);me._rgb[3]=a}else if(m==="hsi"){me._rgb=hsi2rgb(x,y,z);me._rgb[3]=a}me_rgb=clip_rgb(me._rgb)}Color.prototype.rgb=function(){return this._rgb.slice(0,3)};Color.prototype.rgba=function(){return this._rgb};Color.prototype.hex=function(){return rgb2hex(this._rgb)};Color.prototype.toString=function(){return this.name()};Color.prototype.hsl=function(){return rgb2hsl(this._rgb)};Color.prototype.hsv=function(){return rgb2hsv(this._rgb)};Color.prototype.lab=function(){return rgb2lab(this._rgb)};Color.prototype.lch=function(){return rgb2lch(this._rgb)};Color.prototype.hsi=function(){return rgb2hsi(this._rgb)};Color.prototype.gl=function(){return[this._rgb[0]/255,this._rgb[1]/255,this._rgb[2]/255,this._rgb[3]]};Color.prototype.luminance=function(){return luminance(this._rgb)};Color.prototype.name=function(){var h,k;h=this.hex();for(k in chroma.colors){if(h===chroma.colors[k]){return k}}return h};Color.prototype.alpha=function(alpha){if(arguments.length){this._rgb[3]=alpha;return this}return this._rgb[3]};Color.prototype.css=function(mode){var hsl,me,rgb,rnd;if(mode==null){mode="rgb"}me=this;rgb=me._rgb;if(mode.length===3&&rgb[3]<1){mode+="a"}if(mode==="rgb"){return mode+"("+rgb.slice(0,3).map(Math.round).join(",")+")"}else if(mode==="rgba"){return mode+"("+rgb.slice(0,3).map(Math.round).join(",")+","+rgb[3]+")"}else if(mode==="hsl"||mode==="hsla"){hsl=me.hsl();rnd=function(a){return Math.round(a*100)/100};hsl[0]=rnd(hsl[0]);hsl[1]=rnd(hsl[1]*100)+"%";hsl[2]=rnd(hsl[2]*100)+"%";if(mode.length===4){hsl[3]=rgb[3]}return mode+"("+hsl.join(",")+")"}};Color.prototype.interpolate=function(f,col,m){var dh,hue,hue0,hue1,lbv,lbv0,lbv1,me,res,sat,sat0,sat1,xyz0,xyz1;me=this;if(m==null){m="rgb"}if(type(col)==="string"){col=new Color(col)}if(m==="hsl"||m==="hsv"||m==="lch"||m==="hsi"){if(m==="hsl"){xyz0=me.hsl();xyz1=col.hsl()}else if(m==="hsv"){xyz0=me.hsv();xyz1=col.hsv()}else if(m==="hsi"){xyz0=me.hsi();xyz1=col.hsi()}else if(m==="lch"){xyz0=me.lch();xyz1=col.lch()}if(m.substr(0,1)==="h"){hue0=xyz0[0],sat0=xyz0[1],lbv0=xyz0[2];hue1=xyz1[0],sat1=xyz1[1],lbv1=xyz1[2]}else{lbv0=xyz0[0],sat0=xyz0[1],hue0=xyz0[2];lbv1=xyz1[0],sat1=xyz1[1],hue1=xyz1[2]}if(!isNaN(hue0)&&!isNaN(hue1)){if(hue1>hue0&&hue1-hue0>180){dh=hue1-(hue0+360)}else if(hue1<hue0&&hue0-hue1>180){dh=hue1+360-hue0}else{dh=hue1-hue0}hue=hue0+f*dh}else if(!isNaN(hue0)){hue=hue0;if((lbv1===1||lbv1===0)&&m!=="hsv"){sat=sat0}}else if(!isNaN(hue1)){hue=hue1;if((lbv0===1||lbv0===0)&&m!=="hsv"){sat=sat1}}else{hue=Number.NaN}if(sat==null){sat=sat0+f*(sat1-sat0)}lbv=lbv0+f*(lbv1-lbv0);if(m.substr(0,1)==="h"){res=new Color(hue,sat,lbv,m)}else{res=new Color(lbv,sat,hue,m)}}else if(m==="rgb"){xyz0=me._rgb;xyz1=col._rgb;res=new Color(xyz0[0]+f*(xyz1[0]-xyz0[0]),xyz0[1]+f*(xyz1[1]-xyz0[1]),xyz0[2]+f*(xyz1[2]-xyz0[2]),m)}else if(m==="lab"){xyz0=me.lab();xyz1=col.lab();res=new Color(xyz0[0]+f*(xyz1[0]-xyz0[0]),xyz0[1]+f*(xyz1[1]-xyz0[1]),xyz0[2]+f*(xyz1[2]-xyz0[2]),m)}else{throw"color mode "+m+" is not supported"}res.alpha(me.alpha()+f*(col.alpha()-me.alpha()));return res};Color.prototype.premultiply=function(){var a,rgb;rgb=this.rgb();a=this.alpha();return chroma(rgb[0]*a,rgb[1]*a,rgb[2]*a,a)};Color.prototype.darken=function(amount){var lch,me;if(amount==null){amount=20}me=this;lch=me.lch();lch[0]-=amount;return chroma.lch(lch).alpha(me.alpha())};Color.prototype.darker=function(amount){return this.darken(amount)};Color.prototype.brighten=function(amount){if(amount==null){amount=20}return this.darken(-amount)};Color.prototype.brighter=function(amount){return this.brighten(amount)};Color.prototype.saturate=function(amount){var lch,me;if(amount==null){amount=20}me=this;lch=me.lch();lch[1]+=amount;return chroma.lch(lch).alpha(me.alpha())};Color.prototype.desaturate=function(amount){if(amount==null){amount=20}return this.saturate(-amount)};return Color}();clip_rgb=function(rgb){var i;for(i in rgb){if(i<3){if(rgb[i]<0){rgb[i]=0}if(rgb[i]>255){rgb[i]=255}}else if(i===3){if(rgb[i]<0){rgb[i]=0}if(rgb[i]>1){rgb[i]=1}}}return rgb};css2rgb=function(css){var hsl,i,m,rgb,_i,_j,_k,_l;css=css.toLowerCase();if(chroma.colors!=null&&chroma.colors[css]){return hex2rgb(chroma.colors[css])}if(m=css.match(/rgb\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*\)/)){rgb=m.slice(1,4);for(i=_i=0;_i<=2;i=++_i){rgb[i]=+rgb[i]}rgb[3]=1}else if(m=css.match(/rgba\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*,\s*([01]|[01]?\.\d+)\)/)){rgb=m.slice(1,5);for(i=_j=0;_j<=3;i=++_j){rgb[i]=+rgb[i]}}else if(m=css.match(/rgb\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/)){rgb=m.slice(1,4);for(i=_k=0;_k<=2;i=++_k){rgb[i]=Math.round(rgb[i]*2.55)}rgb[3]=1}else if(m=css.match(/rgba\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/)){rgb=m.slice(1,5);for(i=_l=0;_l<=2;i=++_l){rgb[i]=Math.round(rgb[i]*2.55)}rgb[3]=+rgb[3]}else if(m=css.match(/hsl\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/)){hsl=m.slice(1,4);hsl[1]*=.01;hsl[2]*=.01;rgb=hsl2rgb(hsl);rgb[3]=1}else if(m=css.match(/hsla\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/)){hsl=m.slice(1,4);hsl[1]*=.01;hsl[2]*=.01;rgb=hsl2rgb(hsl);rgb[3]=+m[4]}return rgb};hex2rgb=function(hex){var a,b,g,r,rgb,u;if(hex.match(/^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/)){if(hex.length===4||hex.length===7){hex=hex.substr(1)}if(hex.length===3){hex=hex.split("");hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]}u=parseInt(hex,16);r=u>>16;g=u>>8&255;b=u&255;return[r,g,b,1]}if(hex.match(/^#?([A-Fa-f0-9]{8})$/)){if(hex.length===9){hex=hex.substr(1)}u=parseInt(hex,16);r=u>>24&255;g=u>>16&255;b=u>>8&255;a=u&255;return[r,g,b,a]}if(rgb=css2rgb(hex)){return rgb}throw"unknown color: "+hex};hsi2rgb=function(h,s,i){var b,g,r,_ref;_ref=unpack(arguments),h=_ref[0],s=_ref[1],i=_ref[2];h/=360;if(h<1/3){b=(1-s)/3;r=(1+s*cos(TWOPI*h)/cos(PITHIRD-TWOPI*h))/3;g=1-(b+r)}else if(h<2/3){h-=1/3;r=(1-s)/3;g=(1+s*cos(TWOPI*h)/cos(PITHIRD-TWOPI*h))/3;b=1-(r+g)}else{h-=2/3;g=(1-s)/3;b=(1+s*cos(TWOPI*h)/cos(PITHIRD-TWOPI*h))/3;r=1-(g+b)}r=limit(i*r*3);g=limit(i*g*3);b=limit(i*b*3);return[r*255,g*255,b*255]};hsl2rgb=function(){var b,c,g,h,i,l,r,s,t1,t2,t3,_i,_ref,_ref1;_ref=unpack(arguments),h=_ref[0],s=_ref[1],l=_ref[2];if(s===0){r=g=b=l*255}else{t3=[0,0,0];c=[0,0,0];t2=l<.5?l*(1+s):l+s-l*s;t1=2*l-t2;h/=360;t3[0]=h+1/3;t3[1]=h;t3[2]=h-1/3;for(i=_i=0;_i<=2;i=++_i){if(t3[i]<0){t3[i]+=1}if(t3[i]>1){t3[i]-=1}if(6*t3[i]<1){c[i]=t1+(t2-t1)*6*t3[i]}else if(2*t3[i]<1){c[i]=t2}else if(3*t3[i]<2){c[i]=t1+(t2-t1)*(2/3-t3[i])*6}else{c[i]=t1}}_ref1=[Math.round(c[0]*255),Math.round(c[1]*255),Math.round(c[2]*255)],r=_ref1[0],g=_ref1[1],b=_ref1[2]}return[r,g,b]};hsv2rgb=function(){var b,f,g,h,i,p,q,r,s,t,v,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6;_ref=unpack(arguments),h=_ref[0],s=_ref[1],v=_ref[2];v*=255;if(s===0){r=g=b=v}else{if(h===360){h=0}if(h>360){h-=360}if(h<0){h+=360}h/=60;i=Math.floor(h);f=h-i;p=v*(1-s);q=v*(1-s*f);t=v*(1-s*(1-f));switch(i){case 0:_ref1=[v,t,p],r=_ref1[0],g=_ref1[1],b=_ref1[2];break;case 1:_ref2=[q,v,p],r=_ref2[0],g=_ref2[1],b=_ref2[2];break;case 2:_ref3=[p,v,t],r=_ref3[0],g=_ref3[1],b=_ref3[2];break;case 3:_ref4=[p,q,v],r=_ref4[0],g=_ref4[1],b=_ref4[2];break;case 4:_ref5=[t,p,v],r=_ref5[0],g=_ref5[1],b=_ref5[2];break;case 5:_ref6=[v,p,q],r=_ref6[0],g=_ref6[1],b=_ref6[2]}}r=Math.round(r);g=Math.round(g);b=Math.round(b);return[r,g,b]};K=18;X=.95047;Y=1;Z=1.08883;lab2lch=function(){var a,b,c,h,l,_ref;_ref=unpack(arguments),l=_ref[0],a=_ref[1],b=_ref[2];c=Math.sqrt(a*a+b*b);h=Math.atan2(b,a)/Math.PI*180;return[l,c,h]};lab2rgb=function(l,a,b){var g,r,x,y,z,_ref,_ref1;if(l!==void 0&&l.length===3){_ref=l,l=_ref[0],a=_ref[1],b=_ref[2]}if(l!==void 0&&l.length===3){_ref1=l,l=_ref1[0],a=_ref1[1],b=_ref1[2]}y=(l+16)/116;x=y+a/500;z=y-b/200;x=lab_xyz(x)*X;y=lab_xyz(y)*Y;z=lab_xyz(z)*Z;r=xyz_rgb(3.2404542*x-1.5371385*y-.4985314*z);g=xyz_rgb(-.969266*x+1.8760108*y+.041556*z);b=xyz_rgb(.0556434*x-.2040259*y+1.0572252*z);return[limit(r,0,255),limit(g,0,255),limit(b,0,255),1]};lab_xyz=function(x){if(x>.206893034){return x*x*x}else{return(x-4/29)/7.787037}};xyz_rgb=function(r){return Math.round(255*(r<=.00304?12.92*r:1.055*Math.pow(r,1/2.4)-.055))};lch2lab=function(){var c,h,l,_ref;_ref=unpack(arguments),l=_ref[0],c=_ref[1],h=_ref[2];h=h*Math.PI/180;return[l,Math.cos(h)*c,Math.sin(h)*c]};lch2rgb=function(l,c,h){var L,a,b,g,r,_ref,_ref1;_ref=lch2lab(l,c,h),L=_ref[0],a=_ref[1],b=_ref[2];_ref1=lab2rgb(L,a,b),r=_ref1[0],g=_ref1[1],b=_ref1[2];return[limit(r,0,255),limit(g,0,255),limit(b,0,255)]};luminance=function(r,g,b){var _ref;_ref=unpack(arguments),r=_ref[0],g=_ref[1],b=_ref[2];r=luminance_x(r);g=luminance_x(g);b=luminance_x(b);return.2126*r+.7152*g+.0722*b};luminance_x=function(x){x/=255;if(x<=.03928){return x/12.92}else{return Math.pow((x+.055)/1.055,2.4)}};rgb2hex=function(){var b,g,r,str,u,_ref;_ref=unpack(arguments),r=_ref[0],g=_ref[1],b=_ref[2];u=r<<16|g<<8|b;str="000000"+u.toString(16);return"#"+str.substr(str.length-6)};rgb2hsi=function(){var TWOPI,b,g,h,i,min,r,s,_ref;_ref=unpack(arguments),r=_ref[0],g=_ref[1],b=_ref[2];TWOPI=Math.PI*2;r/=255;g/=255;b/=255;min=Math.min(r,g,b);i=(r+g+b)/3;s=1-min/i;if(s===0){h=0}else{h=(r-g+(r-b))/2;h/=Math.sqrt((r-g)*(r-g)+(r-b)*(g-b));h=Math.acos(h);if(b>g){h=TWOPI-h}h/=TWOPI}return[h*360,s,i]};rgb2hsl=function(r,g,b){var h,l,max,min,s,_ref;if(r!==void 0&&r.length>=3){_ref=r,r=_ref[0],g=_ref[1],b=_ref[2]}r/=255;g/=255;b/=255;min=Math.min(r,g,b);max=Math.max(r,g,b);l=(max+min)/2;if(max===min){s=0;h=Number.NaN}else{s=l<.5?(max-min)/(max+min):(max-min)/(2-max-min)}if(r===max){h=(g-b)/(max-min)}else if(g===max){h=2+(b-r)/(max-min)}else if(b===max){h=4+(r-g)/(max-min)}h*=60;if(h<0){h+=360}return[h,s,l]};rgb2hsv=function(){var b,delta,g,h,max,min,r,s,v,_ref;_ref=unpack(arguments),r=_ref[0],g=_ref[1],b=_ref[2];min=Math.min(r,g,b);max=Math.max(r,g,b);delta=max-min;v=max/255;if(max===0){h=Number.NaN;s=0}else{s=delta/max;if(r===max){h=(g-b)/delta}if(g===max){h=2+(b-r)/delta}if(b===max){h=4+(r-g)/delta}h*=60;if(h<0){h+=360}}return[h,s,v]};rgb2lab=function(){var b,g,r,x,y,z,_ref;_ref=unpack(arguments),r=_ref[0],g=_ref[1],b=_ref[2];r=rgb_xyz(r);g=rgb_xyz(g);b=rgb_xyz(b);x=xyz_lab((.4124564*r+.3575761*g+.1804375*b)/X);y=xyz_lab((.2126729*r+.7151522*g+.072175*b)/Y);z=xyz_lab((.0193339*r+.119192*g+.9503041*b)/Z);return[116*y-16,500*(x-y),200*(y-z)]};rgb_xyz=function(r){if((r/=255)<=.04045){return r/12.92}else{return Math.pow((r+.055)/1.055,2.4)}};xyz_lab=function(x){if(x>.008856){return Math.pow(x,1/3)}else{return 7.787037*x+4/29}};rgb2lch=function(){var a,b,g,l,r,_ref,_ref1;_ref=unpack(arguments),r=_ref[0],g=_ref[1],b=_ref[2];_ref1=rgb2lab(r,g,b),l=_ref1[0],a=_ref1[1],b=_ref1[2];return lab2lch(l,a,b)};chroma.scale=function(colors,positions){var classifyValue,f,getClass,getColor,resetCache,setColors,setDomain,tmap,_colorCache,_colors,_correctLightness,_domain,_fixed,_max,_min,_mode,_nacol,_numClasses,_out,_pos,_spread;_mode="rgb";_nacol=chroma("#ccc");_spread=0;_fixed=false;_domain=[0,1];_colors=[];_out=false;_pos=[];_min=0;_max=1;_correctLightness=false;_numClasses=0;_colorCache={};setColors=function(colors,positions){var c,col,_i,_j,_ref,_ref1,_ref2;if(colors==null){colors=["#ddd","#222"]}if(colors!=null&&type(colors)==="string"&&((_ref=chroma.brewer)!=null?_ref[colors]:void 0)!=null){colors=chroma.brewer[colors]}if(type(colors)==="array"){colors=colors.slice(0);for(c=_i=0,_ref1=colors.length-1;0<=_ref1?_i<=_ref1:_i>=_ref1;c=0<=_ref1?++_i:--_i){col=colors[c];if(type(col)==="string"){colors[c]=chroma(col)}}if(positions!=null){_pos=positions}else{_pos=[];for(c=_j=0,_ref2=colors.length-1;0<=_ref2?_j<=_ref2:_j>=_ref2;c=0<=_ref2?++_j:--_j){_pos.push(c/(colors.length-1))}}}resetCache();return _colors=colors};setDomain=function(domain){if(domain==null){domain=[]}_domain=domain;_min=domain[0];_max=domain[domain.length-1];resetCache();if(domain.length===2){return _numClasses=0}else{return _numClasses=domain.length-1}};getClass=function(value){
var i,n;if(_domain!=null){n=_domain.length-1;i=0;while(i<n&&value>=_domain[i]){i++}return i-1}return 0};tmap=function(t){return t};classifyValue=function(value){var i,maxc,minc,n,val;val=value;if(_domain.length>2){n=_domain.length-1;i=getClass(value);minc=_domain[0]+(_domain[1]-_domain[0])*(0+_spread*.5);maxc=_domain[n-1]+(_domain[n]-_domain[n-1])*(1-_spread*.5);val=_min+(_domain[i]+(_domain[i+1]-_domain[i])*.5-minc)/(maxc-minc)*(_max-_min)}return val};getColor=function(val,bypassMap){var c,col,f0,i,k,p,t,_i,_ref;if(bypassMap==null){bypassMap=false}if(isNaN(val)){return _nacol}if(!bypassMap){if(_domain.length>2){c=getClass(val);t=c/(_numClasses-1)}else{t=f0=(val-_min)/(_max-_min);t=Math.min(1,Math.max(0,t))}}else{t=val}if(!bypassMap){t=tmap(t)}k=Math.floor(t*1e4);if(_colorCache[k]){col=_colorCache[k]}else{if(type(_colors)==="array"){for(i=_i=0,_ref=_pos.length-1;0<=_ref?_i<=_ref:_i>=_ref;i=0<=_ref?++_i:--_i){p=_pos[i];if(t<=p){col=_colors[i];break}if(t>=p&&i===_pos.length-1){col=_colors[i];break}if(t>p&&t<_pos[i+1]){t=(t-p)/(_pos[i+1]-p);col=chroma.interpolate(_colors[i],_colors[i+1],t,_mode);break}}}else if(type(_colors)==="function"){col=_colors(t)}_colorCache[k]=col}return col};resetCache=function(){return _colorCache={}};setColors(colors,positions);f=function(v){var c;c=getColor(v);if(_out&&c[_out]){return c[_out]()}else{return c}};f.domain=function(domain,classes,mode,key){var d;if(mode==null){mode="e"}if(!arguments.length){return _domain}if(classes!=null){d=chroma.analyze(domain,key);if(classes===0){domain=[d.min,d.max]}else{domain=chroma.limits(d,mode,classes)}}setDomain(domain);return f};f.mode=function(_m){if(!arguments.length){return _mode}_mode=_m;resetCache();return f};f.range=function(colors,_pos){setColors(colors,_pos);return f};f.out=function(_o){_out=_o;return f};f.spread=function(val){if(!arguments.length){return _spread}_spread=val;return f};f.correctLightness=function(v){if(!arguments.length){return _correctLightness}_correctLightness=v;resetCache();if(_correctLightness){tmap=function(t){var L0,L1,L_actual,L_diff,L_ideal,max_iter,pol,t0,t1;L0=getColor(0,true).lab()[0];L1=getColor(1,true).lab()[0];pol=L0>L1;L_actual=getColor(t,true).lab()[0];L_ideal=L0+(L1-L0)*t;L_diff=L_actual-L_ideal;t0=0;t1=1;max_iter=20;while(Math.abs(L_diff)>.01&&max_iter-- >0){(function(){if(pol){L_diff*=-1}if(L_diff<0){t0=t;t+=(t1-t)*.5}else{t1=t;t+=(t0-t)*.5}L_actual=getColor(t,true).lab()[0];return L_diff=L_actual-L_ideal})()}return t}}else{tmap=function(t){return t}}return f};f.colors=function(out){var i,samples,_i,_j,_len,_ref;if(out==null){out="hex"}colors=[];samples=[];if(_domain.length>2){for(i=_i=1,_ref=_domain.length;1<=_ref?_i<_ref:_i>_ref;i=1<=_ref?++_i:--_i){samples.push((_domain[i-1]+_domain[i])*.5)}}else{samples=_domain}for(_j=0,_len=samples.length;_j<_len;_j++){i=samples[_j];colors.push(f(i)[out]())}return colors};return f};if((_ref=chroma.scales)==null){chroma.scales={}}chroma.scales.cool=function(){return chroma.scale([chroma.hsl(180,1,.9),chroma.hsl(250,.7,.4)])};chroma.scales.hot=function(){return chroma.scale(["#000","#f00","#ff0","#fff"],[0,.25,.75,1]).mode("rgb")};chroma.analyze=function(data,key,filter){var add,k,r,val,visit,_i,_len;r={min:Number.MAX_VALUE,max:Number.MAX_VALUE*-1,sum:0,values:[],count:0};if(filter==null){filter=function(){return true}}add=function(val){if(val!=null&&!isNaN(val)){r.values.push(val);r.sum+=val;if(val<r.min){r.min=val}if(val>r.max){r.max=val}r.count+=1}};visit=function(val,k){if(filter(val,k)){if(key!=null&&type(key)==="function"){return add(key(val))}else if(key!=null&&type(key)==="string"||type(key)==="number"){return add(val[key])}else{return add(val)}}};if(type(data)==="array"){for(_i=0,_len=data.length;_i<_len;_i++){val=data[_i];visit(val)}}else{for(k in data){val=data[k];visit(val,k)}}r.domain=[r.min,r.max];r.limits=function(mode,num){return chroma.limits(r,mode,num)};return r};chroma.limits=function(data,mode,num){var assignments,best,centroids,cluster,clusterSizes,dist,i,j,kClusters,limits,max,max_log,min,min_log,mindist,n,nb_iters,newCentroids,p,pb,pr,repeat,sum,tmpKMeansBreaks,value,values,_i,_j,_k,_l,_m,_n,_o,_p,_q,_r,_ref1,_ref10,_ref11,_ref12,_ref13,_ref14,_ref15,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9,_s,_t,_u,_v,_w;if(mode==null){mode="equal"}if(num==null){num=7}if(type(data)==="array"){data=chroma.analyze(data)}min=data.min;max=data.max;sum=data.sum;values=data.values.sort(function(a,b){return a-b});limits=[];if(mode.substr(0,1)==="c"){limits.push(min);limits.push(max)}if(mode.substr(0,1)==="e"){limits.push(min);for(i=_i=1,_ref1=num-1;1<=_ref1?_i<=_ref1:_i>=_ref1;i=1<=_ref1?++_i:--_i){limits.push(min+i/num*(max-min))}limits.push(max)}else if(mode.substr(0,1)==="l"){if(min<=0){throw"Logarithmic scales are only possible for values > 0"}min_log=Math.LOG10E*Math.log(min);max_log=Math.LOG10E*Math.log(max);limits.push(min);for(i=_j=1,_ref2=num-1;1<=_ref2?_j<=_ref2:_j>=_ref2;i=1<=_ref2?++_j:--_j){limits.push(Math.pow(10,min_log+i/num*(max_log-min_log)))}limits.push(max)}else if(mode.substr(0,1)==="q"){limits.push(min);for(i=_k=1,_ref3=num-1;1<=_ref3?_k<=_ref3:_k>=_ref3;i=1<=_ref3?++_k:--_k){p=values.length*i/num;pb=Math.floor(p);if(pb===p){limits.push(values[pb])}else{pr=p-pb;limits.push(values[pb]*pr+values[pb+1]*(1-pr))}}limits.push(max)}else if(mode.substr(0,1)==="k"){n=values.length;assignments=new Array(n);clusterSizes=new Array(num);repeat=true;nb_iters=0;centroids=null;centroids=[];centroids.push(min);for(i=_l=1,_ref4=num-1;1<=_ref4?_l<=_ref4:_l>=_ref4;i=1<=_ref4?++_l:--_l){centroids.push(min+i/num*(max-min))}centroids.push(max);while(repeat){for(j=_m=0,_ref5=num-1;0<=_ref5?_m<=_ref5:_m>=_ref5;j=0<=_ref5?++_m:--_m){clusterSizes[j]=0}for(i=_n=0,_ref6=n-1;0<=_ref6?_n<=_ref6:_n>=_ref6;i=0<=_ref6?++_n:--_n){value=values[i];mindist=Number.MAX_VALUE;for(j=_o=0,_ref7=num-1;0<=_ref7?_o<=_ref7:_o>=_ref7;j=0<=_ref7?++_o:--_o){dist=Math.abs(centroids[j]-value);if(dist<mindist){mindist=dist;best=j}}clusterSizes[best]++;assignments[i]=best}newCentroids=new Array(num);for(j=_p=0,_ref8=num-1;0<=_ref8?_p<=_ref8:_p>=_ref8;j=0<=_ref8?++_p:--_p){newCentroids[j]=null}for(i=_q=0,_ref9=n-1;0<=_ref9?_q<=_ref9:_q>=_ref9;i=0<=_ref9?++_q:--_q){cluster=assignments[i];if(newCentroids[cluster]===null){newCentroids[cluster]=values[i]}else{newCentroids[cluster]+=values[i]}}for(j=_r=0,_ref10=num-1;0<=_ref10?_r<=_ref10:_r>=_ref10;j=0<=_ref10?++_r:--_r){newCentroids[j]*=1/clusterSizes[j]}repeat=false;for(j=_s=0,_ref11=num-1;0<=_ref11?_s<=_ref11:_s>=_ref11;j=0<=_ref11?++_s:--_s){if(newCentroids[j]!==centroids[i]){repeat=true;break}}centroids=newCentroids;nb_iters++;if(nb_iters>200){repeat=false}}kClusters={};for(j=_t=0,_ref12=num-1;0<=_ref12?_t<=_ref12:_t>=_ref12;j=0<=_ref12?++_t:--_t){kClusters[j]=[]}for(i=_u=0,_ref13=n-1;0<=_ref13?_u<=_ref13:_u>=_ref13;i=0<=_ref13?++_u:--_u){cluster=assignments[i];kClusters[cluster].push(values[i])}tmpKMeansBreaks=[];for(j=_v=0,_ref14=num-1;0<=_ref14?_v<=_ref14:_v>=_ref14;j=0<=_ref14?++_v:--_v){tmpKMeansBreaks.push(kClusters[j][0]);tmpKMeansBreaks.push(kClusters[j][kClusters[j].length-1])}tmpKMeansBreaks=tmpKMeansBreaks.sort(function(a,b){return a-b});limits.push(tmpKMeansBreaks[0]);for(i=_w=1,_ref15=tmpKMeansBreaks.length-1;_w<=_ref15;i=_w+=2){if(!isNaN(tmpKMeansBreaks[i])){limits.push(tmpKMeansBreaks[i])}}}return limits};chroma.brewer=brewer={OrRd:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],PuBu:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],BuPu:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],Oranges:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],BuGn:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],YlGn:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],Reds:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],RdPu:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],Greens:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],YlGnBu:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],Purples:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],GnBu:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],Greys:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],YlOrRd:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],PuRd:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],Blues:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],PuBuGn:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],Spectral:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],RdYlGn:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],RdBu:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],PiYG:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"],PRGn:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"],RdYlBu:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],BrBG:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],RdGy:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],PuOr:["#7f3b08","#b35806","#e08214","#fdb863","#fee0b6","#f7f7f7","#d8daeb","#b2abd2","#8073ac","#542788","#2d004b"],Set2:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],Accent:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],Set1:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],Set3:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],Dark2:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],Paired:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],Pastel2:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],Pastel1:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]};chroma.colors=colors={indigo:"#4b0082",gold:"#ffd700",hotpink:"#ff69b4",firebrick:"#b22222",indianred:"#cd5c5c",yellow:"#ffff00",mistyrose:"#ffe4e1",darkolivegreen:"#556b2f",olive:"#808000",darkseagreen:"#8fbc8f",pink:"#ffc0cb",tomato:"#ff6347",lightcoral:"#f08080",orangered:"#ff4500",navajowhite:"#ffdead",lime:"#00ff00",palegreen:"#98fb98",darkslategrey:"#2f4f4f",greenyellow:"#adff2f",burlywood:"#deb887",seashell:"#fff5ee",mediumspringgreen:"#00fa9a",fuchsia:"#ff00ff",papayawhip:"#ffefd5",blanchedalmond:"#ffebcd",chartreuse:"#7fff00",dimgray:"#696969",black:"#000000",peachpuff:"#ffdab9",springgreen:"#00ff7f",aquamarine:"#7fffd4",white:"#ffffff",orange:"#ffa500",lightsalmon:"#ffa07a",darkslategray:"#2f4f4f",brown:"#a52a2a",ivory:"#fffff0",dodgerblue:"#1e90ff",peru:"#cd853f",lawngreen:"#7cfc00",chocolate:"#d2691e",crimson:"#dc143c",forestgreen:"#228b22",darkgrey:"#a9a9a9",lightseagreen:"#20b2aa",cyan:"#00ffff",mintcream:"#f5fffa",silver:"#c0c0c0",antiquewhite:"#faebd7",mediumorchid:"#ba55d3",skyblue:"#87ceeb",gray:"#808080",darkturquoise:"#00ced1",goldenrod:"#daa520",darkgreen:"#006400",floralwhite:"#fffaf0",darkviolet:"#9400d3",darkgray:"#a9a9a9",moccasin:"#ffe4b5",saddlebrown:"#8b4513",grey:"#808080",darkslateblue:"#483d8b",lightskyblue:"#87cefa",lightpink:"#ffb6c1",mediumvioletred:"#c71585",slategrey:"#708090",red:"#ff0000",deeppink:"#ff1493",limegreen:"#32cd32",darkmagenta:"#8b008b",palegoldenrod:"#eee8aa",plum:"#dda0dd",turquoise:"#40e0d0",lightgrey:"#d3d3d3",lightgoldenrodyellow:"#fafad2",darkgoldenrod:"#b8860b",lavender:"#e6e6fa",maroon:"#800000",yellowgreen:"#9acd32",sandybrown:"#f4a460",thistle:"#d8bfd8",violet:"#ee82ee",navy:"#000080",magenta:"#ff00ff",dimgrey:"#696969",tan:"#d2b48c",rosybrown:"#bc8f8f",olivedrab:"#6b8e23",blue:"#0000ff",lightblue:"#add8e6",ghostwhite:"#f8f8ff",honeydew:"#f0fff0",cornflowerblue:"#6495ed",slateblue:"#6a5acd",linen:"#faf0e6",darkblue:"#00008b",powderblue:"#b0e0e6",seagreen:"#2e8b57",darkkhaki:"#bdb76b",snow:"#fffafa",sienna:"#a0522d",mediumblue:"#0000cd",royalblue:"#4169e1",lightcyan:"#e0ffff",green:"#008000",mediumpurple:"#9370db",midnightblue:"#191970",cornsilk:"#fff8dc",paleturquoise:"#afeeee",bisque:"#ffe4c4",slategray:"#708090",darkcyan:"#008b8b",khaki:"#f0e68c",wheat:"#f5deb3",teal:"#008080",darkorchid:"#9932cc",deepskyblue:"#00bfff",salmon:"#fa8072",darkred:"#8b0000",steelblue:"#4682b4",palevioletred:"#db7093",lightslategray:"#778899",aliceblue:"#f0f8ff",lightslategrey:"#778899",lightgreen:"#90ee90",orchid:"#da70d6",gainsboro:"#dcdcdc",mediumseagreen:"#3cb371",lightgray:"#d3d3d3",mediumturquoise:"#48d1cc",lemonchiffon:"#fffacd",cadetblue:"#5f9ea0",lightyellow:"#ffffe0",lavenderblush:"#fff0f5",coral:"#ff7f50",purple:"#800080",aqua:"#00ffff",whitesmoke:"#f5f5f5",mediumslateblue:"#7b68ee",darkorange:"#ff8c00",mediumaquamarine:"#66cdaa",darksalmon:"#e9967a",beige:"#f5f5dc",blueviolet:"#8a2be2",azure:"#f0ffff",lightsteelblue:"#b0c4de",oldlace:"#fdf5e6"};type=function(){var classToType,name,_i,_len,_ref1;classToType={};_ref1="Boolean Number String Function Array Date RegExp Undefined Null".split(" ");for(_i=0,_len=_ref1.length;_i<_len;_i++){name=_ref1[_i];classToType["[object "+name+"]"]=name.toLowerCase()}return function(obj){var strType;strType=Object.prototype.toString.call(obj);return classToType[strType]||"object"}}();limit=function(x,min,max){if(min==null){min=0}if(max==null){max=1}if(x<min){x=min}if(x>max){x=max}return x};unpack=function(args){if(args.length>=3){return args}else{return args[0]}};TWOPI=Math.PI*2;PITHIRD=Math.PI/3;cos=Math.cos;bezier=function(colors){var I,I0,I1,c,lab0,lab1,lab2,lab3,_ref1,_ref2,_ref3;colors=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colors.length;_i<_len;_i++){c=colors[_i];_results.push(chroma(c))}return _results}();if(colors.length===2){_ref1=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colors.length;_i<_len;_i++){c=colors[_i];_results.push(c.lab())}return _results}(),lab0=_ref1[0],lab1=_ref1[1];I=function(t){var i,lab;lab=function(){var _i,_results;_results=[];for(i=_i=0;_i<=2;i=++_i){_results.push(lab0[i]+t*(lab1[i]-lab0[i]))}return _results}();return chroma.lab.apply(chroma,lab)}}else if(colors.length===3){_ref2=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colors.length;_i<_len;_i++){c=colors[_i];_results.push(c.lab())}return _results}(),lab0=_ref2[0],lab1=_ref2[1],lab2=_ref2[2];I=function(t){var i,lab;lab=function(){var _i,_results;_results=[];for(i=_i=0;_i<=2;i=++_i){_results.push((1-t)*(1-t)*lab0[i]+2*(1-t)*t*lab1[i]+t*t*lab2[i])}return _results}();return chroma.lab.apply(chroma,lab)}}else if(colors.length===4){_ref3=function(){var _i,_len,_results;_results=[];for(_i=0,_len=colors.length;_i<_len;_i++){c=colors[_i];_results.push(c.lab())}return _results}(),lab0=_ref3[0],lab1=_ref3[1],lab2=_ref3[2],lab3=_ref3[3];I=function(t){var i,lab;lab=function(){var _i,_results;_results=[];for(i=_i=0;_i<=2;i=++_i){_results.push((1-t)*(1-t)*(1-t)*lab0[i]+3*(1-t)*(1-t)*t*lab1[i]+3*(1-t)*t*t*lab2[i]+t*t*t*lab3[i])}return _results}();return chroma.lab.apply(chroma,lab)}}else if(colors.length===5){I0=bezier(colors.slice(0,3));I1=bezier(colors.slice(2,5));I=function(t){if(t<.5){return I0(t*2)}else{return I1((t-.5)*2)}}}return I};chroma.interpolate.bezier=bezier}).call(this)},{}],42:[function(require,module,exports){module.exports=function Class(){var args=arguments,numOptArgs=args.length-1,mixins=[];var proto=args[numOptArgs];if(numOptArgs){var parent=args[0];if(parent){proto.prototype=parent.prototype}}for(var i=1;i<numOptArgs;i++){mixins.push(arguments[i])}var cls=function(){if(this.init){this.init.apply(this,arguments)}for(var i=0,mixin;mixin=mixins[i];i++){if(mixin.init){mixin.init.apply(this)}}};cls.prototype=new proto(function supr(context,method,args){var target=parent;while(target=target.prototype){if(target[method]){return target[method].apply(context,args||[])}}throw new Error("supr: parent method "+method+" does not exist")});for(var i=0,mixin;mixin=mixins[i];i++){for(var propertyName in mixin){if(!mixin.hasOwnProperty(propertyName)||propertyName=="init"){continue}if(cls.prototype.hasOwnProperty(propertyName)){throw new Error('Mixin property "'+propertyName+'" already exists on class')}cls.prototype[propertyName]=mixin[propertyName]}}cls.prototype.constructor=cls;return cls}},{}],43:[function(require,module,exports){module.exports=function clip(val,min,max){return Math.max(Math.min(val,max),min)}},{}],44:[function(require,module,exports){var slice=require("./slice");module.exports=function curry(fn){var curryArgs=slice(arguments,1);return function curried(){var invocationArgs=slice(arguments);return fn.apply(this,curryArgs.concat(invocationArgs))}}},{"./slice":56}],45:[function(require,module,exports){var isList=require("./isList");module.exports=function each(items,fn){if(!items){return}if(items.forEach==Array.prototype.forEach){items.forEach(fn)}else if(isList(items)){for(var i=0;i<items.length;i++){fn(items[i],i)}}else{for(var key in items){if(!items.hasOwnProperty(key)){continue}fn(items[key],key)}}}},{"./isList":52}],46:[function(require,module,exports){module.exports=function extend(target,extendWith){for(var key in extendWith){if(typeof target[key]!="undefined"){continue}target[key]=extendWith[key]}return target}},{}],47:[function(require,module,exports){var isArray=require("./isArray");module.exports=function find(items,fn){if(!items){return null}if(isArray(items)){for(var i=0;i<items.length;i++){if(fn(items[i],i)){return items[i]}}}else{for(var key in items){if(fn(items[key],key)){return items[key]}}}return null}},{"./isArray":51}],48:[function(require,module,exports){module.exports=function identity(x){return x}},{}],49:[function(require,module,exports){var slice=require("./slice");module.exports=function call(methodName){var curryArgs=slice(arguments,1);return function futureCall(obj){var fn=obj[methodName],args=curryArgs.concat(slice(arguments,1));return fn.apply(obj,args)}}},{"./slice":56}],50:[function(require,module,exports){module.exports=function isArguments(obj){return Object.prototype.toString.call(obj)=="[object Arguments]"}},{}],51:[function(require,module,exports){module.exports=function(){if(Array.isArray&&Array.isArray.toString().match("\\[native code\\]")){return function(obj){return Array.isArray(obj)}}else if(Array.prototype){return function(obj){return obj&&obj.slice==Array.prototype.slice}}else{return function(obj){return Object.prototype.toString.call(obj)=="[object Array]"}}}()},{}],52:[function(require,module,exports){var isArray=require("std/isArray");var isArguments=require("std/isArguments");var isNodeList=require("std/isNodeList");module.exports=function isList(item){return isArray(item)||isArguments(item)||isNodeList(item)}},{"std/isArguments":50,"std/isArray":51,"std/isNodeList":53}],53:[function(require,module,exports){module.exports=function(){if(typeof NodeList=="undefined"){return function isNodeList(){return false}}else{return function isNodeList(obj){return obj&&obj.item==NodeList.prototype.item}}}()},{}],54:[function(require,module,exports){var each=require("./each");var isList=require("./isList");var isArray=require("./isArray");module.exports=function map(obj,fn){if(!obj){return null}if(obj.map==Array.prototype.map){return obj.map(fn)}var result=isList(obj)?[]:{};each(obj,function(val,key){result[key]=fn(val,key)});return result}},{"./each":45,"./isArray":51,"./isList":52}],55:[function(require,module,exports){module.exports=function remove(arr,item){if(!arr){return}for(var i=0;i<arr.length;i++){if(arr[i]!=item){continue}arr.splice(i,1);return}}},{}],56:[function(require,module,exports){module.exports=function args(args,offset,length){if(typeof length=="undefined"){length=args.length}return Array.prototype.slice.call(args,offset||0,length)}},{}],57:[function(require,module,exports){var curry=require("./curry");var slice=require("./slice");var each=require("./each");var msTime=module.exports=timeWithBase(1);function inNanoseconds(){return timeWithBase(msTime.nanoseconds)}function inMicroseconds(){return timeWithBase(msTime.microseconds)}function inMilliseconds(){return timeWithBase(msTime.milliseconds)}function inSeconds(){return timeWithBase(msTime.seconds)}function inMinutes(){return timeWithBase(msTime.minutes)}function inHours(){return timeWithBase(msTime.hours)}function inDays(){return timeWithBase(msTime.days)}function inWeeks(){return timeWithBase(msTime.weeks)}function timeWithBase(base){var farFuture=now()+3e9;var distantPast=1;var time={base:base,now:now,ago:ago,ofDay12Hour:ofDay12Hour,ofDay24Hour:ofDay24Hour,inNanoseconds:inNanoseconds,inMicroseconds:inMicroseconds,inMilliseconds:inMilliseconds,inSeconds:inSeconds,inMinutes:inMinutes,inHours:inHours,inDays:inDays,inWeeks:inWeeks,getLocalTime:getLocalTime,getLocalTimeOfDay:getLocalTimeOfDay,getLocalDay:getLocalDay,getLocalHourOfDay:getLocalHourOfDay,untilLocalTimeOfDay:untilLocalTimeOfDay,farFuture:farFuture,distantFuture:farFuture,distantPast:distantPast,farPast:distantPast};function getLocalTime(utcTime,utcOffset){return utcTime+utcOffset*time.minutes}function getLocalTimeOfDay(utcTime,utcOffset){return getLocalTime(utcTime,utcOffset)%time.day}function getLocalDay(utcTime,utcOffset){return Math.floor(getLocalTime(utcTime,utcOffset)/time.day)}function getLocalHourOfDay(utcTime,utcOffset){return Math.floor(getLocalTime(utcTime,utcOffset)/time.hour)%24}function getLocalMinute(utcTime,utcOffset){return Math.floor(getLocalTime(utcTime,utcOffset)/time.minute)%60}function untilLocalTimeOfDay(utcTime,utcOffset,timeOfDay){var targetLocalTimeOfDay=timeOfDay%time.day;var difference=targetLocalTimeOfDay-getLocalTimeOfDay(utcTime,utcOffset);return difference<0?time.day+difference:difference}time.millisecond=time.milliseconds=1/base;time.second=time.seconds=1e3*time.millisecond;time.minute=time.minutes=60*time.second;time.hour=time.hours=60*time.minute;time.day=time.days=24*time.hour;time.week=time.weeks=7*time.day;time.microsecond=time.microseconds=time.millisecond/1e3;time.nanosecond=time.nanoseconds=time.microsecond/1e3;function now(_base){return Math.round((new Date).getTime()/(_base||base))}function ofDay24Hour(utcTime,utcOffset){return _pad(getLocalHourOfDay(utcTime,utcOffset)+1)+":"+_pad(getLocalMinute(utcTime,utcOffset))}function ofDay12Hour(utcTime,utcOffset){var localHour=getLocalHourOfDay(utcTime,utcOffset);var displayHour=localHour==12?12:localHour%12;var AM_PM=localHour<12?"am":"pm";return displayHour+":"+_pad(getLocalMinute(utcTime,utcOffset))+" "+AM_PM}function _pad(num){return num<10?"0"+num:num}function ago(ts,yieldFn){return ago.stepFunction(ts,yieldFn)}ago.stepFunction=_stepFunction(10*time.second,"just now",null,time.minute,"less than a minute ago",null,2*time.minute,"one minute ago",null,time.hour,"%N minutes ago",[time.minute],2*time.hour,"one hour ago",null,time.day,"%N hours ago",[time.hour],time.day*2,"one day ago",null,time.week,"%N days ago",[time.day],2*time.week,"1 week ago",[time.week],Infinity,"%N weeks ago",[time.week]);ago.precise=_stepFunction(time.minute,"%N seconds ago",[time.second],time.hour,"%N minutes, %N seconds ago",[time.minute,time.second],time.day,"%N hours, %N minutes ago",[time.hour,time.minute],time.week,"%N days, %N hours ago",[time.day,time.hour],Infinity,"%N weeks, %N days ago",[time.week,time.day]);ago.brief=_stepFunction(20*time.second,"now",null,time.minute,"1 min",null,time.hour,"%N min",[time.minute],2*time.hour,"1 hr",null,time.day,"%N hrs",[time.hour],time.day*2,"1 day",null,time.week,"%N days",[time.day],2*time.week,"1 week",null,30*time.day,"%N weeks",[time.week],60*time.day,"1 month",null,Infinity,"%N months",[time.day*30]);ago.days=_stepFunction(time.day,"Today",null,time.day*2,"Yesterday",null,time.week,"%N days ago",[time.day],time.week*2,"Last week",null,30*time.day,"%N weeks ago",[time.week],60*time.day,"Last month",null,365*time.day,"%N months ago",[time.day*30],365*time.day*2,"Last year",null,Infinity,"%N years ago",[time.day*365]);var MAX_TIMEOUT_VALUE=2147483647;function _stepFunction(){var steps=arguments;var stepFn=function(basedTimestamp,yieldFn){var timeAgo=now()-basedTimestamp;var millisecondsAgo=timeAgo*base;if(timeAgo<0){setTimeout(curry(stepFn,basedTimestamp,yieldFn),-millisecondsAgo+1);yieldFn&&yieldFn("future");return"future"}for(var i=0;i<steps.length;i+=3){if(timeAgo>steps[i]){continue}var result=_getStepResult(timeAgo,steps,i);if(yieldFn){yieldFn(result.payload);if(result.smallestGranularity){var timeoutIn=result.smallestGranularity-timeAgo%result.smallestGranularity;var timeoutInMs=Math.min(timeoutIn*base,MAX_TIMEOUT_VALUE);setTimeout(curry(stepFn,basedTimestamp,yieldFn),timeoutInMs)}}return result.payload}return _getStepResult(millisecondsAgo,steps,i-3).payload};return stepFn}function _getStepResult(timeAgo,steps,i){var stepSize=steps[i];var stepPayload=steps[i+1];var stepGranularities=steps[i+2];var smallestGranularity=stepSize;var untakenTime=timeAgo;each(stepGranularities,function(granularity){var granAmount=Math.floor(untakenTime/granularity);untakenTime-=granAmount*granularity;stepPayload=stepPayload.replace("%N",granAmount);if(granularity<smallestGranularity){smallestGranularity=granularity}});return{payload:stepPayload,smallestGranularity:smallestGranularity}}return time}},{"./curry":44,"./each":45,"./slice":56}],58:[function(require,module,exports){var identity=require("./identity");var each=require("./each");module.exports=function toArray(obj,fn){if(!fn){fn=identity}var result=[];each(obj,function(val,key){result.push(fn(val,key))});return result}},{"./each":45,"./identity":48}],59:[function(require,module,exports){var Class=require("./Class");var map=require("./map");var toArray=require("./toArray");var isArray=require("std/isArray");var URL=Class(function(){this._extractionRegex=new RegExp(["^","((\\w+:)?//)?","(\\w[\\w\\.\\-]+)?","(:\\d+)?","(\\/[^\\?#]+)?","(\\?[^#]+)?","(#.*)?"].join(""),"i");this.init=function(url){var match=(url||"").toString().match(this._extractionRegex)||[];this.protocol=match[2]||"";this.hostname=match[3]||"";this.port=(match[4]||"").substr(1);this.host=(this.hostname?this.hostname:"")+(this.port?":"+this.port:"");this.pathname=match[5]||"";this.search=(match[6]||"").substr(1);this.hash=(match[7]||"").substr(1)};this.setProtocol=function(protocol){this.protocol=protocol;return this};this.toString=function(){return[this.protocol+"//",this.host,this.pathname,this.getSearch(),this.getHash()].join("")};this.toJSON=this.toString;this.getTopLevelDomain=function(){if(!this.host){return""}var parts=this.host.split(".");return parts.slice(parts.length-2).join(".")};this.getSearchParams=function(){if(this._searchParams){return this._searchParams}return this._searchParams=url.query.parse(this.search)||{}};this.getHashParams=function(){if(this._hashParams){return this._hashParams}return this._hashParams=url.query.parse(this.hash)||{}};this.addToSearch=function(key,val){this.getSearchParams()[key]=val;return this};this.addToHash=function(key,val){this.getHashParams()[key]=val;return this};this.removeFromSearch=function(key){delete this.getSearchParams()[key];return this};this.removeFromHash=function(key){delete this.getHashParams()[key];return this};this.getSearch=function(){return this._searchParams?"?"+url.query.string(this._searchParams):this.search?"?"+this.search:""};this.getHash=function(){return this._hashParams?"#"+url.query.string(this._hashParams):this.hash?"?"+this.hash:""};this.getSearchParam=function(key){return this.getSearchParams()[key]};this.getHashParam=function(key){return this.getHashParams()[key]}});var url=module.exports=function url(url){return new URL(url)};url.parse=url;url.query={parse:function(paramString){var parts=paramString.split("&"),params={};for(var i=0;i<parts.length;i++){var kvp=parts[i].split("=");if(kvp.length!=2){continue}params[decodeURIComponent(kvp[0])]=decodeURIComponent(kvp[1])}return params},string:function(params){return toArray(params,function(val,key){return encodeURIComponent(key)+"="+url.query.encodeValue(val)}).join("&")},encodeValue:function(val){if(isArray(val)){return map(val,function(v){return encodeURIComponent(v)}).join(",")}else{return encodeURIComponent(val)}}}},{"./Class":42,"./map":54,"./toArray":58,"std/isArray":51}]},{},[6]);